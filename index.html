<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ENGLISH LEARNING PRO HUB - V35.1 (STABLE & FIXED)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* --- STYLE SYSTEM V35.1 FIXED --- */
:root {
    --bg-body: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --primary: #2c3e50; 
    --secondary: #34495e;
    --accent: #2980b9; 
    --accent-grad: linear-gradient(to right, #2980b9, #6dd5fa); 
    --card-bg: #ffffff; 
    --text-color: #2d3436; 
    --success: #27ae60;
    --error: #c0392b;
    --warn: #f1c40f; 
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
    --shadow-hover: 0 15px 40px rgba(0,0,0,0.15);
    --font-main: 'Poppins', sans-serif;
}

* { box-sizing: border-box; outline: none; }

body { 
    margin: 0; padding: 0; 
    background: var(--bg-body); 
    height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    font-family: var(--font-main); 
    color: var(--text-color); 
    overflow: hidden; 
}

.app-container { 
    display: flex; width: 96%; max-width: 1700px; height: 95vh; 
    background: var(--card-bg); border-radius: 30px; box-shadow: var(--shadow); 
    overflow: hidden; border: none; 
}

/* SIDEBAR */
.sidebar { 
    width: 260px; background: var(--primary); display: flex; flex-direction: column; 
    padding: 25px 20px; gap: 10px; color: #ecf0f1; flex-shrink: 0; z-index: 20; 
    overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar::-webkit-scrollbar { width: 5px; } 
.sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 5px; }

.sidebar h2 { 
    font-family: var(--font-main); text-align: center; color: #fff; 
    border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin: 0 0 10px 0; 
    font-size: 1.5rem; font-weight: 700; letter-spacing: 1px;
}

.quick-dict-box { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 12px; margin-bottom: 10px; flex-shrink: 0; }
.quick-dict-input { width: 100%; background: transparent; border: none; color: #fff; font-family: var(--font-main); font-size: 0.9rem; }
.quick-dict-input::placeholder { color: rgba(255,255,255,0.6); }

.nav-btn { 
    background: transparent; border: none; color: rgba(255,255,255,0.7); 
    font-family: var(--font-main); font-size: 0.95rem; font-weight: 500; 
    padding: 12px 15px; border-radius: 12px; cursor: pointer; text-align: left; 
    transition: all 0.3s; display: flex; align-items: center; gap: 12px; flex-shrink: 0; 
}
.nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.15); color: #fff; transform: translateX(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: 600; }
.nav-btn[onclick="exportData()"] { background: var(--success) !important; border-radius: 50px; justify-content: center; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); margin-top: 15px; font-weight: bold;}
.admin-btn { margin-top: 5px; background: rgba(231, 76, 60, 0.2); color: #e74c3c; border-radius: 20px; justify-content: center; }
.admin-btn:hover { background: rgba(231, 76, 60, 0.4); color: white; }
.spacer { flex-grow: 1; min-height: 10px; }

/* WORKBOOK AREA */
.workbook-area { flex: 1; position: relative; background: #f4f6f8; display: flex; flex-direction: column; overflow: hidden; }

.library-header { padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.03); z-index: 5; }
.main-search-input { width: 100%; max-width: 600px; padding: 12px 20px; border-radius: 12px; border: 1px solid #dfe6e9; font-family: var(--font-main); font-size: 1rem; outline: none; background: #fff; color: var(--text-color); transition: 0.3s; }
.main-search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1); }

.library-grid { flex: 1; overflow-y: auto; padding: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; align-content: start; }
.library-grid.list-mode { display: flex; flex-direction: column; gap: 10px; }

.book-card { background: #fff; border-radius: 15px; padding: 20px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #f1f2f6; border-left: 5px solid var(--accent); height: 120px; display: flex; flex-direction: column; justify-content: center; position: relative; transition: transform 0.2s, box-shadow 0.2s; }
.book-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
.book-card.completed { border-left-color: var(--success) !important; background-color: #f0fdf4; }
.book-card.completed::after { content: '‚úî'; position: absolute; top: 10px; right: 10px; color: var(--success); font-size: 1.2em; font-weight: bold; background: rgba(39, 174, 96, 0.1); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;}
.book-title { font-family: var(--font-main); font-weight: 600; color: var(--text-color); font-size: 1rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.folder-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-left: 5px solid #3498db !important; align-items: center; text-align: center; }
.folder-icon { font-size: 2rem; margin-bottom: 5px;}
.folder-count { font-size: 0.8rem; color: #666; }
.new-item-card { border-left: none !important; border: 2px dashed #bdc3c7; background: transparent; color: #95a5a6; font-weight: 600; box-shadow: none; align-items: center; }
.new-item-card:hover { border-color: var(--accent); color: var(--accent); background: rgba(41, 128, 185, 0.05); }
.delete-btn { position: absolute; bottom: 10px; right: 10px; background:none; border:none; color: #fab1a0; cursor:pointer; opacity:0; font-size:1.2em; transition: 0.2s; }
.book-card:hover .delete-btn { opacity: 1; }
.delete-btn:hover { color:var(--error); transform: scale(1.2); }
.search-result-item { background: white; padding: 15px 20px; border-radius: 12px; border: 1px solid #eee; display: flex; justify-content: space-between; font-family: var(--font-main); align-items: center; }
.search-result-item strong { color: var(--accent); font-size: 1.1rem; }

/* ANALYTICS */
.analytics-view { display: none; padding: 40px; overflow-y: auto; height: 100%; background-color: #f8f9fa !important; font-family: var(--font-main); }
.analytics-header { text-align: center; margin-bottom: 30px; }
.analytics-header h2 { color: var(--primary); font-size: 2.2rem; margin: 0; font-weight: 700; letter-spacing: -1px; }
.level-dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
.total-score-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; padding: 30px; position: relative; overflow: hidden; box-shadow: 0 15px 30px rgba(118, 75, 162, 0.4); display: flex; flex-direction: column; justify-content: center; }
.total-score-card::after { content: 'üèÜ'; position: absolute; right: -20px; bottom: -30px; font-size: 180px; opacity: 0.15; transform: rotate(-15deg); }
.level-label { font-size: 1.1rem; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
.total-points { font-size: 5rem; font-weight: 800; line-height: 1; margin: 15px 0; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.level-progress-container { margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px; }
.level-bar-bg { width: 100%; height: 12px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; }
.level-bar-fill { height: 100%; background: #f1c40f; width: 0%; transition: width 1s ease-in-out; border-radius: 10px; }
.level-text { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.95rem; font-weight: 600; }
.daily-score-card { background: white; border-radius: 20px; padding: 25px; border: 1px solid #f1f2f6; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
.daily-title { color: #7f8c8d; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
.daily-val { font-size: 3.5rem; font-weight: 700; color: var(--success); }
.daily-time { font-size: 0.9rem; color: #95a5a6; margin-top: 10px; background: #f8f9fa; padding: 5px 15px; border-radius: 20px; }
.score-rules-toggle { border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s;}
.score-rules-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
.score-rules-box { display: none; background: white; margin-top: 20px; border-radius: 15px; padding: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); animation: slideDown 0.3s ease-out; margin-bottom: 30px; border: 1px solid #eee; }
.rules-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
.rules-table th { text-align: left; color: var(--primary); padding: 12px; border-bottom: 2px solid #f1f2f6; }
.rules-table td { padding: 12px; border-bottom: 1px solid #f1f2f6; color: #636e72; }
.rule-icon { margin-right: 10px; font-size: 1.2em; }
.weekly-score-container { display: flex; gap: 15px; margin-bottom: 30px; justify-content: space-between; height: 120px; align-items: flex-end;}
.weekly-day-box { flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 15px 10px; text-align: center; color: white; box-shadow: 0 5px 15px rgba(118, 75, 162, 0.2); transition: transform 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; height: 100%;}
.weekly-day-box:hover { transform: translateY(-5px); }
.weekly-day-box.today { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); box-shadow: 0 10px 20px rgba(0,0,0,0.15); border: 3px solid white; transform: scale(1.05); z-index: 2; }
.w-day-name { font-size: 0.85rem; font-weight: 500; margin-bottom: 5px; opacity: 0.9; text-transform: uppercase; }
.w-day-score { font-size: 1.6rem; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
.stat-card { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; border: none; border-bottom: 4px solid #eee; transition: transform 0.2s; }
.stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
.stat-number { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin: 5px 0; }
.stat-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;}
.monthly-chart-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #f1f2f6; }
.chart-bars { display: flex; align-items: flex-end; gap: 5px; height: 120px; margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid #dfe6e9; }
.chart-bar { flex: 1; background: var(--accent); border-radius: 5px 5px 0 0; position: relative; transition: height 0.5s ease; opacity: 0.7; }
.chart-bar:hover { opacity: 1; background: var(--primary); }
.chart-bar:hover::after { content: attr(data-date) ' : ' attr(data-score); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #2d3436; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; white-space: nowrap; z-index: 10; pointer-events: none; }
.accordion-box { border: 1px solid #eee; border-radius: 15px; overflow: hidden; margin-bottom: 20px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.02); }
.accordion-header { background: #f8f9fa; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--primary); transition: 0.2s; user-select: none; font-size: 1rem; }
.accordion-header:hover { background: #ecf0f1; }
.accordion-content { display: none; padding: 0; border-top: 1px solid #eee; }
.accordion-content.open { display: block; animation: slideDown 0.3s ease-out; }
.activity-item { padding: 15px 25px; border-bottom: 1px solid #f1f2f6; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; color: #2d3436; }
.log-point-badge { background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; margin-left: 10px; }
.vocab-stats-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 0.9rem; background:#fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-radius: 15px; overflow: hidden; border: 1px solid #eee;}
.vocab-stats-table th { background: #f8f9fa; color: var(--primary); padding: 15px; font-weight: 700; text-transform:uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #eee; }
.vocab-stats-table td { padding: 15px; text-align: center; border-bottom: 1px solid #f1f2f6; color: #636e72; }
.progress-track { width: 100%; background: #dfe6e9; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
.progress-fill-know { height: 100%; background: var(--success); border-radius: 4px; }
.section-title { font-size:1.3rem; color:var(--primary); font-weight: 700; margin:30px 0 15px 0; border-left: 5px solid var(--accent); padding-left: 15px; }
.analytics-grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }

/* WORD MASTER (D√úZELTƒ∞LDƒ∞: E≈ûƒ∞T Y√úKSEKLƒ∞K VE KART YAPISI) */
.wm-setup-title { text-align:center; color:var(--primary); margin-bottom:25px; font-weight:700; font-size: 1.3rem; position: relative; display: inline-block; left: 50%; transform: translateX(-50%); border-bottom: 3px solid var(--accent); padding-bottom: 10px;}
.wm-setup-card { background:white; border-radius:20px; padding:30px; border:1px solid #f1f2f6; box-shadow:0 10px 30px rgba(0,0,0,0.05); height:100%; display:flex; flex-direction:column; justify-content:flex-start; }
.wm-type-btn { display:flex; width:100%; padding:20px; margin-bottom:15px; background:#f8f9fa; border:2px solid #dfe6e9; border-radius:15px; font-family:var(--font-main); font-weight:700; font-size:1.1rem; color:var(--text-color); cursor:pointer; transition:0.2s; align-items:center; gap:15px; }
.wm-type-btn:hover { border-color:var(--accent); background:white; transform: translateX(5px); box-shadow:0 5px 15px rgba(0,0,0,0.05); }
.wm-type-btn.selected { border-color:var(--accent); background:var(--accent); color:#fff; box-shadow: 0 10px 20px rgba(41, 128, 185, 0.3); }
.wm-level-grid { display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; } /* 3'l√º yerine 2'li daha dengeli */
.wm-level-btn { padding:20px; border:none; background:#f1f2f6; border-radius:15px; font-family:var(--font-main); font-weight:800; font-size:1.2rem; color:var(--primary); cursor:pointer; transition:0.2s; }
.wm-level-btn:hover { background:var(--accent); color:white; transform:scale(1.05); box-shadow: 0 10px 20px rgba(41, 128, 185, 0.3); }
.wm-mode-toggle { display:flex; gap:10px; margin-bottom:30px; background:#f1f2f6; padding:8px; border-radius:50px; }
.wm-mode-opt { flex:1; text-align:center; padding:12px; border-radius:50px; cursor:pointer; font-weight:700; transition:0.2s; color: #95a5a6; }
.wm-mode-opt.active { background:white; color:var(--accent); box-shadow:0 4px 15px rgba(0,0,0,0.1); }

/* FLASHCARD */
.wm-card-container { width: 700px; max-width: 95%; height: 400px; perspective: 1500px; cursor: pointer; margin: 0 auto 40px auto; }
.wm-flip-inner { position:relative; width:100%; height:100%; transition:transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); transform-style:preserve-3d; transform-origin: center center; }
.wm-card-front, .wm-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); font-weight: 800; font-size: 3.5rem; text-align: center; padding: 30px; transition: transform 0.6s, z-index 0s 0.3s; }
.wm-card-front { background: linear-gradient(135deg, #ffffff 0%, #f1f2f6 100%); color: var(--primary); z-index: 2; transform: rotateY(0deg); pointer-events: auto; border: 1px solid #dfe6e9; }
.wm-card-back { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: #f1c40f; transform: rotateY(180deg); z-index: 1; pointer-events: none; font-size: 2.8rem; }
.wm-flipped .wm-flip-inner { transform:rotateY(180deg); }
.wm-flipped .wm-card-front { pointer-events: none; z-index: 1; }
.wm-flipped .wm-card-back { pointer-events: auto; z-index: 2; }
.card-action-wrapper { margin-top: auto; display: flex; gap: 20px; }
.card-tool-btn { font-size: 1rem; padding: 10px 20px; border-radius: 30px; background: rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; color: #636e72; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; }
.card-tool-btn:hover { background: var(--accent); color: white; transform: scale(1.1); }
.wm-controls { display:flex; gap:30px; justify-content:center; margin-top:20px; width:100%; max-width:650px; }
.wm-btn { flex:1; padding:20px; border-radius:20px; border:none; color:white; font-family:var(--font-main); font-weight:800; font-size:1.2rem; cursor:pointer; transition:transform 0.2s; box-shadow:0 10px 20px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center; gap:10px; }
.wm-btn:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(0,0,0,0.15); }
.wm-btn-know { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
.wm-btn-unknow { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
.wm-count-display { font-size:1.1rem; color:#95a5a6; font-weight:600; margin-bottom:15px; letter-spacing: 1px;}

/* OPEN BOOK VIEW */
.open-book-view { display: none; width: 100%; height: 100%; flex-direction: column; background: #fff; }
.book-top-bar { height: 70px; background: #fff; border-bottom: 1px solid #f1f2f6; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; flex-shrink: 0; }
.back-btn { border: 1px solid #dfe6e9; background: #fff; color: #636e72; padding: 10px 25px; border-radius: 30px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: 0.2s; font-family: var(--font-main); display: flex; align-items: center; gap: 5px; }
.back-btn:hover { background: #f1f2f6; color: var(--primary); }
.live-stats-bar { display:none; gap:20px; font-size:0.95rem; color:#636e72; font-family: var(--font-main); background:#f8f9fa; padding:8px 20px; border-radius:30px; border: 1px solid #eee; }
.stat-pill strong { color:var(--accent); font-size: 1.1rem; }
.notebook-tools { display:none; align-items:center; gap:10px; margin-left:20px; padding-left:20px; border-left:1px solid #eee; }
.tool-select { padding:5px 10px; border-radius:12px; border:1px solid #dfe6e9; font-size:0.85rem; background:#fff; color:var(--text-color); margin-right:5px; cursor:pointer; font-family: var(--font-main); }

/* --- TEK SAYFA / TAM EKRAN OKUMA MODU (V36.0 FINAL) --- */
.book-spread { 
    flex: 1; 
    display: block;          /* Block yapƒ±sƒ± ile yukarƒ±dan a≈üaƒüƒ± akƒ±≈ü */
    overflow-y: auto;        /* Dikey scroll burada √ßalƒ±≈üacak */
    background: #f0f2f5; 
    height: 100%; 
    padding: 10px;
    position: relative;
}

.single-page { 
    background: #fff;
    width: 100%;             
    max-width: 1200px;       /* Geni≈ü ekranlar i√ßin ideal okuma alanƒ± */
    min-height: auto;        /* Sabit y√ºkseklik yok, i√ßeriƒüe g√∂re uzasƒ±n */
    height: auto;            /* Otomatik y√ºkseklik */
    margin: 0 auto 100px auto; /* Alt tarafta bo≈üluk bƒ±rak (Men√ºler i√ßin) */
    padding: 40px 50px;     
    border-radius: 15px;    
    box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
    font-size: 1.25rem;      
    line-height: 1.8;        
    color: #2d3436; 
    text-align: left; 
    border: 1px solid #e1e1e1;
    display: block !important;
}
/* Saƒü sayfayƒ± CSS ile de gizleyelim */
#pageRight { display: none !important; }

/* Mobil Uyumluluk */
@media (max-width: 768px) {
    .single-page {
        padding: 30px 20px;
        font-size: 1.1rem;
        max-width: 100%;
    }
}
/* GRAMER VE METƒ∞N ƒ∞√áERƒ∞K D√úZENLEYƒ∞Cƒ∞LERƒ∞ */
.single-page h1, .single-page h2, .single-page h3, .single-page h4 {
    color: var(--primary);
    margin: 25px 0 15px 0;
    font-weight: 700;
    display: block;      /* Satƒ±rƒ± kaplamaya zorla */
    width: 100%;         /* Tam geni≈ülik */
    border-bottom: 2px solid #f1f2f6; /* Altƒ±na √ßizgi √ßekerek ayƒ±r */
    padding-bottom: 5px;
    line-height: 1.4;
}

.single-page p {
    margin-bottom: 15px;
    display: block; 
    width: 100%;
}

.single-page ul, .single-page ol {
    margin-bottom: 20px;
    padding-left: 25px;
    display: block;
}

.single-page li {
    margin-bottom: 8px;
}

/* TABLO G√ñR√úN√úM√úN√ú D√úZELTME */
/* Gramer konularƒ± genelde tablo olur, bu kod tablolarƒ± g√ºzelle≈ütirir */
.single-page table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1rem;
    background: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    display: table !important; /* Tablo yapƒ±sƒ±nƒ± koru */
}
.single-page th { background: var(--primary); color: white; padding: 12px; text-align: left; border: 1px solid #34495e; }
.single-page td { border: 1px solid #dfe6e9; padding: 10px; color: #444; vertical-align: top; }
.single-page tr:nth-child(even) { background-color: #f1f2f6; }
/* --- D√úZELTME: AKILLI G√ñR√úN√úM Y√ñNETƒ∞Mƒ∞ V2 --- */
#pageRight { display: none; }

/* Word Master Kurulum Modu (√áift S√ºtun D√úZELTME) */
.split-mode { 
    display: flex !important;
    flex-direction: row !important;
    align-items: stretch !important; /* Y√ºkseklikleri e≈üitle */
    justify-content: center; /* Ortala */
    gap: 30px; 
    width: 100%;
    padding: 20px;
    max-width: 1200px; /* √áok geni≈ü ekranda daƒüƒ±lmasƒ±n */
    margin: 0 auto;
}

.split-mode #pageLeft, 
.split-mode #pageRight { 
    display: flex !important;
    flex: 1; 
    width: 45%; 
    background: transparent !important; /* Arka planƒ± ≈üeffaf yap, i√ßindeki kart g√∂r√ºnecek */
    box-shadow: none !important;
    padding: 0 !important; /* ƒ∞√ß dolguyu sƒ±fƒ±rla */
    min-height: 500px; 
    margin: 0;
    flex-direction: column;
}

/* Mobilde Alt Alta */
@media (max-width: 900px) {
    .split-mode { flex-direction: column !important; height: auto; }
    .split-mode #pageLeft, .split-mode #pageRight { width: 100%; margin-bottom: 20px; min-height: auto; }
}

/* Metinlerin g√∂r√ºn√ºrl√ºƒü√ºn√º garantiye al */
.content-text p, .content-text div, .single-page p {
    color: #2d3436 !important;
    opacity: 1 !important;
    visibility: visible !important;
}

/* Kelime Stilleri */
.interactive-word { cursor: pointer; border-bottom: 2px solid rgba(41, 128, 185, 0.15); transition: all 0.2s; border-radius: 4px; padding: 0 3px;}
.interactive-word:hover { background-color: #fff3cd; color: #d35400; border-bottom-color: #d35400; transform: scale(1.1); display:inline-block; }
.interactive-word.saved { color: #c0392b; font-weight: 700; border-bottom: 2px solid #c0392b; background-color: rgba(192, 57, 43, 0.05); }
#wordTooltip { position: fixed; background: var(--primary); color: #fff; padding: 12px 25px; border-radius: 12px; font-family: var(--font-main); font-size: 1rem; pointer-events: none; font-weight: 600; z-index: 3000; display: none; box-shadow: 0 15px 40px rgba(0,0,0,0.25); max-width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.2); }

/* Navigasyon Oklarƒ± */
.nav-arrow { 
    position: fixed; top: 50%; transform: translateY(-50%); 
    width: 70px; height: 70px;
    display: flex; align-items: center; justify-content: center; 
    font-size: 2.5rem; color: var(--primary); 
    cursor: pointer; z-index: 2000; transition: 0.2s; 
    background: white; border-radius: 50%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.nav-arrow:hover { background: var(--accent); color: white; transform: translateY(-50%) scale(1.1); box-shadow: 0 15px 40px rgba(41, 128, 185, 0.4); }
.nav-arrow.prev { left: 30px; } 
.nav-arrow.next { right: 30px; }

/* Sayfa Numarasƒ± */
.page-num { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #b2bec3; font-size: 1rem; font-weight: 700; letter-spacing: 2px; }
.page-num.right { display: none; }

/* Mobil Uyumluluk */
@media (max-width: 900px) {
    .book-spread { padding: 15px; align-items: flex-start; overflow-y: auto;}
    .single-page { padding: 30px 20px; font-size: 1.2rem; min-height: 60vh; border-radius: 20px; margin-top: 20px; }
    .nav-arrow { width: 50px; height: 50px; font-size: 1.5rem; background: rgba(255,255,255,0.9); bottom: 20px; top: auto; transform: none; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .nav-arrow.prev { left: 20px; } 
    .nav-arrow.next { right: 20px; }
    .page-num { bottom: 35px; }
}

/* QUIZ STYLES */
.quiz-centered-container { width: 100%; height: 100%; margin: 0; display: flex; flex-direction: column; padding: 5px 0; box-sizing: border-box; }
.quiz-question-card { width: 100%; flex: 1; background: #fff; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 1px solid #f1f2f6; display: flex; flex-direction: column; overflow-y: auto; }
.quiz-progress-bar { width: 100%; height: 6px; background: #f1f2f6; border-radius: 10px; margin-bottom: 25px; overflow: hidden; }
.quiz-progress-fill { height: 100%; background: var(--accent-grad); transition: width 0.3s ease; }
.quiz-q-text { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 30px; line-height: 1.5; }
.quiz-opt { padding: 20px 30px; margin: 15px 0; border: 2px solid #f1f2f6; border-radius: 15px; cursor: pointer; background: #fff; text-align: left; font-family: var(--font-main); font-size: 1.1rem; transition: 0.2s; color: var(--text-color); font-weight: 500; }
.quiz-opt:hover { border-color: #bdc3c7; transform: translateX(5px); background: #f8f9fa; }
.quiz-opt.selected { background: #ebf5fb; color: var(--accent); border-color: var(--accent); font-weight: 700; }
.quiz-next-btn { margin-top: 30px; padding: 18px 50px; background: var(--primary); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 20px rgba(44, 62, 80, 0.2); width: 100%; justify-content: center; }
.quiz-next-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(44, 62, 80, 0.3); background: var(--secondary); }
.quiz-final-wrapper { width: 100%; min-height: 100%; display: flex; flex-direction: column; position: relative; background: #fff; }
.quiz-sticky-header { position: sticky; top: 0; z-index: 1000; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-bottom: 1px solid #e0e0e0; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px 40px; width: 100%; display: flex; justify-content: space-between; align-items: center; }
.result-circle-score { width: 70px; height: 70px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.4rem; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
.quiz-detail-content { padding: 40px; max-width: 900px; margin: 0 auto; width: 100%; }
.review-item { padding: 20px; margin-bottom: 15px; border-radius: 15px; background: #f8f9fa; border: 1px solid #f1f2f6; }
.review-item.correct { border-left: 5px solid var(--success); background: #f0fdf4; }
.review-item.wrong { border-left: 5px solid var(--error); background: #fff5f5; }

/* MODALS & ADMIN PANEL STYLE V3 (MOBILE RESPONSIVE) */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.85); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; }
.modal { background: #fff; width: 850px; max-width: 95vw; max-height: 90vh; padding: 40px; border-radius: 30px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); overflow-y: auto; }
.modal::-webkit-scrollbar { width: 0; } 

.admin-grid-top { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
.admin-box { padding: 25px; border-radius: 20px; border: 1px solid transparent; display: flex; flex-direction: column; gap: 15px; }
.box-backup { background: #f8f9fa; border-color: #dfe6e9; }
.box-danger { background: #fff5f5; border-color: #fab1a0; }
.admin-box-title { font-weight: 700; color: var(--primary); font-size: 1.1rem; display:flex; align-items:center; gap:10px; }

.backup-actions { display: flex; gap: 10px; flex-wrap: wrap; }
.backup-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: var(--font-main); transition: 0.2s; font-size: 0.9rem; min-width: 120px; }
.dl-btn { background: var(--accent); } .dl-btn:hover { background: var(--secondary); }
.ul-btn { background: #f39c12; } .ul-btn:hover { background: #d35400; }
.danger-btn { background: white; border: 1px solid var(--error); color: var(--error); } 
.danger-btn:hover { background: var(--error); color: white; }

.input-area-wrapper { background: #fff; border-top: 2px solid #f1f2f6; padding-top: 25px; }
.admin-input-row { display: flex; gap: 15px; margin-bottom: 15px; }
.admin-select { flex: 1; padding: 15px; border: 2px solid #dfe6e9; border-radius: 15px; font-family: var(--font-main); font-weight: 600; color: var(--primary); outline: none; transition: 0.3s; background-image: none;}
.admin-select:focus { border-color: var(--accent); }
.admin-textarea { width: 100%; height: 200px; padding: 20px; border: 2px dashed #b2bec3; border-radius: 20px; font-family: 'Courier New', monospace; font-size: 0.95rem; color: var(--primary); resize: vertical; outline: none; background: #fdfdfd; transition:0.3s; }
.admin-textarea:focus { border-color: var(--accent); background: #fff; }
.save-btn-large { width: 100%; padding: 18px; background: var(--success); color: white; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); transition: 0.2s; letter-spacing: 1px;}
.save-btn-large:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(39, 174, 96, 0.4); }

.toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 15px 40px; border-radius: 50px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); z-index: 2000; display: none; font-weight: 600; font-family: var(--font-main); animation: slideUp 0.4s ease; }
.toast.error { background: var(--error); }
@keyframes slideUp { from { bottom: 0; opacity: 0; } to { bottom: 40px; opacity: 1; } }

/* --- ADMIN MOBILE RESPONSIVE --- */
@media (max-width: 900px) {
    .modal { padding: 20px; width: 95%; max-height: 95vh; border-radius: 20px; }
    .admin-grid-top { grid-template-columns: 1fr; gap: 15px; } /* Kutularƒ± Alt Alta Al */
    .admin-input-row { flex-direction: column; gap: 10px; } /* Se√ßim ve sil butonunu alt alta al */
    .backup-actions { flex-direction: column; } /* Butonlarƒ± alt alta sƒ±rala */
    .backup-btn { width: 100%; padding: 15px; font-size: 1rem; } /* Butonlarƒ± b√ºy√ºt */
    .admin-select { width: 100%; }
    .admin-textarea { height: 150px; }
    .save-btn-large { padding: 15px; font-size: 1rem; }
}
/* NOTEBOOK & EXTRAS */
.notebook-wrapper { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }
.notebook-paper { width: 100%; flex: 1; border: none; outline: none; resize: none; background: transparent; font-family: 'Courier New', Courier, monospace; color: var(--primary); background-image: linear-gradient(#f1f2f6 1px, transparent 1px); background-size: 100% 40px; line-height: 40px; padding-top: 5px; font-size: 1.2rem; }
.mic-controls { position: absolute; top: -50px; right: 0; display: flex; gap: 10px; z-index: 10; }
.mic-btn { background: #fff; border: 1px solid #dfe6e9; padding: 6px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; color: #636e72; display: flex; align-items: center; gap: 5px; font-family: var(--font-main); font-weight: 600; transition:0.2s; }
.mic-btn:hover { background: #f1f2f6; }
.mic-btn.listening { background: #ffebee; color: var(--error); border-color: var(--error); animation: pulse 1.5s infinite; }
.hint-btn { background: #fff; border: 1px solid #f39c12; color: #f39c12; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-family: var(--font-main); font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition:0.2s; margin-top: 5px; }
.hint-btn:hover { background: #f39c12; color: white; }
.hint-text-box { margin-top: 10px; background: #fff3cd; padding: 10px 15px; border-radius: 12px; color: #856404; font-size: 0.9rem; font-weight: 500; display: none; animation: slideDown 0.2s ease-out; border: 1px solid #ffeeba; }
/* --- KELƒ∞ME & FAVORƒ∞ Lƒ∞STESƒ∞ D√úZENƒ∞ (ORTALI) --- */
.vocab-layout { 
    display: grid; 
    /* S√ºtunlarƒ± i√ßeriƒüe g√∂re otomatik ayarla ve ortala */
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 20px; 
    width: 100%; 
    padding: 10px;
    justify-content: center; /* Grid √∂ƒüelerini ortala */
    align-content: start;
}

.vocab-item { 
    background: #fff; 
    border: 1px solid #f1f2f6; 
    border-radius: 12px; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    text-align: center; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.03); 
    transition: 0.2s; 
    margin: 0 auto; /* Kartƒ± kendi h√ºcresinde ortala */
    width: 100%;    /* H√ºcreyi doldur */
}
/* Liste modu (alt alta) i√ßin ortalama */
.vocab-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: var(--accent); }
.vocab-en { font-weight: 700; color: var(--accent); font-size: 1.1rem; margin-bottom: 5px; display: flex; justify-content: center; align-items: center; gap: 8px;} 
.vocab-tr { font-style: italic; color: #636e72; font-size: 1rem; }
 .unknown-list-item { 
    font-size: 1.1rem; 
    padding: 15px 20px; 
    border-bottom: 1px solid #f1f2f6; 
    color: #555; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; /* ƒ∞ki uca yasla */
    background: white;
    border-radius: 10px;
    margin-bottom: 10px;
}
.unknown-list-item strong { color: var(--primary); font-weight: 700; margin-right: 10px; font-size: 1.2rem; }
.tts-small { cursor: pointer; font-size: 1.1em; color: #f39c12; transition: 0.2s; padding: 2px; border-radius: 50%; }
.tts-small:hover { background: rgba(243, 156, 18, 0.1); transform: scale(1.2); }
.fav-btn { cursor:pointer; font-size:1.1em; color:#bdc3c7; transition:0.2s; padding:2px; margin-left:8px; }
.fav-btn.active { color:var(--warn); text-shadow:0 0 5px rgba(241, 196, 15, 0.5); transform:scale(1.1); }
.fav-btn:hover { color:var(--warn); }
.tts-controls-group { display: none; gap: 5px; background: #f1f2f6; padding: 3px; border-radius: 20px; align-items: center; }
.tts-ctrl-btn { border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: 0.2s; font-family: var(--font-main); }
.btn-restart { background: #e67e22; color: white; }
.btn-pause { background: #34495e; color: white; min-width: 40px;}
.btn-pause.paused { background: #27ae60; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* RESPONSIVE */
/* --- MOBƒ∞L UYUMLU Fƒ∞NAL AYARLARI (V35.0 FIX) --- */

/* 1. Tablet ve K√º√ß√ºk Ekran Ayarlarƒ± */
@media (max-width: 1200px) {
    .wm-card-container { width: 500px; height: 300px; }
    .wm-card-front, .wm-card-back { font-size: 2.5rem; }
}

/* 2. Mobil Ayarlarƒ± (TELEFONLAR ƒ∞√áƒ∞N) */
@media (max-width: 900px) {
    /* Sayfa Kilidini A√ßma (En √ñnemli Kƒ±sƒ±m) */
    body {
        height: auto !important;
        overflow-y: auto !important;
        overflow-x: hidden;
        position: relative;
    }

    /* Ana Kutuyu Esnek Yap */
    .app-container {
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        width: 100%;
        border-radius: 0;
        overflow: visible;
        box-shadow: none;
    }

    /* Yan Men√ºy√º (Sidebar) Yatay Yap */
    .sidebar {
        width: 100%;
        height: auto;
        padding: 10px;
        overflow-x: auto;
        white-space: nowrap;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: flex-start;
        gap: 10px;
        flex-shrink: 0;
    }
   .sidebar h2 { display: none; }
    .nav-btn { font-size: 0.85rem; padding: 8px 12px; flex-shrink: 0; }
    .quick-dict-box { min-width: 180px; }

    /* √áalƒ±≈üma Alanƒ±nƒ± Rahatlat */
    .workbook-area {
        height: auto;
        min-height: calc(100vh - 70px);
        overflow: visible;
    }

    /* Kitap G√∂r√ºn√ºm√º */
    .book-spread { flex-direction: column; overflow-y: visible; height: auto; }
    .single-page { 
        height: auto; 
        border-bottom: 1px solid #eee; 
        padding: 20px; 
        overflow: visible; 
        font-size: 1.1rem; 
    }
    #pageRight { display: block; border-left: none; }
    .spine-shadow { display: none; }

    /* Oyun ve Kartlar */
    .wm-card-container { width: 95%; height: 280px; margin-bottom: 20px; }
    .wm-card-front, .wm-card-back { font-size: 1.8rem; padding: 10px; }
    .vocab-layout { grid-template-columns: 1fr; }
    .quiz-sticky-header { flex-direction: column; gap: 10px; position: relative; }

    /* Yeni Dashboard (Kutucuklar) Mobil Ayarƒ± */
    .dash-wrapper { flex-direction: column; height: auto; gap: 20px; padding-bottom: 30px; }
    .dash-stat-box { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; padding: 20px; }
    .dash-stat-value { font-size: 1.8rem; margin: 0; }
    .dash-center-card { width: 100%; height: auto; padding: 30px; }

    /* Admin Paneli (Veri Y√ºkleme) Mobil Ayarƒ± */
    .modal { 
        width: 100%; 
        height: 100%; 
        max-height: 100vh; 
        border-radius: 0; 
        padding: 15px; 
        overflow-y: auto !important; 
    }
    .admin-grid-top { grid-template-columns: 1fr; gap: 15px; }
    .admin-input-row { flex-direction: column; gap: 10px; }
    .backup-actions { flex-direction: column; }
    .backup-btn { width: 100%; padding: 12px; }
    .admin-textarea { height: 150px; }
    .save-btn-large { padding: 15px; font-size: 1rem; }
}

/* Scrollbar Tasarƒ±mƒ± (PC ƒ∞√ßin) */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f2f6; }
::-webkit-scrollbar-thumb { background: #b2bec3; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #636e72; }

/* Mobilde Scrollbar'ƒ± Gizle (Daha Temiz G√∂r√ºn√ºm) */
@media (max-width: 900px) {
    ::-webkit-scrollbar { width: 0px; background: transparent; }
}
/* --- LEVEL DASHBOARD STYLES (NEW) --- */
.dash-wrapper {
    display: flex; justify-content: center; align-items: center; gap: 40px;
    height: 80%; width: 100%; padding: 20px; font-family: var(--font-main);
}
.dash-stat-box {
    background: white; border: 1px solid #dfe6e9; border-radius: 20px;
    padding: 30px; text-align: center; cursor: pointer; transition: 0.3s;
    width: 200px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); display:flex; flex-direction:column; justify-content:center;
}
.dash-stat-box:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: var(--accent); }
.dash-stat-title { font-size: 1.1rem; color: #7f8c8d; font-weight: 600; margin-bottom: 10px; }
.dash-stat-value { font-size: 2.5rem; color: var(--primary); font-weight: 800; }
.dash-stat-sub { font-size: 0.9rem; color: var(--success); font-weight: 700; margin-top: 5px; }

.dash-center-card {
    width: 500px; height: 350px; background: white; border-radius: 40px;
    border: 4px solid var(--primary); display: flex; flex-direction: column;
    justify-content: center; align-items: center; text-align: center;
    cursor: pointer; transition: 0.4s; box-shadow: 0 20px 50px rgba(0,0,0,0.1);
    position: relative; overflow: hidden; padding: 40px;
}
.dash-center-card:hover {
    transform: scale(1.02); background: var(--primary); border-color: var(--primary);
}
.dash-center-card:hover h1, .dash-center-card:hover p { color: white !important; }
.dash-center-label { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; color: #95a5a6; margin-bottom: 15px; font-weight: 700;}
.dash-center-title { font-size: 2.2rem; color: var(--primary); font-weight: 800; line-height: 1.3; }
.dash-center-action { margin-top: 25px; padding: 10px 30px; background: var(--accent); color: white; border-radius: 50px; font-weight: 600; }
.dash-center-card:hover .dash-center-action { background: white; color: var(--primary); }

/* Liste Modalƒ± i√ßin */
.dash-list-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;}
.dash-list-content { background:white; width:500px; max-height:80vh; border-radius:20px; padding:30px; overflow-y:auto; position:relative; }
.dash-list-item { padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.dash-list-item:hover { background:#f9f9f9; }
.dash-list-item.done { color:var(--success); text-decoration:line-through; }
/* --- LOGIN SYSTEM STYLES --- */
.login-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
    z-index: 9999; display: none; /* BA≈ûLANGI√áTA Gƒ∞ZLƒ∞ */ justify-content: center; align-items: center;
}
.login-card {
    background: white; width: 400px; padding: 40px; border-radius: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center;
    font-family: var(--font-main);
}
.login-title { font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; }
.login-input {
    width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #eee;
    border-radius: 10px; font-size: 1rem; outline: none; transition: 0.3s;
}
.login-input:focus { border-color: var(--accent); }
.login-btn {
    width: 100%; padding: 15px; border: none; border-radius: 10px;
    font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s;
    margin-bottom: 10px;
}
.btn-enter { background: var(--accent); color: white; }
.btn-enter:hover { background: var(--secondary); }
.btn-register { background: #f1f2f6; color: var(--primary); }
.btn-register:hover { background: #dfe6e9; }
#adminSection { display: none; } /* Admin butonlarƒ±nƒ± ba≈ülangƒ±√ßta gizle */
/* TTS KARAOKE VURGUSU */
.highlight-word {
    background-color: #f1c40f !important; /* Sarƒ± Vurgu */
    color: #2c3e50 !important;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
    transition: all 0.1s;
    font-weight: bold;
    padding: 0 2px;
}
/* --- USER MANAGEMENT STYLES --- */
.user-list-wrapper { margin-top: 30px; border-top: 2px dashed #dfe6e9; padding-top: 20px; }
.user-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; }
.user-table th { text-align: left; padding: 12px; background: #f1f2f6; color: var(--primary); border-radius: 8px 8px 0 0; }
.user-table td { padding: 12px; border-bottom: 1px solid #eee; color: #2d3436; vertical-align: middle; }
.user-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
.badge-admin { background: #ffeaa7; color: #d35400; }
.badge-user { background: #dfe6e9; color: #636e72; }
.del-user-btn { padding: 5px 10px; background: #fab1a0; color: #c0392b; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
.del-user-btn:hover { background: #c0392b; color: white; }
/* --- YENƒ∞ SABƒ∞T ALT BAR TASARIMI --- */
.fixed-bottom-bar {
    height: 80px;
    width: 100%;
    background: #fff;
    border-top: 1px solid #f1f2f6;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    flex-shrink: 0;
    z-index: 20;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
}

.action-btn-fixed {
    padding: 12px 30px;
    border: none;
    border-radius: 50px;
    font-family: var(--font-main);
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-btn-fixed:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.btn-complete { background: var(--success); color: white; }
.btn-quiz { background: var(--accent); color: white; display: none; }

/* --- KESƒ∞N √á√ñZ√úM: Sƒ∞LME BUTONU G√ñR√úN√úRL√úƒû√ú --- */
.book-card {
    position: relative !important;
}

.delete-btn {
    opacity: 1 !important;          /* Gƒ∞ZLƒ∞Lƒ∞K ƒ∞PTAL: Hep g√∂r√ºn√ºr */
    visibility: visible !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    
    position: absolute;             /* Kartƒ±n i√ßinde sabitle */
    top: 5px;                       /* √ústten mesafe */
    right: 5px;                     /* Saƒüdan mesafe */
    
    background: white;              /* Beyaz zemin */
    color: #e74c3c;                 /* Kƒ±rmƒ±zƒ± ikon */
    border: 1px solid #e74c3c;      /* Kƒ±rmƒ±zƒ± √ßer√ßeve */
    
    width: 30px;
    height: 30px;
    border-radius: 50%;             /* Yuvarlak */
    font-size: 1rem;
    font-weight: bold;
    z-index: 100;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.delete-btn:hover {
    background: #e74c3c;
    color: white;
    transform: scale(1.1);
}
/* --- MOBƒ∞L ƒ∞√áƒ∞N √ñZEL AYAR --- */
@media (max-width: 900px) {
    .delete-btn {
        opacity: 1 !important;  /* Mobilde hep g√∂r√ºn√ºr olsun ama silik */
        color: #dfe6e9;         /* √áok a√ßƒ±k gri */
        top: 0px;
        right: 5px;
        font-size: 1.8rem;      /* Mobilde parmakla basmak i√ßin biraz daha b√ºy√ºk */
    }
}
</style>
</head>
<div id="dashListModal" class="dash-list-modal">
    <div class="dash-list-content">
        <button onclick="document.getElementById('dashListModal').style.display='none'" style="position:absolute; right:20px; top:20px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        <h3 id="dashListTitle" style="margin-top:0; color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:10px;">Liste</h3>
        <div id="dashListBody"></div>
    </div>
</div>
<div class="modal-overlay" id="userManagementModal">
  <div class="modal" style="background:#f4f6f8;"> <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:white; padding:20px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
        <div>
            <h2 style="color:var(--primary); margin:0; font-weight:800;">üë• Kullanƒ±cƒ± Y√∂netim Merkezi</h2>
            <div style="color:#7f8c8d; font-size:0.9rem;">Sisteme kayƒ±tlƒ± √ºyeleri inceleyin ve y√∂netin.</div>
        </div>
        <button onclick="document.getElementById('userManagementModal').style.display='none'" style="border:none; background:none; font-size:2rem; cursor:pointer; color:#95a5a6;">&times;</button>
    </div>

    <div id="userStatsHeader" style="display:flex; gap:20px; margin-bottom:20px;">
        </div>

    <div style="background:white; padding:30px; border-radius:20px; box-shadow:0 5px 20px rgba(0,0,0,0.05);">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <input type="text" id="userSearch" placeholder="Kullanƒ±cƒ± ara..." onkeyup="renderUserList(this.value)" style="padding:10px; border:2px solid #eee; border-radius:10px; width:300px; outline:none;">
            <button onclick="renderUserList()" style="padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">üîÑ Yenile</button>
        </div>
        <div id="userListArea" style="max-height:500px; overflow-y:auto;"></div>
    </div>

  </div>
</div>
<body>
<div id="loginOverlay" class="login-overlay">
    <div class="login-card">
        <div class="login-title">English Pro Hub</div>
        <div style="margin-bottom:20px; color:#7f8c8d; font-size:0.9rem;">L√ºtfen giri≈ü yapƒ±n veya kayƒ±t olun.</div>
        
        <input type="text" id="loginUser" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="password" id="loginPass" class="login-input" placeholder="≈ûifre">
        
        <button class="login-btn btn-enter" onclick="handleLogin()">Gƒ∞Rƒ∞≈û YAP</button>
        <button class="login-btn btn-register" onclick="handleRegister()">KAYIT OL</button>
        <div id="loginMsg" style="margin-top:10px; font-size:0.85rem; height:20px;"></div>
    </div>
</div>
<div id="wordTooltip"></div>
<div id="toast" class="toast"></div>

<div class="app-container">
<div class="sidebar">
    <h2>English Hub</h2>
    <div class="quick-dict-box">
        <input type="text" id="quickDic" class="quick-dict-input" placeholder="üîç Hƒ±zlƒ± S√∂zl√ºk..." onkeypress="handleQuickDict(event)">
    </div>
    <button class="nav-btn active" onclick="switchCategory('reading')">üìñ Reading</button>
    <button class="nav-btn" onclick="switchCategory('vocabulary')" style="display:none;">üî§ Vocabulary</button>
    <button class="nav-btn" onclick="switchCategory('unknowns')" style="color:#ff7675;">üö´ Unknown Words</button>
    <button class="nav-btn" onclick="switchCategory('favorites')" style="color:#f1c40f;">‚≠ê Favorites</button> 
    <button class="nav-btn" onclick="switchCategory('grammar')">üìò Grammar</button>
    <button class="nav-btn" onclick="switchCategory('notes')">üìù My Notes</button>
    <div style="height:1px; background:rgba(255,255,255,0.1); margin:5px 0;"></div>
    <button class="nav-btn" onclick="switchCategory('analytics')">üìä Analizler</button>
    <div style="height:1px; background:rgba(255,255,255,0.1); margin:5px 0;"></div>
    <button class="nav-btn" onclick="openWordMasterApp()" style="color:#f1c40f;">üéÆ Word Master</button>
    <button class="nav-btn" onclick="openExternalGame('grammar.html', 'Grammar Practice')">üöÄ Grammar Practice</button>
    <button class="nav-btn" onclick="openExternalGame('phrase-master.html', 'Phrase Master')">‚ú® Phrase Master</button>
    <div class="spacer"></div>
    <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0; width:100%;"></div>
<div id="adminSection">
        <button class="nav-btn" onclick="openAdmin()" style="color:#f1c40f; font-weight:700; width:100%;">
            ‚öôÔ∏è Data Manager
        </button>
        <button class="nav-btn" onclick="openUserPanel()" style="color:#00cec9; font-weight:700; width:100%;">
            üë• Kullanƒ±cƒ±lar
        </button>
    </div>
    
    <button class="nav-btn" onclick="logoutUser()" style="color:#ff7675; font-weight:700; width:100%;">
        üö™ √áƒ±kƒ±≈ü Yap
    </button>
  </div>
<div class="workbook-area">
    <div id="libraryHeader" class="library-header">
        <input type="text" id="mainSearch" class="main-search-input" placeholder="K√ºt√ºphanede Ara..." onkeyup="filterLibrary(this.value)">
    </div>

    <div id="libraryGrid" class="library-grid"></div>
    <div id="analyticsView" class="analytics-view"></div>

    <div id="openBookView" class="open-book-view">
        <div class="book-top-bar">
            <button class="back-btn" onclick="closeBook()">‚Üê K√ºt√ºphane</button>
            <strong id="bookHeaderTitle" style="color:var(--primary); font-size:1.1rem;">Title</strong>
            
            <div id="liveStats" class="live-stats-bar">
                <div class="stat-pill">üìñ Kelime: <strong id="liveWordCount">0</strong></div>
                <div class="stat-pill">‚è±Ô∏è S√ºre: <strong id="liveTimer">00:00</strong></div>
            </div>
<div id="headerTools" style="display:flex; gap:10px; align-items:center;">
                <button id="btnEditContent" onclick="openEditContent()" style="display:none; border:none; background:#f39c12; color:white; padding:5px 15px; border-radius:15px; font-size:0.8em; cursor:pointer; font-weight:bold;">‚úèÔ∏è D√úZENLE</button>
                <input id="myNoteTitleDisplay" type="text" style="display:none; border:none; border-bottom:1px solid #dfe6e9; text-align:center; font-family:var(--font-main);" onchange="saveNoteTitle(this.value)" placeholder="Ba≈ülƒ±k">                         
                <div id="notebookTools" class="notebook-tools">
                    <span style="font-size:0.8rem; color:#888;">Kalem:</span>
                    <input type="color" class="tool-select" value="#2c3e50" style="padding:0; height:30px; width:40px; border-radius:50%; border:none;" onchange="applyGlobalStyle('color', this.value)">
                    <select class="tool-select" onchange="applyGlobalStyle('size', this.value)">
                        <option value="16">16px</option><option value="20" selected>20px</option>
                        <option value="24">24px</option><option value="30">30px</option>
                        <option value="36">36px</option>
                    </select>
                </div>

                <select id="ttsSpeed" class="tool-select" style="display:none;">
                    <option value="0.7">0.7x</option><option value="0.8">0.8x</option>
                    <option value="0.9" selected>0.9x</option><option value="1.0">1.0x</option>
                </select>

                <div id="ttsControls" class="tts-controls-group">
                    <button class="tts-ctrl-btn btn-restart" onclick="handleTTS('restart')" title="Ba≈ütan Oku">üîÑ</button>
                    <button id="ttsPauseBtn" class="tts-ctrl-btn btn-pause" onclick="handleTTS('pause')" title="Duraklat/Devam Et">‚è∏</button>
                </div>
                
                <button id="langToggle" onclick="toggleLang()" style="display:none; border:none; background:var(--accent); color:white; padding:5px 15px; border-radius:15px; font-size:0.8em; cursor:pointer;">TR / ENG</button>
                <button id="addPageBtn" onclick="addPageToNote()" style="display:none; border:none; background:var(--success); color:white; padding:5px 15px; border-radius:15px; font-size:0.8em; cursor:pointer;">+ Sayfa</button>
                <button id="flashcardBtn" onclick="startFlashcardMode()" style="display:none; border:none; background:#8e44ad; color:white; padding:5px 15px; border-radius:15px; font-size:0.8em; cursor:pointer;">‚ö° KART MODU</button>
            </div>
        </div>

 <div class="book-spread">
            <div class="nav-arrow prev" onclick="turnPage(-1)">‚Äπ</div>
            <div id="pageLeft" class="single-page"></div>
            <div id="pageRight" class="single-page" style="display:none;"></div>
            <div class="nav-arrow next" onclick="turnPage(1)">‚Ä∫</div>
            <div class="page-num left" id="pageNumL">1</div>
        </div>
<div id="fixedBottomBar" class="fixed-bottom-bar" style="display:none;">
        <button id="btnFixedComplete" onclick="markAsCompleted()" class="action-btn-fixed btn-complete">‚úÖ OKUMAYI TAMAMLA</button>
        <button id="btnFixedQuiz" class="action-btn-fixed btn-quiz">üß† ƒ∞LGƒ∞Lƒ∞ TESTƒ∞ √á√ñZ</button>
        </div>
        <div id="externalAppView" style="display:none; width:100%; height:100%; flex-direction:column;">
        <div class="book-top-bar">
            <button class="back-btn" onclick="closeExternalApp()">‚Üê Kapat</button>
            <strong id="appTitle" style="color:var(--primary); margin-left: 20px;">Uygulama</strong>
            <div style="flex:1;"></div> </div>
        <iframe id="appFrame" style="flex:1; border:none; width:100%; height:100%;"></iframe>
    </div>

</div> <div class="modal-overlay" id="flashcardModal" style="display:none; align-items:center; justify-content:center;">
    <div class="modal" style="height:auto; width:600px; background:transparent; box-shadow:none;">
        <div id="flashcardContainer" style="text-align:center;"></div>
        <button onclick="document.getElementById('flashcardModal').style.display='none'" style="margin-top:20px; background:rgba(255,255,255,0.2); border:1px solid white; color:white; padding:10px 25px; border-radius:50px; cursor:pointer;">Kapat</button>
    </div>
</div>

<div class="modal-overlay" id="quickQuizModal" style="display:none;">
  <div class="modal" style="height:auto; max-height:90vh;">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="color:var(--primary); margin:0;">Yeni Test Ekle</h3><button onclick="document.getElementById('quickQuizModal').style.display='none'" style="border:none; background:none; font-size:1.5em; cursor:pointer;">&times;</button></div>
    <div style="background:#e8f8f5; padding:15px; font-size:0.85em; color:#16a085; border-radius:12px;">Format:<br>###SORULAR###<br>Ba≈ülƒ±k: A1 Airport<br>Q1: Soru... A)... Correct: A</div>
    <textarea id="quickQuizInput" style="height:300px;" placeholder="Sorularƒ± buraya yapƒ±≈ütƒ±r..."></textarea>
    <button onclick="saveQuickQuiz()" style="padding:15px; background:var(--success); color:white; border:none; font-weight:bold; cursor:pointer; border-radius:12px;">TESTƒ∞ KAYDET</button>
  </div>
</div>

<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="color:var(--primary); margin:0; font-weight:800; letter-spacing:-1px;">‚öôÔ∏è Data Manager Pro</h2>
        <button onclick="closeAdmin()" style="border:none; background:none; font-size:2rem; cursor:pointer; color:#95a5a6;">&times;</button>
    </div>

    <div class="admin-grid-top">
        <div class="admin-box box-backup">
            <div class="admin-box-title">üíæ Sistem Yedekleme</div>
            <div class="backup-actions">
                <button class="backup-btn dl-btn" onclick="exportData()">ƒ∞ndir (.json)</button>
                <button class="backup-btn" style="background:#8e44ad; color:white;" onclick="downloadDataJsFormat()">üì¶ Data.js Olarak ƒ∞ndir</button>
                <button class="backup-btn ul-btn" onclick="document.getElementById('restoreFile').click()">Y√ºkle</button>
                <button class="backup-btn" style="background:#8e44ad;" onclick="exportSmartTXT()">üìÑ T√ºm Seti Al (.txt)</button>
                <input type="file" id="restoreFile" style="display:none;" accept=".json" onchange="importData(this)">
            </div>
            <div style="font-size:0.8rem; color:#7f8c8d; margin-top:5px;">Verilerinizi d√ºzenli olarak yedeklemeniz √∂nerilir.</div>
        </div>

        <div class="admin-box box-danger">
            <div class="admin-box-title" style="color:var(--error);">üö® Tehlikeli B√∂lge</div>
            <div class="backup-actions">
                <button class="backup-btn danger-btn" onclick="resetProgress()">üî• ƒ∞lerlemeyi Sƒ±fƒ±rla</button>
                <button class="backup-btn danger-btn" onclick="clearGameLogs()">üéÆ Oyun Puanƒ± Sil</button>
                <button class="backup-btn danger-btn" onclick="removeDuplicates()">‚ôª √áiftleri Sil</button>
            </div>
            <div style="font-size:0.8rem; color:#fab1a0; margin-top:5px;">Dikkat: Bu i≈ülemler geri alƒ±namaz!</div>
        </div>
    </div>

    <div class="input-area-wrapper">
        <h3 style="margin:0 0 15px 0; color:var(--primary);">üìù Yeni ƒ∞√ßerik Ekle</h3>
        
        <div class="admin-input-row">
            <select id="inputCategory" class="admin-select">
                <option value="reading">üìñ Reading</option>
                <option value="vocabulary">üìó Vocabulary (Kelime)</option>
                <option value="idioms">üîÆ Vocabulary (Deyim)</option>
                <option value="phrases">üí¨ Vocabulary (Kalƒ±plar)</option>
                <option value="grammar">üìò Grammar</option>
                <option value="question">‚ùì Questions (Test)</option>
            </select>
            <button onclick="clearCategoryData()" class="backup-btn danger-btn" style="flex:0; min-width:140px;">Bu Kategoriyi Sil</button>
        </div>

        <input type="text" id="inputTitle" placeholder="Ba≈ülƒ±k (Opsiyonel)" style="width:100%; padding:15px; border:2px solid #dfe6e9; border-radius:15px; font-family:var(--font-main); display:none; margin-bottom:15px;">
        
        <textarea id="bulkInput" class="admin-textarea" placeholder="Verilerinizi buraya yapƒ±≈ütƒ±rƒ±n... (JSON formatƒ± veya D√ºz Metin)"></textarea>
        
        <button onclick="saveData()" class="save-btn-large">üíæ ƒ∞√áERƒ∞ƒûƒ∞ KAYDET VE YAYINLA</button>
    </div>

 </div>
</div>

<div class="modal-overlay" id="editContentModal" style="display:none; z-index:3000;">
  <div class="modal" style="width:900px; max-width:95vw; height:90vh; display:flex; flex-direction:column; padding:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; color:var(--primary);">‚úèÔ∏è ƒ∞√ßerik D√ºzenleyici</h3>
        <button onclick="document.getElementById('editContentModal').style.display='none'" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
    </div>
    
    <div style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
        <div>
            <label style="font-weight:bold; color:#7f8c8d; display:block; margin-bottom:5px;">Ba≈ülƒ±k:</label>
            <input type="text" id="editTitle" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-family:var(--font-main);">
        </div>

        <div style="display:flex; gap:15px; height:300px;">
            <div style="flex:1; display:flex; flex-direction:column;">
                <label style="font-weight:bold; color:#2980b9; margin-bottom:5px;">ƒ∞ngilizce Metin (HTML Destekli):</label>
                <textarea id="editEn" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; font-family:monospace; resize:none;"></textarea>
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <label style="font-weight:bold; color:#27ae60; margin-bottom:5px;">T√ºrk√ße Metin (HTML Destekli):</label>
                <textarea id="editTr" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; font-family:monospace; resize:none;"></textarea>
            </div>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; min-height:200px;">
            <label style="font-weight:bold; color:#e67e22; margin-bottom:5px;">Sorular (Format: Q1: Soru... A)... Correct: A):</label>
            <textarea id="editQuestions" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; font-family:monospace; resize:none;" placeholder="Sorular burada d√ºzenlenebilir..."></textarea>
        </div>
    </div>

    <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
        <button onclick="document.getElementById('editContentModal').style.display='none'" style="padding:10px 20px; border-radius:10px; border:none; cursor:pointer;">ƒ∞ptal</button>
        <button onclick="saveEditedContent()" style="padding:10px 30px; background:var(--success); color:white; border-radius:10px; border:none; font-weight:bold; cursor:pointer;">üíæ DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ KAYDET</button>
    </div>
  </div>
</div>

<script src="data.js">
</script>

<script>
/* --- ENGLISH PRO HUB MASTER SCRIPT (V35.1 STABLE & FIXED) --- */

/* 1. USER & DATABASE SYSTEM (MULTI-USER) */
let currentUser = null; // Aktif kullanƒ±cƒ±
let masterDB = {};      // T√ºm kullanƒ±cƒ±larƒ±n veritabanƒ±

// Varsayƒ±lan bo≈ü kullanƒ±cƒ± ≈üablonu
const defaultUserData = {
    contentData: [],
    userStats: { booksRead:0, pagesTurned:0, quizzesTaken:0, wordsAdded:0, notesTaken:0, totalCorrect:0, totalWrong:0, dailyActivity: {} },
    userUnknownWords: [],
    userKnownVocabulary: [],
    userActivityLog: [],
    userFavorites: []
};

// Global Deƒüi≈ükenler (Aktif kullanƒ±cƒ±ya g√∂re dolacak)
let contentData = [];
let userStats = {};
let userUnknownWords = [];
let userKnownVocabulary = [];
let userActivityLog = [];
let userFavorites = [];

// Diƒüer Deƒüi≈ükenler
let globalLexicon = {}; 
let recognition; 
let isListening = false; 
let currentTargetId = "";
let currentLevelFolder = null; 
let wmState = 'setup';
let wmType = 'vocab';
let wmMode = 'learn';
let gameQueue = []; 
let gameIndex = 0;
let wmSessionCount = 0;
let fcSessionCount = 0;
let readingTimerInterval;
let activeReadingSeconds = 0; 
let currentQuizTime = 0;
let externalAppStartTime = 0;
let externalTimerInterval; 
let currentPenStyle = { color: '#2c3e50', size: '20' }; 
let isTogglingContext = false;
let ttsObj = null;
let currentCategory='reading'; 
let currentBook=null; 
let pageIndex=0; 
let isTrMode=false; 
let quizAnswers={};
let lastReadingState = null; // Reading durumunu saklar
let pendingQuizState = null; // Test durumunu saklar
function saveQuizStateBeforeLeaving() {
    if(currentCategory === 'question' && currentBook && currentBook.questions) {
        pendingQuizState = {
            quizId: currentBook.id,
            quizAnswers: {...quizAnswers},
            questionIndex: pageIndex,
            quizTime: currentQuizTime
        };
    }
}

// --- Gƒ∞Rƒ∞≈û VE KAYIT Sƒ∞STEMƒ∞ ---
function initSystem() {
    // 1. Veritabanƒ±nƒ± LocalStorage'dan √ßekmeye √ßalƒ±≈ü
    const rawDB = localStorage.getItem('EnglishProMasterDB');
    
    // Veri dosyasƒ±ndan gelen i√ßerik var mƒ± kontrol et
    let externalData = [];
    if (typeof systemContent !== 'undefined') {
        externalData = systemContent;
    }

    if (rawDB) {
        masterDB = JSON.parse(rawDB);
        
        // Eƒüer Admin varsa ama i√ßi bo≈üsa veya eksikse, data.js verilerini y√ºkle
        if (masterDB['admin']) {
            // Eƒüer adminin i√ßeriƒüi bo≈üsa veya data.js'de veri varsa birle≈ütir/g√ºncelle
            if (!masterDB['admin'].data.contentData || masterDB['admin'].data.contentData.length === 0) {
                 masterDB['admin'].data.contentData = externalData;
                 saveMasterDB();
            }
        }
    } else {
        // 2. ƒ∞lk defa a√ßƒ±lƒ±yorsa (Veritabanƒ± yoksa)
        // Data.js i√ßindeki 'systemContent' verisini ba≈ülangƒ±√ß verisi yap
        masterDB = {
            'admin': {
                pass: 'mkutlu2108',
                data: {
                    contentData: externalData, // Data.js buraya y√ºkleniyor!
                    userStats: { booksRead:0, pagesTurned:0, quizzesTaken:0, wordsAdded:0, notesTaken:0, totalCorrect:0, totalWrong:0, dailyActivity: {} },
                    userUnknownWords: [],
                    userKnownVocabulary: [],
                    userActivityLog: [],
                    userFavorites: []
                }
            }
        };
        saveMasterDB();
    }
}

function handleLogin() {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    const msg = document.getElementById('loginMsg');

    // Otomatik giri≈ü kontrol√º (≈ûifresiz ge√ßi≈ü)
    if (!p && localStorage.getItem('lastSessionUser') === u && masterDB[u]) {
        // Oturum ge√ßerli, ≈üifre sormadan devam et
    } else {
        if (!masterDB[u]) { msg.innerText = "Kullanƒ±cƒ± bulunamadƒ±!"; msg.style.color = "red"; return; }
        if (masterDB[u].pass !== p) { msg.innerText = "Hatalƒ± ≈üifre!"; msg.style.color = "red"; return; }
    }

    // Giri≈ü Ba≈üarƒ±lƒ±
    currentUser = u;
    localStorage.setItem('lastSessionUser', u); // Oturumu kaydet
    loadUserData(u);
    document.getElementById('loginOverlay').style.display = 'none';
    
    // Admin kontrol√º
    if (currentUser === 'admin') {
        document.getElementById('adminSection').style.display = 'block';
    } else {
        document.getElementById('adminSection').style.display = 'none';
    }
    
    // Uygulamayƒ± ba≈ülat
    buildGlobalDictionary();
    switchCategory('reading');
    renderLibrary();
}

function logoutUser() {
    localStorage.removeItem('lastSessionUser'); // Oturumu sil
    location.reload(); 
}

function loadUserData(user) {
    const d = masterDB[user].data;
    // Global deƒüi≈ükenleri kullanƒ±cƒ±nƒ±n verisiyle doldur
    contentData = d.contentData || [];
    userStats = d.userStats || defaultUserData.userStats;
    userUnknownWords = d.userUnknownWords || [];
    userKnownVocabulary = d.userKnownVocabulary || [];
    userActivityLog = d.userActivityLog || [];
    userFavorites = d.userFavorites || [];
}

function saveToDB() {
    // Verileri masterDB i√ßindeki kullanƒ±cƒ±ya i≈üle
    if(!currentUser || !masterDB[currentUser]) return;

    masterDB[currentUser].data = {
        contentData: contentData,
        userStats: userStats,
        userUnknownWords: userUnknownWords,
        userKnownVocabulary: userKnownVocabulary,
        userActivityLog: userActivityLog,
        userFavorites: userFavorites
    };
    saveMasterDB();
}

function saveMasterDB() {
    localStorage.setItem('EnglishProMasterDB', JSON.stringify(masterDB));
}

// Kayƒ±t fonksiyonlarƒ±nƒ± override et (Eski fonksiyonlarƒ±n yerine bunu kullanacaklar)
function trackStat(key, val=1) { 
    userStats[key] = (userStats[key]||0)+val; 
    saveToDB(); 
}

function logActivity(type, title, detail, durationSeconds = 0, points = 0) {
    const date = new Date().toLocaleDateString('tr-TR');
    userActivityLog.push({ date, type, title, detail, timestamp: Date.now(), duration: durationSeconds, points: points });
    saveToDB();
}
/* 2. BA≈ûLATMA (G√úVENLƒ∞ MOD) */
window.onload = function() { 
    try {
        console.log("Sistem ba≈ülatƒ±lƒ±yor...");
        initSystem(); 
        setupVoice(); 
        
        // --- OTOMATƒ∞K Gƒ∞Rƒ∞≈û ---
        const defaultUser = 'admin';
        
        // Veritabanƒ± kontrol√º
        if (!masterDB[defaultUser]) {
            console.log("Kullanƒ±cƒ± yeniden olu≈üturuluyor...");
            initSystem(); 
        }

        currentUser = defaultUser;
        loadUserData(defaultUser);
        
        // Login ekranƒ±nƒ± kaldƒ±r
        const overlay = document.getElementById('loginOverlay');
        if(overlay) overlay.style.display = 'none';
        
        // Men√ºleri a√ß
        const adminSec = document.getElementById('adminSection');
        if(adminSec) adminSec.style.display = 'block';

        buildGlobalDictionary();
        switchCategory('reading');
        renderLibrary();
        console.log("Sistem hazƒ±r!");
        
    } catch (e) {
        console.error("Ba≈ülatma hatasƒ±:", e);
        alert("Sistem ba≈ülatƒ±lƒ±rken bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.");
    }
};

/* --- METƒ∞N PAR√áALAMA & ƒ∞≈ûLEME Sƒ∞STEMƒ∞ (D√úZELTƒ∞LDƒ∞) --- */
function paginateText(html, makeInteractive, charLimit = 15000) { 
    // --- TEK PAR√áA OKUMA MANTIƒûI ---
    // Limiti 15.000 yaptƒ±k. Bu, neredeyse t√ºm makaleleri tek sayfada tutar.
    // <p> etiketleri artƒ±k sayfa b√∂l√ºc√º deƒüil, sadece alt satƒ±ra ge√ßiren birer elementtir.
    
    let tempDiv = document.createElement("div");
    tempDiv.innerHTML = html;
    let fullText = tempDiv.innerHTML; // T√ºm HTML i√ßeriƒüini al

    // ƒ∞√ßerik limitten kƒ±saysa B√ñLME, tek par√ßa d√∂nd√ºr.
    if (fullText.length < charLimit) {
        return [makeInteractive ? processInteractiveText(fullText) : fullText];
    }

    // Eƒüer √ßok √ßok uzun bir metinse (√∂rn: b√ºt√ºn bir kitap), o zaman b√∂lmeye √ßalƒ±≈ü.
    // Ancak bu sefer paragraflarƒ± kƒ±rmadan en yakƒ±n paragraf sonundan b√∂l.
    
    let pages = [];
    let remainingText = fullText;

    while (remainingText.length > 0) {
        if (remainingText.length <= charLimit) {
            pages.push(makeInteractive ? processInteractiveText(remainingText) : remainingText);
            break;
        }

        // Limite yakƒ±n bir yerden (paragraf sonu) b√∂lmeye √ßalƒ±≈ü
        let splitIndex = remainingText.lastIndexOf("</p>", charLimit);
        
        // Eƒüer uygun bir </p> bulamazsa, bo≈üluktan b√∂l
        if (splitIndex === -1) splitIndex = remainingText.lastIndexOf(" ", charLimit);
        // Hi√ßbir ≈üey bulamazsa mecburen limitten kes
        if (splitIndex === -1) splitIndex = charLimit;
        else splitIndex += 4; // </p> etiketini dahil et

        let pageContent = remainingText.substring(0, splitIndex);
        pages.push(makeInteractive ? processInteractiveText(pageContent) : pageContent);
        
        remainingText = remainingText.substring(splitIndex);
    }

    return pages;
}

function processInteractiveText(html) {
    // Sadece metin d√ºƒü√ºmlerini bulup kelimelere ayƒ±rƒ±r, HTML taglerine dokunmaz
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    function walkAndReplace(node) {
        if (node.nodeType === 3) { // Text Node
            const text = node.nodeValue;
            // Kelimeleri bul (sadece harfler)
            const newHTML = text.replace(/([a-zA-Z√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú']+)/g, (match) => {
                let lower = match.toLowerCase();
                let savedClass = userUnknownWords.some(u => u.en.toLowerCase() === lower) ? ' saved' : '';
                let meaning = getWordMeaning(lower) || '';
                return `<span class="interactive-word${savedClass}" data-meaning="${meaning}">${match}</span>`;
            });
            
            // Eƒüer deƒüi≈üiklik olduysa span ile deƒüi≈ütir
            if(newHTML !== text) {
                const wrapper = document.createElement('span');
                wrapper.innerHTML = newHTML;
                node.parentNode.replaceChild(wrapper, node);
            }
        } else if (node.nodeType === 1 && !node.classList.contains('interactive-word')) {
            // Element Node, i√ßine gir (recursion)
            Array.from(node.childNodes).forEach(walkAndReplace);
        }
    }

    walkAndReplace(tempDiv);
    return tempDiv.innerHTML;
}

// TOOLTIP EVENT LISTENER
document.addEventListener('mouseover', function(e) {
    if(e.target.classList.contains('interactive-word')) {
        let m = e.target.getAttribute('data-meaning');
        if(m && m !== 'null' && m !== 'undefined' && m !== '') {
            let t = document.getElementById('wordTooltip');
            t.innerHTML = m;
            t.style.display = 'block';
            t.style.left = (e.pageX + 10) + 'px';
            t.style.top = (e.pageY + 15) + 'px';
        }
    }
});

document.addEventListener('mouseout', function(e) {
    if(e.target.classList.contains('interactive-word')) {
        document.getElementById('wordTooltip').style.display = 'none';
    }
});

// KELƒ∞ME TIKLAMA (KAYDETME/Sƒ∞LME)
document.addEventListener('click', function(e) {
    if(e.target.classList.contains('interactive-word')) {
        let word = e.target.innerText.replace(/[^a-zA-Z0-9'√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]/g, '');
        let meaning = e.target.getAttribute('data-meaning');
        toggleUnknown(e.target, word, meaning);
    }
});

function trackStat(key, val=1) { 
    userStats[key]=(userStats[key]||0)+val; 
    localStorage.setItem('userStats',JSON.stringify(userStats)); 
}

function showToast(msg, err=false) { 
    const t=document.getElementById('toast'); 
    if(t) {
        t.textContent=msg; 
        t.className=err?'toast error':'toast'; 
        t.style.display='block'; 
        setTimeout(()=>t.style.display='none',3000); 
    }
}

/* 3. LOGLAMA */
function logActivity(type, title, detail, durationSeconds = 0, points = 0) {
    const date = new Date().toLocaleDateString('tr-TR');
    userActivityLog.push({ 
        date, type, title, detail, 
        timestamp: Date.now(), 
        duration: durationSeconds, 
        points: points 
    });
    localStorage.setItem('userActivityLog', JSON.stringify(userActivityLog));
}

function calculateDetailedScore(dateStr) {
    const logs = userActivityLog.filter(l => l.date === dateStr);
    let report = { totalScore: 0, vocabCount: 0, questionCount: 0, timeMinutes: 0, gameMinutes: 0, pageCount: 0 };

    logs.forEach(l => {
        let pts = Number(l.points) || 0;
        if(pts > 0) report.totalScore += pts;
        
        if(l.duration) {
            if(l.type === 'external_game') report.gameMinutes += Math.floor(l.duration / 60);
            else report.timeMinutes += Math.floor(l.duration / 60);
        }
    });

    if(userStats.dailyActivity && userStats.dailyActivity[dateStr]) {
        report.pageCount = userStats.dailyActivity[dateStr].pages || 0;
    }
    report.totalScore += (report.pageCount * 10);
    return report;
}

function calculateLifetimeScore() {
    let total = 0;
    userActivityLog.forEach(l => {
        let pts = Number(l.points) || 0;
        if(pts > 0) total += pts;
    });
    let totalPages = 0;
    if(userStats.dailyActivity) {
        for(let date in userStats.dailyActivity) {
            totalPages += (userStats.dailyActivity[date].pages || 0);
        }
    }
    total += (totalPages * 10);
    return total;
}

/* ANALYTICS */
function openAnalytics() {
    document.getElementById('libraryGrid').style.display='none'; 
    document.getElementById('libraryHeader').style.display='none'; 
    document.getElementById('openBookView').style.display='none';
    document.getElementById('analyticsView').style.display='block';
    
    const today = new Date(); const todayStr = today.toLocaleDateString('tr-TR');
    const reportToday = calculateDetailedScore(todayStr);
    const lifetimeScore = calculateLifetimeScore();
    const currentLevel = Math.floor(lifetimeScore / 1000) + 1;
    const progressPercent = (lifetimeScore % 1000) / 10;

    let scoreboardHtml = `
        <div class="level-dashboard">
            <div class="total-score-card">
                <div class="level-label">‚≠ê TOPLAM PUAN (SEVƒ∞YE ${currentLevel})</div>
                <div class="total-points">${lifetimeScore}</div>
                <div class="level-progress-container">
                    <div class="level-bar-bg"><div class="level-bar-fill" style="width:${progressPercent}%"></div></div>
                    <div class="level-text"><span>Sonraki Seviye: ${currentLevel + 1}</span><span>%${Math.round(progressPercent)}</span></div>
                </div>
            </div>
            <div class="daily-score-card">
                <div class="daily-title">BUG√úN√úN KAZANCI</div>
                <div class="daily-val">+${reportToday.totalScore}</div>
                <div class="daily-time">${Math.floor((reportToday.timeMinutes + reportToday.gameMinutes)/60)}sa ${(reportToday.timeMinutes + reportToday.gameMinutes)%60}dk</div>
            </div>
        </div>
        <div style="text-align:center; margin-bottom:20px;">
             <button class="score-rules-toggle" style="position:static;" onclick="toggleScoreRules()">‚ùì Puanlama Sistemi</button>
        </div>
        <div id="scoreRules" class="score-rules-box">
             <h4 style="margin-top:0; color:var(--primary);">üìä Puanlama Sistemi</h4>
            <table class="rules-table"><thead><tr><th>Aktivite</th><th>Puan Deƒüeri</th></tr></thead><tbody><tr><td><span class="rule-icon">üìÑ</span> Sayfa √áevirme</td><td><strong>10 Puan</strong> / sayfa</td></tr><tr><td><span class="rule-icon">‚úÖ</span> Soru √á√∂z√ºm√º</td><td><strong>15 Puan</strong> / doƒüru</td></tr><tr><td><span class="rule-icon">üß†</span> Kelime Ezberi</td><td><strong>10 Puan</strong> / kelime</td></tr><tr><td><span class="rule-icon">üöÄ</span> Oyunlar & Pratik</td><td><strong>20 Puan</strong> / dakika</td></tr><tr><td><span class="rule-icon">üìñ</span> Okuma Tamamlama</td><td><strong>10 Puan</strong></td></tr></tbody></table>
        </div>
    `;

    let weeklyHtml = `<h4 style="margin:20px 0 10px 0; color:var(--primary); opacity:0.7;">üìÖ Haftalƒ±k Performans</h4><div class="weekly-score-container">`;
    const daysShort = ['Paz', 'Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt'];
    for (let i = 6; i >= 0; i--) {
        let d = new Date(); d.setDate(d.getDate() - i);
        let dStr = d.toLocaleDateString('tr-TR');
        let dName = daysShort[d.getDay()];
        let dScore = calculateDetailedScore(dStr).totalScore;
        let activeClass = (i === 0) ? 'today' : '';
        weeklyHtml += `<div class="weekly-day-box ${activeClass}"><div class="w-day-name">${dName}</div><div class="w-day-score">${dScore}</div></div>`;
    }
    weeklyHtml += `</div>`;

    let monthlyHtml = `<div class="monthly-chart-container"><div style="font-weight:700; color:var(--primary);">üìÖ Aylƒ±k Aktivite Yoƒüunluƒüu (Son 30 G√ºn)</div><div class="chart-bars">`;
    let maxMonthScore = 1;
    let monthData = [];
    for(let i=29; i>=0; i--){
        let d = new Date(); d.setDate(d.getDate() - i);
        let dStr = d.toLocaleDateString('tr-TR');
        let s = calculateDetailedScore(dStr).totalScore;
        if(s > maxMonthScore) maxMonthScore = s;
        monthData.push({date: dStr, score: s});
    }
    monthData.forEach(day => {
        let h = (day.score / maxMonthScore) * 100;
        if(h < 5 && day.score > 0) h = 5; 
        monthlyHtml += `<div class="chart-bar" style="height:${h}%" data-date="${day.date.split('.')[0]}" data-score="${day.score}"></div>`;
    });
    monthlyHtml += `</div></div>`;

    const rTot = contentData.filter(i=>i.category==='reading').length; 
    const rComp = contentData.filter(i=>i.category==='reading' && i.completed).length;
    const qTot = contentData.filter(i=>i.category==='question').length; 
    const qComp = contentData.filter(i=>i.category==='question' && i.completed).length;
    const gTot = contentData.filter(i=>i.category==='grammar').length; 
    const gComp = contentData.filter(i=>i.category==='grammar' && i.completed).length;

    let activityInnerHtml = "";
    const sortedLogs = [...userActivityLog].sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
    const groupedLogs = {};
    sortedLogs.forEach(log => { if (!groupedLogs[log.date]) groupedLogs[log.date] = []; groupedLogs[log.date].push(log); });

    if (Object.keys(groupedLogs).length === 0) {
        activityInnerHtml += `<div style="text-align:center; color:#999; padding:20px;">Kayƒ±t yok.</div>`;
    } else {
        for (const date in groupedLogs) {
            activityInnerHtml += `<div class="activity-date-header" style="background:#f1f2f6; margin-top:10px;">üìÖ ${date}</div>`;
            groupedLogs[date].forEach(log => {
                 let icon = 'üîπ'; 
                if(log.type === 'reading') icon = 'üìñ'; 
                if(log.type === 'quiz') icon = '‚ùì'; 
                if(log.type === 'vocab') icon = 'üß†'; 
                if(log.type === 'grammar') icon = 'üìò'; 
                if(log.type === 'external_game') icon = 'üöÄ';
                let durText = log.duration ? ` <span class="log-duration">(${Math.floor(log.duration/60)}dk ${log.duration%60}sn)</span>` : "";
                let pts = log.points || 0;
                let pointBadge = pts ? `<span class="log-point-badge">+${pts} Puan</span>` : "";
                activityInnerHtml += `<div class="activity-item"><div><span class="activity-type-icon">${icon}</span> ${log.title} <span class="log-detail-text">${log.detail || ''}</span></div><div class="log-meta">${durText} ${pointBadge}</div></div>`;
            });
        }
    }
    
    let activitySection = `
        <div class="accordion-box">
            <div class="accordion-header" onclick="toggleAccordion('actLogs')">
                <span>üìã G√ºnl√ºk Hareket D√∂k√ºm√º</span>
                <span class="arrow-icon">‚ñº</span>
            </div>
            <div id="actLogs" class="accordion-content">
                <div style="padding:15px; max-height:400px; overflow-y:auto;">${activityInnerHtml}</div>
            </div>
        </div>
    `;

    const createLevelTable = (title, keyword) => {
        let html = `<div style="flex:1;"><div class="section-title">${title}</div><table class="vocab-stats-table"><thead><tr><th>Seviye</th><th>Toplam</th><th>Bildiƒüin</th><th>Durum</th></tr></thead><tbody>`;
        const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
        
        levels.forEach(lvl => {
            let lvlWords = [];
            const relevantBooks = contentData.filter(b => {
                if (b.category !== 'vocabulary') return false;
                const titleUpper = b.title.toUpperCase();
                if (!titleUpper.includes(lvl)) return false;
                if (keyword === 'Idioms') return titleUpper.includes('IDIOMS');
                if (keyword === 'Phrases') return titleUpper.includes('PHRASES');
                return !titleUpper.includes('IDIOMS') && !titleUpper.includes('PHRASES');
            });

            relevantBooks.forEach(b => { 
                if(b.words) lvlWords = lvlWords.concat(b.words.map(w => w.en)); 
            });
            
            lvlWords = [...new Set(lvlWords)];
            const total = lvlWords.length;

            if(total > 0) {
                const knownCount = lvlWords.filter(w => {
                    return userKnownVocabulary.some(known => known.toLowerCase() === w.toLowerCase());
                }).length;

                const percent = Math.round((knownCount / total) * 100);
                html += `<tr><td><strong>${lvl}</strong></td><td>${total}</td><td style="color:#27ae60">${knownCount}</td><td><div class="progress-track"><div class="progress-fill-know" style="width:${percent}%"></div></div></td></tr>`;
            } else { 
                html += `<tr><td>${lvl}</td><td colspan="3" style="color:#ccc;">Veri Yok</td></tr>`; 
            }
        });
        return html + `</tbody></table></div>`;
    };

    const v = document.getElementById('analyticsView');
    v.innerHTML = `
        <div class="analytics-header"><h2>üìà Performans Merkezi</h2></div>
        ${scoreboardHtml}
        ${weeklyHtml}
        <div class="stats-grid">
            <div class="stat-card" style="border-bottom-color:#e67e22;"><div class="stat-number" style="color:#e67e22">${rComp}/${rTot}</div><div class="stat-label">Okunan Kitap</div></div>
            <div class="stat-card" style="border-bottom-color:#27ae60;"><div class="stat-number" style="color:#27ae60">${qComp}/${qTot}</div><div class="stat-label">Bitirilen Test</div></div>
            <div class="stat-card" style="border-bottom-color:#f1c40f;"><div class="stat-number" style="color:#f1c40f">${gComp}/${gTot}</div><div class="stat-label">Tamamlanan Gramer</div></div>
            <div class="stat-card" style="border-bottom-color:#3498db;"><div class="stat-number" style="color:#3498db">${userKnownVocabulary.length}</div><div class="stat-label">Ezberlenen Kelime</div></div>
        </div>
        ${activitySection}
        <div class="analytics-grid-row" style="margin-top:30px;">
            ${createLevelTable('üìó Kelime Analizi', 'Vocab')}
            ${createLevelTable('üîÆ Deyim Analizi', 'Idioms')}
            ${createLevelTable('üí¨ Kalƒ±p Analizi', 'Phrases')}
        </div>
    `;
}

function toggleAccordion(id) {
    const el = document.getElementById(id);
    if(el.classList.contains('open')) el.classList.remove('open');
    else el.classList.add('open');
}

function toggleScoreRules() {
    const box = document.getElementById('scoreRules');
    if(box.style.display === 'block') box.style.display = 'none';
    else box.style.display = 'block';
}

function speakWord(text) {
    if('speechSynthesis' in window){
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }
}

function toggleFavorite(en, tr) {
    const idx = userFavorites.findIndex(f => f.en === en);
    if(idx > -1) { 
        userFavorites.splice(idx, 1); 
        showToast("Favorilerden √ßƒ±karƒ±ldƒ±");
    } else { 
        userFavorites.push({en, tr}); 
        showToast("Favorilere eklendi"); 
    }
    saveToDB(); // YENƒ∞ Sƒ∞STEM: Kullanƒ±cƒ± veritabanƒ±na kaydet
    if(currentCategory === 'wordmaster' || currentCategory === 'favorites_flashcard' || currentCategory === 'unknowns_flashcard') {
        renderSpread();
    }
}
function isFavorite(en) { return userFavorites.some(f => f.en === en); }

/* 4. HARƒ∞Cƒ∞ OYUNLAR */
function openExternalGame(url, title) {
    // 1. Arka planƒ± temizle (√áakƒ±≈ümayƒ± √∂nlemek i√ßin)
    stopReadingTimer();

    // 2. Oyun Alanƒ± Elementini Bul
    const view = document.getElementById('externalAppView');
    const titleEl = document.getElementById('appTitle');

    if(titleEl) titleEl.innerText = title;

    if(view) {
        // --- KRƒ∞Tƒ∞K HAMLE: KAPSAYICIDAN KURTARMA ---
        // Elementi bulunduƒüu kutudan (workbook-area) √ßƒ±karƒ±p, 
        // HTML'in en dƒ±≈ü katmanƒ±na (Body'nin sonuna) ta≈üƒ±yoruz.
        // Bu i≈ülem, z-index ve overflow sorunlarƒ±nƒ± %100 √ß√∂zer.
        document.body.appendChild(view);

        // --- IFRAME YENƒ∞LEME ---
        // Eski iframe'i silip yenisini olu≈üturarak y√ºklemeyi tetikle
        const oldFrame = document.getElementById('appFrame');
        if(oldFrame) oldFrame.remove();

        const newFrame = document.createElement('iframe');
        newFrame.id = 'appFrame';
        newFrame.style.cssText = "flex:1; width:100%; height:100%; border:none; background:#ffffff;";
        newFrame.src = url;

        view.appendChild(newFrame);

        // --- G√ñR√úN√úM AYARLARI ---
        // Ekranƒ± tam kapla ve en √∂ne ge√ß
        view.style.display = 'flex';
        view.style.flexDirection = 'column';
        view.style.position = 'fixed';    // Ekrana sabitle
        view.style.top = '0';
        view.style.left = '0';
        view.style.width = '100vw';       // Geni≈ülik %100
        view.style.height = '100vh';      // Y√ºkseklik %100
        view.style.zIndex = '2147483647'; // Maksimum Z-Index deƒüeri
        view.style.background = '#ffffff'; // Arka plan beyaz
    }
}
function closeExternalApp() {
    // Varsa zamanlayƒ±cƒ±yƒ± garanti durdur
    if(typeof externalTimerInterval !== 'undefined') clearInterval(externalTimerInterval);

    const view = document.getElementById('externalAppView');
    const frame = document.getElementById('appFrame'); 
    
    if(view) view.style.display = 'none'; 
    if(frame) frame.src = ""; // Iframe'i bo≈üaltarak y√ºk√º azalt
    
    // Ana ekrana d√∂n
    switchCategory('reading'); 
    renderLibrary(); 
}
/* 5. WORD MASTER (D√úZELTƒ∞LDƒ∞: BOYUT AYARI) */
function openWordMasterApp() {
    closeBook();
    currentCategory = 'wordmaster';
    wmState = 'setup';
    wmSessionCount = 0;
    document.getElementById('libraryGrid').style.display='none';
    document.getElementById('libraryHeader').style.display='none';
    document.getElementById('openBookView').style.display='flex';
    document.getElementById('bookHeaderTitle').innerText = "üéÆ Word Master";
    
    ['myNoteTitleDisplay','langToggle','addPageBtn','flashcardBtn','ttsControls','ttsSpeed','liveStats','notebookTools'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display='none';
    });
    
    document.querySelector('.nav-arrow.prev').style.display='none'; 
    document.querySelector('.nav-arrow.next').style.display='none';
    renderSpread();
}

function startWordGame(level) {
    let candidates = [];
    const books = contentData.filter(b => {
        if(b.category !== 'vocabulary') return false;
        if(!b.title.includes(level)) return false;
        if(wmType === 'idioms') return b.title.includes('Idioms');
        else if(wmType === 'phrasals') return b.title.includes('Phrases');
        else return !b.title.includes('Idioms') && !b.title.includes('Phrases');
    });
    books.forEach(b => { candidates = candidates.concat(b.words); });
    
    if(candidates.length === 0) return alert("Bu seviyede kelime bulunamadƒ±!");
    
    if (wmMode === 'learn') {
        gameQueue = candidates.filter(w => !userKnownVocabulary.includes(w.en));
        if(gameQueue.length === 0) return alert("Hepsini biliyorsun! Tekrar modunu dene.");
    } else {
        gameQueue = candidates.filter(w => userKnownVocabulary.includes(w.en));
        if(gameQueue.length === 0) return alert("Hen√ºz bildiƒüin kelime yok.");
    }
    
    gameQueue = gameQueue.sort(() => Math.random() - 0.5); 
    gameIndex = 0;
    wmState = 'playing';
    renderSpread();
}

function handleGameResult(isKnown) {
    wmSessionCount++;
    const w = gameQueue[gameIndex];
    if(isKnown) {
        if(!userKnownVocabulary.includes(w.en)) { 
            userKnownVocabulary.push(w.en); 
            localStorage.setItem('userKnownVocabulary', JSON.stringify(userKnownVocabulary)); 
        }
        const uIdx = userUnknownWords.findIndex(u => u.en === w.en);
        if(uIdx > -1) { 
            userUnknownWords.splice(uIdx, 1); 
            localStorage.setItem('userUnknownWords', JSON.stringify(userUnknownWords)); 
        }
    } else {
        if(!isUnknown(w.en)) { 
            userUnknownWords.push({en: w.en, tr: w.tr}); 
            localStorage.setItem('userUnknownWords', JSON.stringify(userUnknownWords)); 
        }
        const kIdx = userKnownVocabulary.indexOf(w.en);
        if(kIdx > -1) { 
            userKnownVocabulary.splice(kIdx, 1); 
            localStorage.setItem('userKnownVocabulary', JSON.stringify(userKnownVocabulary)); 
            showToast("Unutulanlara eklendi", true);
        }
    }
    trackStat('wordsAdded', 0);
    gameIndex++; 
    if(gameIndex >= gameQueue.length) wmState = 'result';
    renderSpread();
}

function finishWordMasterSession() {
    let score = wmSessionCount;
    wmSessionCount = 0; 
    if (score > 0) {
        logActivity('vocab', 'Word Master', `${score} Kelime`, 0, score * 10);
        showToast(`${score} kelime i≈ülendi!`);
    }
    wmState = 'setup';
    renderSpread();
}

function renderWordMasterGame(pL, pR) {
    if(wmState === 'setup') {
        // --- D√úZELTƒ∞LDƒ∞: Sol ve Saƒü Kartlarƒ± Kart ƒ∞√ßine Aldƒ±k ---
        document.querySelector('.book-spread').classList.add('split-mode');
        
        pL.innerHTML = `
            <div class="wm-setup-card">
                <div class="wm-setup-title">1. Mod ve T√ºr</div>
                <div class="wm-mode-toggle">
                    <div class="wm-mode-opt ${wmMode==='learn'?'active':''}" onclick="setWmMode('learn')">√ñƒüren</div>
                    <div class="wm-mode-opt ${wmMode==='review'?'active':''}" onclick="setWmMode('review')">Tekrar Et</div>
                </div>
                <button class="wm-type-btn ${wmType==='vocab'?'selected':''}" onclick="selectWmType('vocab')">üìó Kelime</button>
                <button class="wm-type-btn ${wmType==='idioms'?'selected':''}" onclick="selectWmType('idioms')">üîÆ Deyim</button>
                <button class="wm-type-btn ${wmType==='phrasals'?'selected':''}" onclick="selectWmType('phrasals')">üí¨ Kalƒ±p</button>
            </div>
        `;
        pR.innerHTML = `
            <div class="wm-setup-card">
                <div class="wm-setup-title">2. Seviye Se√ß</div>
                <div class="wm-level-grid">
                    ${['A1','A2','B1','B2','C1','C2'].map(l => `<button class="wm-level-btn" onclick="startWordGame('${l}')">${l}</button>`).join('')}
                </div>
            </div>
        `;
    } 
    else if(wmState === 'playing') {
        document.querySelector('.book-spread').classList.remove('split-mode');
        const w = gameQueue[gameIndex];
        let favClass = isFavorite(w.en) ? 'active' : '';
        pL.style.flex = "2"; pL.style.borderRight = "none"; pL.style.alignItems = "center"; pL.style.justifyContent = "center";
        pR.style.display = "none";
        
     // D√úZELTME: Saya√ß kaldƒ±rƒ±ldƒ±, margin: 0 auto ile ortalandƒ±
        pL.innerHTML = `
            <div style="width:100%; max-width:500px; margin: 0 auto; display:flex; flex-direction:column; align-items:center;">
                <div class="wm-card-container" onclick="this.classList.toggle('wm-flipped')">
                    <div class="wm-flip-inner">
                        <div class="wm-card-front">
                            <div style="margin-bottom:15px;">${w.en}</div>
                            <div class="card-action-wrapper">
                                <span class="card-tool-btn btn-listen" onmousedown="event.stopPropagation(); speakWord('${w.en}')">üîä</span>
                                <span class="card-tool-btn btn-fav ${favClass}" onmousedown="event.stopPropagation(); toggleFavorite('${w.en}', '${w.tr}')">‚òÖ</span>
                            </div>
                        </div>
                        <div class="wm-card-back">${w.tr}</div>
                    </div>
                </div>
                <div class="wm-controls">
                    <button class="wm-btn wm-btn-unknow" onmousedown="handleGameResult(false)" ontouchstart="handleGameResult(false); event.preventDefault();">‚ùå Bilmiyorum</button>
                    <button class="wm-btn wm-btn-know" onmousedown="handleGameResult(true)" ontouchstart="handleGameResult(true); event.preventDefault();">‚úÖ Biliyorum</button>
                </div>
                <button onclick="finishWordMasterSession()" style="margin-top:20px; border:none; background:none; color:#95a5a6; cursor:pointer;">Bitir ve Kaydet</button>
            </div>
        `;
    }
    else if(wmState === 'result') {
        document.querySelector('.book-spread').classList.remove('split-mode');
        pL.style.flex = "2"; pL.style.alignItems = "center"; pL.style.justifyContent = "center"; pR.style.display = "none";
        pL.innerHTML = `<div style="text-align:center;"><h1>üéâ Bitti!</h1><button class="wm-btn" style="background:var(--primary);" onclick="finishWordMasterSession()">Men√ºye D√∂n</button></div>`;
    }
}
function selectWmType(type) { wmType = type; renderSpread(); }
function setWmMode(mode) { wmMode = mode; renderSpread(); }

/* 6. READING & PAGINATION (SINGLE PARAGRAPH CARD MODE) */
let bookChunksEn = [];
let bookChunksTr = [];

function openBook(i) {
    stopReadingTimer();
    currentQuizTime = 0; activeReadingSeconds = 0; pageIndex = 0;
    
    if(currentCategory !== 'unknowns') trackStat('booksRead');

    // --- G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û AYRA√á TEMƒ∞ZLEME VE B√ñLME ---
    let rawSource = i.enText || i.content || "";
    
    // Regex: <p> etiketleri arasƒ±nda olsa bile --- veya [T√ºrk√ße √áeviri] ifadesini bulur
    const splitterRegex = /(?:<p>\s*)?(?:---|\[T√ºrk√ße √áeviri\])(?:\s*<\/p>)?/i;

    if (splitterRegex.test(rawSource)) {
        let parts = rawSource.split(splitterRegex);
        
        if (parts.length > 1) {
            i.enText = parts[0].trim(); // ƒ∞ngilizce Kƒ±sƒ±m
            i.trText = parts[1].trim(); // T√ºrk√ße Kƒ±sƒ±m
            i.content = i.enText;       // G√∂r√ºnen i√ßeriƒüi temizle
        }
    }
    // ------------------------------------------------

    currentBook=i; 
    isTrMode=false; 
    quizAnswers={};
    
    // Aray√ºz√º Temizle
    document.getElementById('libraryGrid').style.display='none'; 
    document.getElementById('libraryHeader').style.display='none'; 
    document.getElementById('openBookView').style.display='flex'; 
    document.getElementById('bookHeaderTitle').innerText=i.title;
    
  // Ara√ßlarƒ± Gizle (Edit butonu dahil hepsini √∂nce gizle)
    const toolIds = ['btnEditContent', 'myNoteTitleDisplay','langToggle','addPageBtn','flashcardBtn','ttsControls','ttsSpeed','liveStats','notebookTools'];
    toolIds.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
  // Reading, Question veya Grammar ise Edit butonunu a√ß
    if(currentCategory === 'reading' || currentCategory === 'question' || currentCategory === 'grammar') {
        const btnEdit = document.getElementById('btnEditContent');
        if(btnEdit) btnEdit.style.display = 'block';
    }
    // Oklarƒ± G√∂ster
    document.querySelector('.nav-arrow.prev').style.display='flex'; 
    document.querySelector('.nav-arrow.next').style.display='flex';
    
if(currentCategory==='reading') { 
        document.getElementById('langToggle').style.display='block'; 
        document.getElementById('ttsControls').style.display='flex'; 
        document.getElementById('ttsSpeed').style.display='block';
        document.getElementById('liveStats').style.display='flex'; 
        
        // --- PARAGRAF AYIRMA VE TEMƒ∞ZLƒ∞K ---
        const chunkRegex = /<\/p>|<\/div>|<br\s*\/?>\s*<br\s*\/?>|\n\s*\n/i;
        
        // 1. Temizlik (Uzun alt √ßizgileri sil)
        let rawEn = (i.enText || "").replace(/_{3,}/g, ''); 
        
        // 2. ƒ∞ngilizce Par√ßala ve ETKƒ∞LE≈ûƒ∞MLƒ∞ YAP (processInteractiveText Eklendi)
        bookChunksEn = rawEn.split(chunkRegex).filter(t => t.trim().length > 0).map(t => {
            let para = t.includes('<') ? t : `<p>${t}</p>`;
            return processInteractiveText(para); // <-- Kelimeler artƒ±k tƒ±klanabilir
        });

        // 3. T√ºrk√ße Par√ßala
        if(i.trText && i.trText.length > 0) {
            let rawTr = i.trText.replace(/_{3,}/g, ''); // T√ºrk√ßedeki √ßizgileri de sil
            bookChunksTr = rawTr.split(chunkRegex).filter(t => t.trim().length > 0).map(t => {
                return t.includes('<') ? t : `<p>${t}</p>`;
            });
            if (bookChunksTr.length === 0 && i.trText) {
                bookChunksTr = [i.trText.includes('<') ? i.trText : `<p>${i.trText}</p>`];
            }
        } else {
            bookChunksTr = [];
        }

        // Kelime Sayacƒ±
        const cleanText = rawEn.replace(/<[^>]*>/g, '');
        const wCount = document.getElementById('liveWordCount');
        if(wCount) wCount.innerText = cleanText.trim().split(/\s+/).length;
        
        startReadingTimer(); 
    }
else if(currentCategory==='grammar') {
        document.getElementById('notebookTools').style.display='flex'; 
        document.getElementById('liveStats').style.display='flex';
        
        // --- GRAMER ƒ∞√áERƒ∞ƒûƒ∞Nƒ∞ Y√úKLE (G√ñR√úN√úRL√úK D√úZELTMESƒ∞) ---
        // ƒ∞√ßeriƒüi tek par√ßa sayfa olarak diziye atƒ±yoruz.
        // B√∂ylece renderSpread fonksiyonu bo≈ü sayfa yerine bu i√ßeriƒüi g√∂sterir.
        let rawContent = i.content || i.enText || "<p>ƒ∞√ßerik hazƒ±rlanƒ±yor...</p>";
        bookChunksEn = [rawContent];
        bookChunksTr = []; // √áeviri sekmesi bo≈ü kalabilir
        
        startReadingTimer(); 
    }
    else if(currentCategory==='question') {
        document.getElementById('liveStats').style.display='flex';
        document.querySelector('.nav-arrow.prev').style.display='none'; 
        document.querySelector('.nav-arrow.next').style.display='none';
        startReadingTimer(); 
    }
    else if(currentCategory==='unknowns' || currentCategory==='favorites') {
        const fb = document.getElementById('flashcardBtn');
        if(fb) fb.style.display='block';
    }
    
    setTimeout(() => { renderSpread(); }, 50);
}
/* --- G√úNCELLENMƒ∞≈û G√ñR√úN√úM Y√ñNETƒ∞Mƒ∞ (SABƒ∞T ALT MEN√úL√ú) --- */


function renderSpread() {
    if ('speechSynthesis' in window) speechSynthesis.cancel();
    
    const pL = document.getElementById('pageLeft');
    const pR = document.getElementById('pageRight');
    
    // --- 1. TAM DOM TEMƒ∞ZLƒ∞ƒûƒ∞ (ZORUNLU) ---
    pL.innerHTML = ""; 
    pL.className = ""; // T√ºm eski sƒ±nƒ±flarƒ± (single-page vb.) sil
    if(pR) { pR.innerHTML = ""; pR.style.display = "none"; }
    
    // --- 2. ALT BAR Y√ñNETƒ∞Mƒ∞ ---
    const bottomBar = document.getElementById('fixedBottomBar');
    if(bottomBar) bottomBar.style.display = 'none';

    // --- 3. MODA G√ñRE KONTEYNER AYARLARI ---
    
    // A) QUESTION (TEST) MODU - Tek Ekran, Kaƒüƒ±t Efekti YOK
    if(currentCategory === 'question') {
        pL.style.display = "block";
        pL.style.width = "100%";
        pL.style.maxWidth = "100%"; // Tam geni≈ülik
        pL.style.margin = "0";
        pL.style.padding = "0"; // ƒ∞√ß bo≈üluklarƒ± sƒ±fƒ±rla
        pL.style.background = "transparent"; // Arka plan yok
        pL.style.boxShadow = "none"; // G√∂lge yok
        
        // Testi Render Et
        renderQuizSingleMode(pL); 
        return; 
    }

    // B) OYUNLAR (Word Master / Flashcard)
    if(currentCategory === 'wordmaster') { 
        pL.classList.add('single-page'); // Gerekirse sƒ±nƒ±f ekle
        renderWordMasterGame(pL, pR); return; 
    }
    if(currentCategory === 'unknowns_flashcard' || currentCategory === 'favorites_flashcard') { 
        pL.classList.add('single-page');
        renderUnknownFlashcards(pL, pR); return; 
    }

    // C) READING ve GRAMMAR (Standart Kaƒüƒ±t G√∂r√ºn√ºm√º)
    // Bu noktaya geldiyse Reading veya Grammar'dƒ±r.
    // .single-page sƒ±nƒ±fƒ±nƒ± TEKRAR ekle.
    pL.classList.add('single-page'); 
    pL.style.display = "block";
    
    // Diƒüer stil ayarlarƒ±nƒ± sƒ±fƒ±rla (Question modundan kalma riskine kar≈üƒ±)
    pL.style.maxWidth = ""; 
    pL.style.margin = "";
    pL.style.padding = ""; 
    pL.style.background = ""; 
    pL.style.boxShadow = "";
    // 2. SAYFALAMA ƒ∞√áERƒ∞ƒûƒ∞Nƒ∞ HAZIRLA
    let pages = [];

    // GRAMER
    if(currentCategory === 'grammar') {
        pages = bookChunksEn || [];
        // Gramerde de alt barƒ± a√ßalƒ±m (Sadece tamamla butonu)
        if(bottomBar) {
            bottomBar.style.display = 'flex';
            const quizBtn = document.getElementById('btnFixedQuiz');
            if(quizBtn) quizBtn.style.display = 'none'; // Quiz yok
            updateCompleteButton();
        }
    }
    // READING
    else if(currentCategory === 'reading') {
        pages = isTrMode ? bookChunksTr : bookChunksEn;
        if(!pages || pages.length === 0) pages = ["<p>ƒ∞√ßerik y√ºkleniyor...</p>"];
        
        // --- YENƒ∞: Alt Barƒ± Y√∂net ---
        if(bottomBar) {
            bottomBar.style.display = 'flex';
            updateCompleteButton(); // Tamamla butonunu g√ºncelle
            
            // ƒ∞lgili Test Var mƒ± Kontrol Et
            const currentTitleClean = currentBook.title.trim().toLowerCase();
            const linkedQuiz = contentData.find(q => q.category === 'question' && q.title.trim().toLowerCase() === currentTitleClean);
            const btnQuiz = document.getElementById('btnFixedQuiz');
            
            if (linkedQuiz) {
                btnQuiz.style.display = 'flex';
                btnQuiz.onclick = () => switchFromReadingToQuiz(linkedQuiz.id);
                
                // Test √ß√∂z√ºld√º m√º?
                if (linkedQuiz.completed) {
                    btnQuiz.innerText = "‚Ü∫ TESTƒ∞ TEKRAR √á√ñZ";
                    btnQuiz.style.background = "#7f8c8d";
                } else {
                    btnQuiz.innerText = "üß† ƒ∞LGƒ∞Lƒ∞ TESTƒ∞ √á√ñZ";
                    btnQuiz.style.background = "#e67e22";
                }
            } else {
                btnQuiz.style.display = 'none';
            }
        }
    }
    // Dƒ∞ƒûER (Kelime Listeleri vb.)
    else {
        if(currentCategory==='vocabulary') pages=paginateVocab(currentBook.words, false);
        else if(currentCategory==='unknowns' || currentCategory==='favorites') pages=paginateVocab(currentBook.words, true);
    }

    // 3. SAYFAYI G√ñSTER
    if(pageIndex >= pages.length) pageIndex = pages.length - 1;
    if(pageIndex < 0) pageIndex = 0;

    pL.innerHTML = pages[pageIndex] || "";

    // Gramer i√ßin not defteri stilini uygula
    if(currentCategory === 'grammar' && document.getElementById('t')) applyStyleToElement(document.getElementById('t'));
    
    updateNav(pages.length);
}

// Butonun rengini ve yazƒ±sƒ±nƒ± ayarlayan yardƒ±mcƒ± fonksiyon
function updateCompleteButton() {
    const btnComp = document.getElementById('btnFixedComplete');
    const btnQuiz = document.getElementById('btnFixedQuiz');
    
    if(!btnComp) return;

    // Baƒülƒ± test var mƒ± kontrol et
    const currentTitleClean = currentBook.title.trim().toLowerCase();
    const linkedQuiz = contentData.find(q => q.category === 'question' && q.title.trim().toLowerCase() === currentTitleClean);

    // SENARYO 1: Devam eden test VARSA (pendingQuizState varsa)
    if (pendingQuizState && pendingQuizState.quizId) {
        // "TEST'E GERƒ∞ D√ñN" butonunu g√∂ster
        btnQuiz.style.display = 'flex';
        btnQuiz.innerText = "‚Üª TEST'E GERƒ∞ D√ñN";
        btnQuiz.style.background = "#9b59b6";
        btnQuiz.onclick = function() { 
            returnToQuizFromReading();
        };
      
        // Tamamlama butonunu da g√∂ster (normal durumda)
        if (currentBook.completed) {
            btnComp.innerHTML = "‚úÖ OKUMA TAMAMLANDI";
            btnComp.className = "action-btn-fixed btn-complete";
            btnComp.onclick = null;
        } else {
            btnComp.innerHTML = "‚úÖ OKUMAYI TAMAMLA";
            btnComp.className = "action-btn-fixed btn-complete";
            btnComp.onclick = function() { markAsCompleted(); };
        }
        btnComp.style.display = 'flex';
    }
    // SENARYO 2: Test var ama devam eden yoksa
    else if (linkedQuiz) {
        if (linkedQuiz.completed) {
            // Hem okuma hem test bitmi≈ü
            btnComp.innerHTML = "üéâ TEBRƒ∞KLER (Test Tamamlandƒ±)";
            btnComp.className = "action-btn-fixed btn-complete";
            btnComp.disabled = true;
            btnComp.style.opacity = "0.7";
            btnComp.onclick = null;
            btnComp.style.display = 'flex';
            
            // Quiz butonunu "TEKRAR √á√ñZ" yap
            btnQuiz.style.display = 'flex';
            btnQuiz.innerText = "‚Ü∫ TESTƒ∞ TEKRAR √á√ñZ";
            btnQuiz.style.background = "#7f8c8d";
            btnQuiz.onclick = function() { 
                switchFromReadingToQuiz(linkedQuiz.id);
            };
        } else {
            // Okuma bitti veya bitmedi ama sƒ±rada Test var
            btnComp.innerHTML = "üìù OKUMAYI TAMAMLA VE TESTE GE√á";
            btnComp.className = "action-btn-fixed";
            btnComp.style.background = "#e67e22";
            btnComp.style.color = "white";
            btnComp.style.display = 'flex';
            
            // üìå KRƒ∞Tƒ∞K: Direkt testi a√ß
            btnComp.onclick = function() { 
                saveReadingProgress();
                switchFromReadingToQuiz(linkedQuiz.id);
            };
            
            // Quiz butonunu da a√ß (ikinci buton)
            btnQuiz.style.display = 'flex';
            btnQuiz.innerText = "üß† ƒ∞LGƒ∞Lƒ∞ TESTƒ∞ √á√ñZ";
            btnQuiz.style.background = "#e67e22";
            btnQuiz.onclick = function() { 
                switchFromReadingToQuiz(linkedQuiz.id);
            };
        }
    } 
    // SENARYO 3: Testi Yok (Sadece Okuma)
    else {
        if (currentBook.completed) {
            btnComp.innerHTML = "‚úÖ OKUMA TAMAMLANDI";
            btnComp.className = "action-btn-fixed btn-complete";
            btnComp.onclick = null;
        } else {
            btnComp.innerHTML = "‚úÖ OKUMAYI TAMAMLA";
            btnComp.className = "action-btn-fixed btn-complete";
            btnComp.onclick = function() { markAsCompleted(); };
        }
        btnComp.style.display = 'flex';
        btnQuiz.style.display = 'none'; // Test butonunu gizle
    }
}

// YENƒ∞ GE√áƒ∞≈û FONKSƒ∞YONU
function handleCompleteAndQuiz(quizId) {
    // 1. Reading ilerlemesini kaydet (Ama 'completed' yapma, test bitince olacak)
    saveReadingProgress();
    
    // 2. Ge√ßi≈ü Yap
    switchFromReadingToQuiz(quizId);
} 

function turnPage(d){ 
    let step = (d > 0) ? 1 : -1;
    let newIndex = pageIndex + step;
    if(newIndex < 0) newIndex = 0;
    pageIndex = newIndex;
    if(step > 0) trackStat('pagesTurned');
    renderSpread(); 
}

function updateNav(len) { 
    const pNL = document.getElementById('pageNumL');
    
    // --- D√úZELTME: EƒûER 1 SAYFAYSA NUMARAYI Gƒ∞ZLE ---
    if(len <= 1) {
        pNL.style.display = 'none';
        document.querySelector('.nav-arrow.prev').style.display = 'none';
        document.querySelector('.nav-arrow.next').style.display = 'none';
    } else {
        pNL.style.display = 'block';
        pNL.innerText = (pageIndex + 1) + " / " + len; 
        
        const prev = document.querySelector('.nav-arrow.prev');
        const next = document.querySelector('.nav-arrow.next');
        prev.style.display = 'flex'; // Reading/Grammar i√ßin g√∂r√ºn√ºr yap (Geri getir)
        next.style.display = 'flex';

        if(prev) prev.style.visibility = (pageIndex <= 0) ? 'hidden' : 'visible'; 
        if(next) next.style.visibility = (pageIndex >= len - 1) ? 'hidden' : 'visible'; 
    }
}
function toggleLang(){ 
    isTrMode = !isTrMode; 
    renderSpread(); 
}

function switchFromReadingToQuiz(quizId) {
    // √ñnce reading state'ini kaydet
    saveReadingStateBeforeQuiz();
    
    saveReadingProgress();

    // 1. √ñnce ID ile aramayƒ± dene
    let targetQuiz = contentData.find(x => x.id == quizId);

    // 2. ID ile bulunamazsa, Ba≈ülƒ±k (Title) ile aramayƒ± dene (Yedek Plan)
    if (!targetQuiz) {
        // Eƒüer currentBook yoksa, o an a√ßƒ±k olan reading'i contentData'dan bul
        let activeReading = currentBook;
        if (!activeReading) {
            // En son a√ßƒ±lan reading'i bookHeaderTitle'dan bul
            const currentTitle = document.getElementById('bookHeaderTitle').innerText;
            activeReading = contentData.find(x => x.category === 'reading' && x.title === currentTitle);
        }
        
        if (activeReading) {
            const cleanTitle = activeReading.title.trim();
            targetQuiz = contentData.find(x => x.category === 'question' && x.title.trim() === cleanTitle);
        }
    }

    if (targetQuiz) {
        stopReadingTimer();
        currentCategory = 'question';
        
        // Quiz state'ini temizle (yeni ba≈ülƒ±yor)
        quizAnswers = {};
        pageIndex = 0;
        pendingQuizState = null;
        
        // Men√º butonunu g√ºncelle
        document.querySelectorAll('.nav-btn').forEach(b => {
            b.classList.remove('active');
            if(b.getAttribute('onclick') && b.getAttribute('onclick').includes('question')) b.classList.add('active');
        });

        // Ekranƒ± kapatmadan direkt testi a√ß (Hata √∂nleyici)
        openBook(targetQuiz);
        showToast("Test Ba≈ülatƒ±lƒ±yor...");
    } else {
        alert("Hata: ƒ∞lgili test bulunamadƒ±.\nReading ba≈ülƒ±ƒüƒ± (" + (currentBook ? currentBook.title : 'Bilinmiyor') + ") ile Test ba≈ülƒ±ƒüƒ±nƒ±n AYNI olduƒüundan emin olun.");
    }
}
/* --- QUESTION -> READING GERƒ∞ D√ñN√ú≈û Sƒ∞STEMƒ∞ --- */

// Question'a ge√ßerken reading state'ini kaydet
function saveReadingStateBeforeQuiz() {
    if (currentBook && currentCategory === 'reading') {
        lastReadingState = {
            bookId: currentBook.id,
            pageIndex: pageIndex,
            readingTime: activeReadingSeconds
        };
    }
}

// Reading'e geri d√∂n
function goBackToReading() {
    if (!lastReadingState) {
        alert("√ñnce bir reading a√ßmalƒ±sƒ±nƒ±z.");
        return;
    }
    
    // Mevcut quiz durumunu kaydet
    pendingQuizState = {
        quizId: currentBook.id,
        quizAnswers: {...quizAnswers},
        questionIndex: pageIndex
    };
    
    // Reading'i bul ve a√ß
    const readingBook = contentData.find(b => b.id === lastReadingState.bookId);
    if (!readingBook) {
        alert("Reading bulunamadƒ±!");
        return;
    }
    
    // State'leri geri y√ºkle
    currentBook = readingBook;
    currentCategory = 'reading';
    pageIndex = lastReadingState.pageIndex;
    activeReadingSeconds = lastReadingState.readingTime || 0;
    
    // Aray√ºz√º ayarla
    document.getElementById('openBookView').style.display = 'flex';
    document.getElementById('libraryGrid').style.display = 'none';
    document.getElementById('libraryHeader').style.display = 'none';
    document.getElementById('bookHeaderTitle').innerText = currentBook.title;
    
    // Reading'e √∂zel ara√ßlarƒ± g√∂ster
    document.getElementById('langToggle').style.display = 'block';
    document.getElementById('ttsControls').style.display = 'flex';
    document.getElementById('ttsSpeed').style.display = 'block';
    document.getElementById('liveStats').style.display = 'flex';
    document.querySelector('.nav-arrow.prev').style.display = 'flex';
    document.querySelector('.nav-arrow.next').style.display = 'flex';
    
    // Reading'i render et
    renderSpread();
    startReadingTimer();
    showToast("Reading'e d√∂n√ºld√º. Test'e geri d√∂nmek i√ßin 'TEST'E D√ñN' butonunu kullanƒ±n.");
}

// Reading'den tekrar quiz'e d√∂n
function returnToQuizFromReading() {
    if (!pendingQuizState) {
        alert("Devam eden test bulunamadƒ±.");
        return;
    }
    
    // Quiz'i bul
    let quizBook = contentData.find(q => 
        q.category === 'question' && 
        q.id === pendingQuizState.quizId
    );
    
    if (!quizBook) {
        // ID ile bulamazsa title ile dene
        const quizBookByTitle = contentData.find(q => 
            q.category === 'question' && 
            q.title.trim() === currentBook.title.trim()
        );
        if (!quizBookByTitle) {
            alert("ƒ∞lgili test bulunamadƒ±!");
            return;
        }
        quizBook = quizBookByTitle;
    }
    
    // Quiz state'lerini geri y√ºkle
    currentBook = quizBook;
    currentCategory = 'question';
    pageIndex = pendingQuizState.questionIndex || 0;
    quizAnswers = pendingQuizState.quizAnswers || {};
    
    // Aray√ºz√º ayarla
    document.getElementById('bookHeaderTitle').innerText = currentBook.title;
    document.querySelector('.nav-arrow.prev').style.display = 'none';
    document.querySelector('.nav-arrow.next').style.display = 'none';
    document.getElementById('langToggle').style.display = 'none';
    document.getElementById('ttsControls').style.display = 'none';
    document.getElementById('ttsSpeed').style.display = 'none';
    
    // Quiz'i render et
    renderSpread();
    startReadingTimer();
}

function markAsCompleted() { 
    if(!currentBook) return; 

    let durationText = activeReadingSeconds > 0 ? ` (${getFormattedTime(activeReadingSeconds)})` : "";
    let pts = 10;
    
    if(currentCategory === 'reading') {
        if(!currentBook.completed) showToast("Reading Tamamlandƒ±: +10 Puan"); 
        trackStat('booksRead');
        logActivity('reading', currentBook.title, 'Okuma Tamamlandƒ±' + durationText, activeReadingSeconds, pts);
    }
    else if(currentCategory === 'grammar') {
        if(!currentBook.completed) showToast("Gramer Tamamlandƒ±: +10 Puan"); 
        logActivity('grammar', currentBook.title, 'Gramer Tamamlandƒ±' + durationText, activeReadingSeconds, pts);
    }

    currentBook.readingDuration = (currentBook.readingDuration || 0) + activeReadingSeconds;
    activeReadingSeconds = 0; 
    currentBook.completed = true;
    
    saveToDB();
    renderSpread(); 
    renderLibrary(); // Ye≈üil tƒ±k i√ßin aray√ºz√º g√ºncelle
}
/* 7. FLASHCARDS & UNKNOWNS */
function startFlashcardMode() { 
    let list = (currentCategory === 'favorites') ? userFavorites : userUnknownWords;
    if(list.length === 0) return alert("Liste bo≈ü!");
    
    currentCategory = (currentCategory === 'favorites') ? 'favorites_flashcard' : 'unknowns_flashcard';
    fcSessionCount = 0;
    fcIndex = 0;
    document.querySelector('.nav-arrow.prev').style.display='none'; 
    document.querySelector('.nav-arrow.next').style.display='none';
    renderSpread();
}

function renderUnknownFlashcards(pL, pR) {
    const isFavMode = currentCategory === 'favorites_flashcard';
    const list = isFavMode ? userFavorites : userUnknownWords;
    if (!list || list.length === 0) {
        switchCategory(isFavMode ? 'favorites' : 'unknowns');
        return;
    }
    if (fcIndex >= list.length) fcIndex = 0;
    const w = list[fcIndex];
    let favClass = isFavorite(w.en) ? 'active' : '';

    // D√úZELTME: Flex ve Center ayarlarƒ± temizlendi, manuel margin ile ortalama saƒülandƒ±
    pL.style.display = "block"; // Flex yerine Block yapƒ±sƒ± (Margin auto √ßalƒ±≈ümasƒ± i√ßin)
    pR.style.display = "none";
    
    let btnLeftText = isFavMode ? "‚òÖ √áƒ±kar" : "‚úÖ √ñƒürendim (Sil)";
    let hintHtml = w.hint ? `<div class="hint-section" style="margin:5px 0;"><button onclick="event.stopPropagation(); toggleHint()" class="hint-btn">üí° ƒ∞pucu</button><div id="hintText" class="hint-text-box" style="position:absolute;bottom:60px;left:20px;right:20px;z-index:20;background:rgba(0,0,0,0.8);color:#fff;display:none;">${w.hint}</div></div>` : `<div class="hint-section"><button onclick="event.stopPropagation(); addHint()" class="hint-btn">‚ûï ƒ∞pucu Ekle</button></div>`;

    // D√úZELTME: margin: 0 auto eklendi, wm-count-display (saya√ß) satƒ±rƒ± silindi
    pL.innerHTML = `
        <div style="width:100%; max-width:500px; margin: 0 auto; display:flex; flex-direction:column; align-items:center;">
            <div class="wm-card-container" onclick="this.classList.toggle('wm-flipped')">
                <div class="wm-flip-inner">
                    <div class="wm-card-front">
                        <div style="margin-bottom:5px;">${w.en}</div>${hintHtml}
                        <div class="card-action-wrapper">
                            <span class="card-tool-btn btn-listen" onmousedown="event.stopPropagation(); speakWord('${w.en}')">üîä</span>
                            <span class="card-tool-btn btn-fav ${favClass}" onmousedown="event.stopPropagation(); toggleFavorite('${w.en}', '${w.tr}')">‚òÖ</span>
                        </div>
                    </div>
                    <div class="wm-card-back">${w.tr}</div>
                </div>
            </div>
            <div class="wm-controls">
                <button class="wm-btn wm-btn-know" onmousedown="handleUnknownFlashcardResult('delete')" ontouchstart="handleUnknownFlashcardResult('delete'); event.preventDefault();">${btnLeftText}</button>
                <button class="wm-btn" style="background:#95a5a6;" onmousedown="handleUnknownFlashcardResult('next')" ontouchstart="handleUnknownFlashcardResult('next'); event.preventDefault();">‚û°Ô∏è Sƒ±radaki</button>
            </div>
            <button onclick="switchCategory('${isFavMode ? 'favorites' : 'unknowns'}')" style="margin-top:20px; border:none; background:none; color:#95a5a6; cursor:pointer;">Listeye D√∂n</button>
        </div>
    `;
}

function handleUnknownFlashcardResult(action) {
    fcSessionCount++;
    const isFavMode = currentCategory === 'favorites_flashcard';
    const list = isFavMode ? userFavorites : userUnknownWords;
    const storageKey = isFavMode ? 'userFavorites' : 'userUnknownWords';

    if(action === 'delete') {
        const w = list[fcIndex];
        list.splice(fcIndex, 1);
        localStorage.setItem(storageKey, JSON.stringify(list));
        if (!isFavMode) { 
             logActivity('vocab', 'Kelime √ñƒürenildi', w.en, 0, 10); 
             showToast("+10 Puan");
        }
        if(list.length === 0) { alert("Liste bitti."); switchCategory(isFavMode ? 'favorites' : 'unknowns'); return; }
        if(fcIndex >= list.length) fcIndex = 0;
    } else {
        fcIndex++;
        if(fcIndex >= list.length) fcIndex = 0;
    }
    renderSpread();
}

function toggleHint() { const el = document.getElementById('hintText'); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
function addHint() {
    const list = currentCategory === 'favorites_flashcard' ? userFavorites : userUnknownWords;
    const hint = prompt("ƒ∞pucu girin:");
    if(hint) { list[fcIndex].hint = hint; localStorage.setItem(currentCategory === 'favorites_flashcard'?'userFavorites':'userUnknownWords', JSON.stringify(list)); renderSpread(); }
}

/* 8. QUIZ Sƒ∞STEMƒ∞ */
function renderQuizSingleMode(container) {
    let qs = currentBook.questions || [];
    if(pageIndex >= qs.length) { finishQuizSingleMode(container); return; }

    let q = qs[pageIndex];
    let qNum = pageIndex + 1;
    let progress = Math.round((qNum / qs.length) * 100);
    
    let optsHtml = q.options.map(o => {
        let key = o.charAt(0);
        let selected = quizAnswers[qNum] === key ? 'selected' : '';
        return `<div class="quiz-opt ${selected}" onclick="selAnsSingle(${qNum}, '${key}')">${o}</div>`;
    }).join('');

    let isAnswered = quizAnswers[qNum] ? true : false;
    let btnText = (pageIndex === qs.length - 1) ? "Testi Bitir" : "Sonraki Soru";
    
    // YENƒ∞: Reading'e d√∂n butonu eklendi
    container.innerHTML = `
        <div class="quiz-centered-container">
            <div class="quiz-question-card">
                <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <button onclick="goBackToReading()" style="padding:8px 15px; background:#3498db; color:white; border:none; border-radius:20px; cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:5px;">
                        ‚Üê Reading'e D√∂n
                    </button>
                    <div style="font-weight:600; color:#7f8c8d;">Soru ${qNum}/${qs.length}</div>
                </div>
                
                <div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:${progress}%"></div></div>
                <div class="quiz-q-text"><span style="color:var(--accent); margin-right:5px;">Soru ${qNum}:</span> ${q.text}</div>
                <div class="quiz-options-area">${optsHtml}</div>
                <button id="qNextBtn" class="quiz-next-btn" onclick="nextQuestionSingle()" ${isAnswered ? '' : 'disabled'}>${btnText} ‚û°Ô∏è</button>
            </div>
        </div>
    `;
}

function selAnsSingle(n, k) { quizAnswers[n] = k; renderSpread(); }
function nextQuestionSingle() { pageIndex++; renderSpread(); }

function finishQuizSingleMode(container) { 
    stopReadingTimer();
    let correct=0, wrong=0; 
    let qs=currentBook.questions; 
    let reviewHtml = "";
    
    qs.forEach((q,i)=>{ 
        let userAnsKey = quizAnswers[i+1];
        let correctAnsText = q.options.find(o => o.startsWith(q.correct)) || q.correct;
        
        if(userAnsKey === q.correct) { 
            correct++; 
            reviewHtml += `<div class="review-item correct"><span>${i+1}. ${q.text}</span><span style="color:green">‚úî Doƒüru</span></div>`; 
        } else { 
            wrong++; 
            reviewHtml += `<div class="review-item wrong"><span>${i+1}. ${q.text}</span><span>‚ùå Yanlƒ±≈ü (Doƒüru: ${correctAnsText})</span></div>`; 
        } 
    });
    
    let score = Math.round((correct/qs.length)*100);
    const earnedPoints = correct * 15; 


// Reading ba≈ülƒ±ƒüƒ± ile e≈üle≈üen okuma par√ßasƒ±nƒ± bul
    const relatedReading = contentData.find(r => r.category === 'reading' && r.title.trim() === currentBook.title.trim());

    if (!currentBook.completed) {
        currentBook.completed = true;
        trackStat('quizzesTaken');
        logActivity('quiz', currentBook.title, `Quiz: ${correct}D / ${wrong}Y`, currentQuizTime, earnedPoints);
        
        // --- KRƒ∞Tƒ∞K: Test bittiyse Reading de bitti sayƒ±lƒ±r ---
        if(relatedReading) {
            relatedReading.completed = true;
            trackStat('booksRead'); // Reading istatistiƒüini ≈üimdi artƒ±r
            // Opsiyonel: Reading puanƒ± da verilebilir
        }
        showToast("Test ve Okuma Tamamlandƒ±! +Puan");
    } else {
        logActivity('quiz', currentBook.title, `Tekrar: ${correct}D / ${wrong}Y`, currentQuizTime, 0);
    }
// Test tamamlandƒ±ƒüƒ±nda pendingQuizState'i temizle
    pendingQuizState = null;
    lastReadingState = null;
    currentBook.stats = { readingTime: 0, quizTime: currentQuizTime, score: score };
    saveToDB();
    userStats.totalCorrect = (userStats.totalCorrect || 0) + correct; 
    userStats.totalWrong = (userStats.totalWrong || 0) + wrong; 
    localStorage.setItem('userStats', JSON.stringify(userStats));
    
    let color = score >= 70 ? '#27ae60' : (score >= 50 ? '#f39c12' : '#c0392b');
    container.style.justifyContent = "flex-start"; container.style.overflowY = "auto"; 

container.innerHTML = `
    <div class="quiz-final-wrapper">
        <div class="quiz-sticky-header">
            <div style="display:flex; align-items:center; gap:20px;">
                <div class="result-circle-score" style="background:${color}; width:60px; height:60px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; font-size:1.2rem; border-radius:50%; border:3px solid white;">%${score}</div>
                <div><h3 style="margin:0; color:var(--primary);">Test Sonucu</h3><div>‚úÖ ${correct} D | ‚ùå ${wrong} Y</div></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="goBackToReading()" style="padding:10px 20px; background:#3498db; color:white; border:none; border-radius:50px; cursor:pointer;">‚Üê Reading'e D√∂n</button>
                <button onclick="closeBook()" style="padding:10px 25px; background:var(--primary); color:white; border:none; border-radius:50px; cursor:pointer;">√áIKI≈û ‚ûî</button>
            </div>
        </div>
        <div class="quiz-detail-content">
            <div style="background:#fff; border-radius:20px; border:1px solid #eee; padding:10px;">${reviewHtml}</div>
        </div>
    </div>
`;
}

/* 9. STANDART FONKSƒ∞YONLAR (S√ñZL√úK, ADMƒ∞N, VB.) */
function paginateVocab(w, isListMode = false){ 
    if(!w)return[]; 
    const itemsPerPage = isListMode ? 13 : 69; 
    let p=[]; 
    for(let i=0;i<w.length;i+=itemsPerPage){
        let c=w.slice(i,i+itemsPerPage); 
        let h = "";
        if(isListMode) {
             h = `<div>`;
             c.forEach(x=> {
                 let favClass = isFavorite(x.en) ? 'active' : '';
                 h+=`<div class="unknown-list-item"><strong>${x.en} <span class="tts-small" onclick="speakWord('${x.en}')">üîä</span> <span class="fav-btn ${favClass}" onclick="toggleFavorite('${x.en}', '${x.tr}')">‚òÖ</span></strong> : ${x.tr}</div>`;
             });
             h += `</div>`;
        } else {
             h=`<div class="vocab-layout">`; 
             c.forEach(x=> {
                 let favClass = isFavorite(x.en) ? 'active' : '';
                 h+=`<div class="vocab-item"><span class="vocab-en">${x.en} <span class="tts-small" onclick="speakWord('${x.en}')">üîä</span> <span class="fav-btn ${favClass}" onclick="toggleFavorite('${x.en}', '${x.tr}')">‚òÖ</span></span><span class="vocab-tr">${x.tr}</span></div>`;
             });
             h+=`</div>`;
        }
        p.push(h);
    } 
    return p; 
}

function switchCategory(cat) {
    currentCategory=cat; 
    currentLevelFolder = null; 
    closeBook();
    
    document.querySelectorAll('.nav-btn').forEach(b=>{ 
        b.classList.remove('active'); 
        if(b.getAttribute('onclick').includes(cat)) b.classList.add('active'); 
    });
    
    // --- Lƒ∞STEYƒ∞ ATLA, Dƒ∞REKT KARTA GE√á ---
    if(cat === 'unknowns') { 
        document.getElementById('libraryGrid').style.display='none';
        document.getElementById('libraryHeader').style.display='none';
        document.getElementById('openBookView').style.display='flex';
        document.getElementById('bookHeaderTitle').innerText = "üö´ Unknown Words (Kart Modu)";
        startFlashcardMode(); 
        return; 
    }
    
    if(cat === 'favorites') { 
        document.getElementById('libraryGrid').style.display='none';
        document.getElementById('libraryHeader').style.display='none';
        document.getElementById('openBookView').style.display='flex';
        document.getElementById('bookHeaderTitle').innerText = "‚≠ê Favorites (Kart Modu)";
        startFlashcardMode(); 
        return; 
    }
    // -------------------------------------
    
    const s=document.getElementById('mainSearch'); s.value="";
    s.placeholder = (cat==='vocabulary') ? "Kelime Ara..." : "K√ºt√ºphanede Ara...";
    
    if(cat==='analytics') openAnalytics(); else renderLibrary();
}

function renderLibrary(q="") {
    // 1. Ekran Temizliƒüi
    document.getElementById('analyticsView').style.display='none'; 
    document.getElementById('libraryHeader').style.display='flex'; 
    document.getElementById('externalAppView').style.display='none';
    const g=document.getElementById('libraryGrid'); 
    g.innerHTML=''; 
    
    // 2. Veri Filtreleme
    let f=contentData.filter(i=>i.category===currentCategory); 
    if(q) f=f.filter(i=>i.title.toLowerCase().includes(q.toLowerCase()));

    // 3. Sƒ±ralama (A1 -> C2)
    if(currentCategory==='reading' || currentCategory==='question' || currentCategory==='vocabulary'){
        const levels = {"A1":1, "A2":2, "B1":3, "B2":4, "C1":5, "C2":6};
        f.sort((a, b) => {
            const getVal = (t) => { let m = t.match(/\b(A1|A2|B1|B2|C1|C2)\b/i); return m ? levels[m[0].toUpperCase()] : 99; };
            let valA = getVal(a.title); let valB = getVal(b.title);
            if(valA !== valB) return valA - valB; 
            return a.title.localeCompare(b.title, 'tr', {numeric:true});
        });
    }

    // --- G√ñR√úNT√úLEME SENARYOLARI ---
    
    // SENARYO 1: ANA KATEGORƒ∞ G√ñR√úN√úM√ú (Hen√ºz klas√∂r se√ßilmemi≈ü)
    if((currentCategory === 'reading' || currentCategory === 'question' || currentCategory === 'vocabulary') && !q && currentLevelFolder === null) {
        g.className='library-grid'; g.style.display='grid'; // Standart Grid
        
        // Klas√∂rleri Listele
        ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].forEach(lvl => {
            const count = f.filter(i => new RegExp(`\\b${lvl}\\b`, 'i').test(i.title)).length;
            if(count > 0) {
                const folder = document.createElement('div'); folder.className = 'book-card folder-card';
                folder.innerHTML = `<div class="folder-icon">üìÇ</div><div class="folder-info"><div class="book-title">${lvl} Seviyesi</div><div class="folder-count">${count} √ñge</div></div>`;
                folder.onclick = () => { currentLevelFolder = lvl; renderLibrary(); };
                g.appendChild(folder);
            }
        });
        // Klas√∂rs√ºz √∂ƒüeler
        f.forEach(i => { if(!/\b(A1|A2|B1|B2|C1|C2)\b/i.test(i.title)) renderBookCard(i, g); });

    } 
    // SENARYO 2: √ñZEL DASHBOARD G√ñR√úN√úM√ú (Bir seviye klas√∂r√ºne girilmi≈ü)
    else if (currentLevelFolder !== null && !q) {
        g.className = ''; g.style.display = 'block'; // Grid'i kapat
        
        let levelItems = f.filter(i => new RegExp(`\\b${currentLevelFolder}\\b`, 'i').test(i.title));
        
        // ƒ∞statistikler
        let total = levelItems.length;
        let completed = levelItems.filter(i => i.completed).length;
        let percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        // Sƒ±radaki G√∂rev
        let nextTask = levelItems.find(i => !i.completed);
        
        // Orta Kart Metinleri
        let centerTitle = nextTask ? nextTask.title : "üéâ Harika!";
        let centerLabel = nextTask ? "SIRADAKƒ∞ G√ñREV" : "SEVƒ∞YE TAMAMLANDI";
        let centerAction = nextTask ? "BA≈ûLA üöÄ" : "Lƒ∞STEYE G√ñZ AT ‚Ü∫";
        let clickAction = nextTask ? `openBook(contentData.find(x=>x.id=='${nextTask.id}'))` : `openDashList('all')`;

        // DASHBOARD HTML (Senin Tasarƒ±mƒ±n)
        g.innerHTML = `
            <div style="padding:20px; margin-bottom:10px;">
                <button onclick="currentLevelFolder=null; renderLibrary()" class="back-btn">‚¨Ö Seviye Listesine D√∂n</button>
            </div>
            
            <div class="dash-wrapper">
                <div class="dash-stat-box" onclick="openDashList('all')">
                    <div class="dash-stat-title">Toplam Konu</div>
                    <div class="dash-stat-value">${total}</div>
                    <div class="dash-stat-sub">Listeyi G√∂r ‚ò∞</div>
                </div>

                <div class="dash-center-card" onclick="${clickAction}">
                    <div class="dash-center-label">${centerLabel}</div>
                    <div class="dash-center-title">${centerTitle}</div>
                    <div class="dash-center-action">${centerAction}</div>
                </div>

                <div class="dash-stat-box" onclick="openDashList('completed')">
                    <div class="dash-stat-title">Tamamlanan</div>
                    <div class="dash-stat-value">${completed}</div>
                    <div class="dash-stat-sub">%${percent} Tamamlandƒ±</div>
                </div>
            </div>
        `;
        window.tempLevelItems = levelItems; // Listeyi sakla
    } 
    // SENARYO 3: STANDART Lƒ∞STELEME (Arama vb.)
    else {
        g.className='library-grid'; g.style.display='grid';
        f.forEach(i => renderBookCard(i, g)); 
    }

    // Butonlar
    if(currentCategory==='question' && currentLevelFolder === null){ 
        const n=document.createElement('div'); n.className='book-card new-item-card'; n.innerHTML='<div>+ TEST EKLE</div>'; n.onclick=()=>document.getElementById('quickQuizModal').style.display='flex'; g.appendChild(n); 
    }
    if(currentCategory==='notes'){ 
        const n=document.createElement('div'); n.className='book-card new-item-card'; n.innerHTML='<div>+ NOT EKLE</div>'; n.onclick=createNewNote; g.appendChild(n); 
    }
}

// Lƒ∞STE A√áMA FONKSƒ∞YONU
/* --- G√úNCELLENMƒ∞≈û Lƒ∞STE G√ñR√úN√úM√ú (Sƒ∞LME BUTONLU) --- */
function openDashList(type) {
    const modal = document.getElementById('dashListModal');
    const title = document.getElementById('dashListTitle');
    const body = document.getElementById('dashListBody');
    const items = window.tempLevelItems || [];
    
    body.innerHTML = ""; 
    modal.style.display = 'flex'; 

    if (type === 'all') {
        title.innerText = "üìã T√ºm Konular (Y√∂netim)";
        items.forEach(i => {
            let status = i.completed ? '<span style="color:green; font-weight:bold;">‚úî</span>' : '<span style="color:#ccc;">‚≠ï</span>';
            let rowClass = i.completed ? 'dash-list-item done' : 'dash-list-item';
            
            // Satƒ±r HTML'i (Sƒ∞LME BUTONU EKLENDƒ∞)
            body.innerHTML += `
                <div class="${rowClass}" onclick="document.getElementById('dashListModal').style.display='none'; openBook(contentData.find(x=>x.id=='${i.id}'))">
                    <div style="display:flex; gap:10px; align-items:center;">${status} <span>${i.title}</span></div>
                    
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span onclick="deleteItem(event, '${i.id}'); setTimeout(() => openDashList('all'), 100);" 
                              style="cursor:pointer; font-size:1.2rem; color:#ff7675; transition:0.2s;" 
                              onmouseover="this.style.transform='scale(1.2)'" 
                              onmouseout="this.style.transform='scale(1)'"
                              title="Bu i√ßeriƒüi sil">
                              üóëÔ∏è
                        </span>
                        
                        <span style="color:#ccc;">‚ûî</span>
                    </div>
                </div>`;
        });
    } else {
        // TAMAMLANANLAR Lƒ∞STESƒ∞
        title.innerText = "‚úÖ Tamamlananlar";
        let doneItems = items.filter(i => i.completed);
        if(doneItems.length === 0) {
            body.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Hen√ºz tamamlanan konu yok.</div>";
        }
        doneItems.forEach(i => {
            body.innerHTML += `
                <div class="dash-list-item" onclick="document.getElementById('dashListModal').style.display='none'; openBook(contentData.find(x=>x.id=='${i.id}'))">
                    <span style="color:green">‚úî ${i.title}</span> 
                    <span>‚ûî</span>
                </div>`;
        });
    }
}

function renderBookCard(i, container) {
    const d=document.createElement('div'); d.className='book-card';
    if(i.completed) d.classList.add('completed');
    
    let color = "#2c3e50";
    if(currentCategory==='grammar') color="#f1c40f";
    else if(currentCategory==='vocabulary') color = i.title.includes('Idioms') ? "#9b59b6" : (i.title.includes('Phrases') ? "#17a2b8" : "#e74c3c");
    else if(currentCategory==='question' && !i.completed) color="#27ae60";
    else if(currentCategory==='notes') color="#8e44ad";
    
    d.style.borderLeftColor = color;
    d.innerHTML=`<div class="book-title">${i.title}</div><button class="delete-btn" onclick="deleteItem(event,'${i.id}')">&times;</button>`;
    d.onclick=()=>openBook(i); 
    container.appendChild(d);
}

function saveReadingProgress() { 
    if(currentBook && currentCategory === 'reading') { 
        currentBook.readingDuration = (currentBook.readingDuration || 0) + activeReadingSeconds; 
        activeReadingSeconds = 0; 
        saveToDB(); 
    }
}
function saveToDB(){ 
    let i = contentData.findIndex(x => x.id == currentBook.id); 
    if(i !== -1) {
        contentData[i] = currentBook; 
        localStorage.setItem('englishWorkbookData', JSON.stringify(contentData)); 
    }
}
/* --- G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û KAPATMA VE TEMƒ∞ZLƒ∞K --- */
function closeBook() { 
    // 1. SESLENDƒ∞RMEYƒ∞ ZORLA DURDUR
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
    ttsAutoPlay = false;
    ttsObj = null; // Hafƒ±zayƒ± bo≈üalt

    // 2. Dƒ∞NLEMEYƒ∞ VE SAYA√áLARI DURDUR
    stopDictation(); 
    stopReadingTimer(); 
    
    // 3. ƒ∞LERLEMEYƒ∞ KAYDET
    saveReadingProgress(); 
    
    // 4. DEƒûƒ∞≈ûKENLERƒ∞ SIFIRLA (Donmayƒ± √∂nleyen kritik kƒ±sƒ±m)
    bookChunksEn = [];
    bookChunksTr = [];
    currentBook = null;
    pageIndex = 0;

    // 5. WORD MASTER / FLASHCARD TEMƒ∞ZLƒ∞ƒûƒ∞
    if(currentCategory === 'wordmaster' && wmSessionCount > 0) { 
        logActivity('vocab', 'Word Master', `${wmSessionCount} Kelime √áalƒ±≈üƒ±ldƒ±`); 
        wmSessionCount = 0; 
    } 
    if((currentCategory === 'unknowns_flashcard' || currentCategory === 'favorites_flashcard') && fcSessionCount > 0) { 
        logActivity('vocab', 'Flashcard Session', `${fcSessionCount} Kelime √áalƒ±≈üƒ±ldƒ±`); 
        fcSessionCount = 0; 
    } 

    // 6. EKRANI KAPAT VE Lƒ∞STEYƒ∞ A√á
    document.getElementById('openBookView').style.display='none'; 
    document.getElementById('libraryGrid').style.display='grid'; 
    document.getElementById('libraryHeader').style.display='flex'; 
    document.getElementById('mainSearch').value=""; 
    
    // Listeyi yenile (Hata varsa bile ana men√ºye d√∂nmeyi garanti et)
    try {
        if(currentCategory !== 'unknowns') renderLibrary(); 
    } catch(e) {
        console.error("Liste yenileme hatasƒ±:", e);
    }
}
function saveQuickQuiz() {
    let raw=document.getElementById('quickQuizInput').value; if(!raw.trim())return alert("Veri?"); let tm=raw.match(/Ba≈ülƒ±k:\s*(.*)/i); let t=tm?tm[1].trim():"Test "+Date.now(); let cl=raw.replace(/###SORULAR###/g,'').replace(/Ba≈ülƒ±k:.*\n?/g,''); let qb=cl.split(/Q\d+:/).slice(1); let qs=[]; qb.forEach(b=>{ let l=b.trim().split('\n'); let qt=l[0].trim(); let op=[]; let cor="A"; l.forEach(x=>{x=x.trim(); if(/^[A-D]\)/.test(x))op.push(x); if(x.toLowerCase().startsWith('correct:'))cor=x.split(':')[1].trim().toUpperCase();}); if(qt)qs.push({text:qt,options:op,correct:cor}); }); if(!qs.length)return alert("Hata!");
    contentData.push({id:Date.now().toString(), category:'question', title:t, questions:qs, completed: false}); localStorage.setItem('englishWorkbookData', JSON.stringify(contentData)); document.getElementById('quickQuizModal').style.display='none'; document.getElementById('quickQuizInput').value=""; showToast("Test eklendi!"); if(currentCategory==='question') renderLibrary();
}
function stopReadingTimer() { clearInterval(readingTimerInterval); }
function startReadingTimer() {
    clearInterval(readingTimerInterval);
    if(!isTogglingContext) { activeReadingSeconds = 0; currentQuizTime = 0; }
    isTogglingContext = false;
    document.getElementById('liveTimer').innerText = "00:00";
    readingTimerInterval = setInterval(() => {
        if(currentCategory === 'reading' || currentCategory === 'grammar') {
            activeReadingSeconds++;
            updateTimerDisplay(activeReadingSeconds + (currentCategory==='reading' ? (currentBook.readingDuration || 0) : 0)); 
        } else if(currentCategory === 'question') {
            currentQuizTime++;
            updateTimerDisplay(currentQuizTime);
        }
    }, 1000);
}
function updateTimerDisplay(totalSeconds) {
    const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
    const secs = (totalSeconds % 60).toString().padStart(2, '0');
    document.getElementById('liveTimer').innerText = `${mins}:${secs}`;
}
function handleQuickDict(e) {
    if(e.key === 'Enter') {
        let val = document.getElementById('quickDic').value.trim().toLowerCase(); if(!val) return;
        let meaning = getWordMeaning(val);
        if(meaning) alert(`üìñ ${val.toUpperCase()}:\n${meaning}`); 
        else if(confirm(`"${val}" s√∂zl√ºkte yok. Eklemek ister misin?`)) { 
            let def = prompt("Anlamƒ±:"); if(def) toggleUnknown(document.createElement('div'), val, def); 
        }
        document.getElementById('quickDic').value = "";
    }
}
function buildGlobalDictionary() { globalLexicon={}; contentData.filter(i=>i.category==='vocabulary').forEach(b=>{b.words.forEach(w=>globalLexicon[w.en.trim().toLowerCase()]=w.tr);}); }
function getWordMeaning(raw) {
    let w = raw.toLowerCase().replace(/[^a-z]/g,''); if(!w)return null; if(globalLexicon[w])return globalLexicon[w];
    const sfx=["ing","ies","es","ed","ly","er","est","s","d"];
    for(let s of sfx) { if(w.endsWith(s)){ let stem=w.slice(0,-s.length); if(globalLexicon[stem])return globalLexicon[stem]; } } return null;
}
function toggleUnknown(el, word, meaning) {
    if(meaning === 'null' || !meaning) { let userDef = prompt(`"${word}" anlamƒ±?`); if(userDef) meaning = userDef; else return; }
    const index = userUnknownWords.findIndex(u => u.en === word);
    if(index > -1) { 
        userUnknownWords.splice(index, 1); 
        if(el.classList) el.classList.remove('saved'); 
        showToast("√áƒ±karƒ±ldƒ±."); 
    } else { 
        userUnknownWords.push({en: word, tr: meaning}); 
        if(el.classList) el.classList.add('saved'); 
        showToast("Eklendi."); 
    }
    saveToDB(); // YENƒ∞ Sƒ∞STEM: Kullanƒ±cƒ± veritabanƒ±na kaydet
}

function isUnknown(word) { return userUnknownWords.some(u => u.en.toLowerCase() === word.toLowerCase()); }

function closeAdmin(){ document.getElementById('adminModal').style.display='none'; }
// --- G√úNCELLENMƒ∞≈û KAYDETME FONKSƒ∞YONU (√áOKLU Y√úKLEME DESTEKLƒ∞) ---
function saveData() {
    let c = document.getElementById('inputCategory').value;
    let r = document.getElementById('bulkInput').value.trim();
    if (!r) return alert("L√ºtfen veri girin.");

    // --- MOD 1: JSON FORMATI (Yapay Zeka √áƒ±ktƒ±sƒ±) ---
    // [ ile ba≈ülayƒ±p ] ile bitiyorsa
    if (r.startsWith('[') && r.endsWith(']')) {
        try {
            let bulkData = JSON.parse(r);
            if (Array.isArray(bulkData)) {
                let addedCount = 0;
                bulkData.forEach(item => {
                    // ID yoksa veya √ßakƒ±≈üƒ±yorsa yeni ID ver
                    if (!item.id || contentData.some(x => x.id === item.id)) {
                        item.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                    }
                    if (!item.category) item.category = c;
                    item.completed = false; // Yeni i√ßerik okunmadƒ± olarak ba≈ülar
                    
                    contentData.push(item);
                    addedCount++;
                });
                
                saveToDB(); 
                showToast(`S√ºper! ${addedCount} i√ßerik JSON olarak y√ºklendi.`);
                closeAdmin();
                renderLibrary();
                return; // ƒ∞≈ülem bitti
            }
        } catch (e) {
            console.log("JSON deƒüil, metin kontrol ediliyor...");
        }
    }

    // --- MOD 2: MANUEL √áOKLU Y√úKLEME (===YENƒ∞=== Ayracƒ± ile) ---
    // Metinlerin arasƒ±na ===YENƒ∞=== yazarsan hepsini ayrƒ± ayrƒ± ekler
    if (r.includes('===YENƒ∞===')) {
        let blocks = r.split('===YENƒ∞===');
        let count = 0;
        blocks.forEach(block => {
            if(block.trim()) {
                processSingleText(c, block.trim()); // Her par√ßayƒ± i≈üle
                count++;
            }
        });
        
        saveToDB();
        showToast(`${count} adet metin ayrƒ±≈ütƒ±rƒ±lƒ±p eklendi.`);
        closeAdmin();
        renderLibrary();
        return; // ƒ∞≈ülem bitti
    }

    // --- MOD 3: TEKƒ∞L Y√úKLEME (Normal Yapƒ±≈ütƒ±rma) ---
    processSingleText(c, r);
    saveToDB();
    closeAdmin();
    renderLibrary();
}

// --- YARDIMCI FONKSƒ∞YON: Tek bir metin bloƒüunu i≈üler ---
function processSingleText(category, text) {
    // A) Reading ve Quiz Formatƒ± (###SORULAR### varsa)
    if (category === 'reading' && text.includes('###SORULAR###')) {
        let parts = text.split('###SORULAR###');
        let lines = parts[0].trim().split('\n');
        let title = lines[0].trim(); // ƒ∞lk satƒ±r ba≈ülƒ±k
        let body = lines.slice(1).join('\n'); // Gerisi metin

        // 1. Okuma Par√ßasƒ±nƒ± Ekle
        contentData.push({ 
            id: Date.now().toString() + Math.random().toString(36).substr(2, 5), 
            category: 'reading', 
            title: title, 
            enText: body, 
            trText: "", 
            completed: false 
        });

        // 2. Sorularƒ± Ekle
        let qb = parts[1].trim().split(/Q\d+:/).slice(1);
        let qs = [];
        qb.forEach(b => { 
            let l = b.trim().split('\n'); 
            let qt = l[0].trim(); 
            let op = []; 
            let cor = "A"; 
            l.forEach(x => { 
                x = x.trim(); 
                if (/^[A-D]\)/.test(x)) op.push(x); 
                if (x.toLowerCase().startsWith('correct:')) cor = x.split(':')[1].trim().toUpperCase(); 
            }); 
            if (qt) qs.push({ text: qt, options: op, correct: cor }); 
        });

        contentData.push({ 
            id: (Date.now() + 1).toString() + Math.random().toString(36).substr(2, 5), 
            category: 'question', 
            title: title, 
            questions: qs, 
            completed: false 
        });
        
    } 
    // B) Gramer Formatƒ±
    else if (category === 'grammar') {
        let l = text.split('\n'); 
        let ti = null, co = "";
        
        if(/^\d+\./.test(l[0])) ti = l[0].trim();
        else ti = "Gramer - " + Date.now();

        const addGrammar = () => { 
            if (ti) { 
                contentData.push({ 
                    id: Date.now() + Math.random(), 
                    category: 'grammar', 
                    title: ti, 
                    content: co,
                    completed: false
                }); 
            } 
        };
        
        l.forEach(x => { 
            let cx = x.trim(); 
            if (/^\d+\./.test(cx)) { 
                if(co !== "") addGrammar(); 
                ti = cx; 
                co = `<h3>${cx}</h3>`; 
            } else if (cx) { 
                if (/^(Gramer|√ñrnek)/.test(cx)) co += `<span class="highlight-header">${cx}</span>`; 
                else if (cx.startsWith('¬∑')) co += `<li>${cx.replace('¬∑', '')}</li>`; 
                else co += `<p>${cx}</p>`; 
            } 
        }); 
        addGrammar(); 
    } 
    // C) Basit Format (Sadece Metin)
    else {
        let titleInput = document.getElementById('inputTitle');
        let title = (titleInput && titleInput.value) ? titleInput.value : "ƒ∞√ßerik " + Date.now();
        
        contentData.push({ 
            id: Date.now().toString() + Math.random().toString(36).substr(2, 5), 
            category: category, 
            title: title, 
            content: text, 
            enText: text, 
            completed: false 
        });
    }
}

function removeDuplicates() {
    if(!confirm("Yinelenen i√ßerikler temizlensin mi?")) return;
    const unique = []; const map = new Map();
    // Title ve Category aynƒ±ysa yinelenen say
    contentData.forEach(item => { 
        let key = item.title + '|' + item.category;
        if(!map.has(key)){ 
            map.set(key, true); 
            unique.push(item); 
        }
    });
    contentData = unique;
    saveToDB(); // DOƒûRU KAYIT
    showToast("Temizlendi!"); setTimeout(() => location.reload(), 1000);
}

function clearGameLogs() {
    if(!confirm("Ge√ßmi≈üteki t√ºm 'External Game' (Oyun) puanlarƒ± ve kayƒ±tlarƒ± silinsin mi?")) return;
    
    // Sadece external_game olmayanlarƒ± tut
    userActivityLog = userActivityLog.filter(log => log.type !== 'external_game');
    saveToDB(); // DOƒûRU KAYIT
    
    showToast("Oyun ge√ßmi≈üi silindi!");
    setTimeout(() => location.reload(), 1000);
}
function createNewNote() { contentData.push({id:Date.now().toString(),category:'notes',title:'Yeni Not',pages:["",""], styles:[]}); localStorage.setItem('englishWorkbookData',JSON.stringify(contentData)); openBook(contentData[contentData.length-1]); }

function deleteItem(e, id) {
    e.stopPropagation(); // Karta tƒ±klamayƒ± engelle (kitabƒ± a√ßmasƒ±n)
    
    // 1. Onay ƒ∞ste
    if (confirm("Dƒ∞KKAT: Bu i√ßeriƒüi (Reading/Test) kalƒ±cƒ± olarak silmek istiyor musunuz?\n\n(Bu i≈ülem geri alƒ±namaz!)")) {
        
        // 2. ƒ∞√ßeriƒüi Listeden √áƒ±kar
        contentData = contentData.filter(x => x.id !== id);
        
        // 3. YENƒ∞ Sƒ∞STEME G√ñRE KAYDET (Kritik Nokta)
        saveToDB(); 
        
        // 4. Ekranƒ± Yenile
        renderLibrary();
        
        // 5. Bilgi Ver
        showToast("ƒ∞√ßerik kalƒ±cƒ± olarak silindi.", true);
    }
}
function setupVoice() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR(); recognition.interimResults=false; recognition.continuous=false;
        recognition.onresult = function(e) { const t=e.results[0][0].transcript; const el=document.getElementById(currentTargetId); if(el){el.value+=(el.value.length>0?" ":"")+t; el.dispatchEvent(new Event('input'));} stopDictation(); };
        recognition.onend = function(){stopDictation();};
    }
}
function toggleDictation(id, lang) { if(!recognition)return alert("Desteklenmiyor"); const btn=document.getElementById(`mic-${lang}-${id}`); if(isListening)stopDictation(); else { currentTargetId=id; recognition.lang=(lang==='tr')?'tr-TR':'en-US'; recognition.start(); isListening=true; if(btn)btn.classList.add('listening'); } }
function stopDictation(){ if(isListening&&recognition){recognition.stop(); isListening=false; document.querySelectorAll('.mic-btn').forEach(b=>b.classList.remove('listening'));} }
function addPageToNote(){ currentBook.pages.push("",""); saveToDB(); pageIndex=currentBook.pages.length-2; renderSpread(); }
function saveTopicNote(v){ if(currentBook){currentBook.userNotes=v; trackStat('notesTaken'); saveToDB();} }
function saveMyPage(idx,val){ currentBook.pages[idx]=val; saveToDB(); }
function saveNoteTitle(val){ currentBook.title=val; saveToDB(); }
function clearCategoryData(){ if(confirm("Sil?")){contentData=contentData.filter(i=>i.category!==document.getElementById('inputCategory').value); localStorage.setItem('englishWorkbookData',JSON.stringify(contentData)); switchCategory(currentCategory);} }
function exportData() {
    // DOƒûRUDAN CANLI VERƒ∞Yƒ∞ AL (Localstorage'dan okuma)
    const data = { 
        data: JSON.stringify(contentData), 
        stats: JSON.stringify(userStats), 
        unknowns: JSON.stringify(userUnknownWords), 
        knowns: JSON.stringify(userKnownVocabulary), 
        favorites: JSON.stringify(userFavorites),
        activityLog: JSON.stringify(userActivityLog)
    };
    
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); 
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `EnglishPro_Yedek_${new Date().toLocaleDateString()}.json`; 
    document.body.appendChild(a); 
    a.click(); 
    document.body.removeChild(a); 
    showToast("G√ºncel Veriler Yedeklendi!");
}

/* --- V39.0 TEXT-STREAM TTS MOTORU (SES GARANTƒ∞Lƒ∞) --- */
/* Y√∂ntem: DOM yapƒ±sƒ±nƒ± yoksay -> Saf metni al -> Par√ßala -> Oku */

let ttsQueue = [];
let ttsCurrentIndex = 0;
let isTTSActive = false;
let ttsWaitTimer = null;
let globalSpanCounter = 0; // Highlight senkronizasyonu i√ßin

// ‚õî DURAKLAMA S√úRELERƒ∞
const PAUSE_COMMA = 100;   // 0.1 Saniye
const PAUSE_DOT = 300;    // 0.3 Saniye

function handleTTS(action) {
    if (!('speechSynthesis' in window)) return alert("Tarayƒ±cƒ± desteklemiyor.");
    const pauseBtn = document.getElementById('ttsPauseBtn');

    // 1. DURAKLAT / DEVAM ET
    if (action === 'pause') {
        if (isTTSActive) {
            window.speechSynthesis.cancel();
            clearTimeout(ttsWaitTimer);
            isTTSActive = false;
            if(pauseBtn) { pauseBtn.innerHTML = "‚ñ∂"; pauseBtn.classList.add('paused'); }
        } else {
            isTTSActive = true;
            if(pauseBtn) { pauseBtn.innerHTML = "‚è∏"; pauseBtn.classList.remove('paused'); }
            forcePlayNextChunk();
        }
        return;
    }

    // 2. YENƒ∞DEN BA≈ûLAT
    if (action === 'restart') {
        // Sistemi Sƒ±fƒ±rla
        window.speechSynthesis.cancel();
        clearTimeout(ttsWaitTimer);
        ttsQueue = [];
        ttsCurrentIndex = 0;
        isTTSActive = true;
        globalSpanCounter = 0; // Highlight sayacƒ±nƒ± sƒ±fƒ±rla

        if(pauseBtn) { pauseBtn.innerHTML = "‚è∏"; pauseBtn.classList.remove('paused'); }

        const container = document.getElementById('pageLeft');
        
        // A) METNƒ∞ AL VE TEMƒ∞ZLE
        // Buton yazƒ±larƒ±nƒ± ve gereksiz etiketleri metinden √ßƒ±kar
        let rawText = container.innerText
            .replace(/‚úî KONUYU TAMAMLA|‚úÖ OKUMAYI TAMAMLA|üîÑ Tekrar Okudum|üß† ƒ∞LGƒ∞Lƒ∞ TESTƒ∞|‚Ü∫ ƒ∞LGƒ∞Lƒ∞ TESTƒ∞|üîä|‚òÖ/gi, "")
            .replace(/\s+/g, " ") // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa indir
            .trim();

        if (!rawText) return alert("Okunacak metin bulunamadƒ±!");

        // B) METNƒ∞ PAR√áALA (Regex: Noktalama i≈üaretlerini ayƒ±rƒ±cƒ± olarak kullan ama onlarƒ± da tut)
        // Bu regex metni ≈üuna b√∂ler: ["Hello", ",", " how are you", "?", " I am fine", ".", ""]
        let parts = rawText.split(/([,;:.?!])/g);

        // C) KUYRUƒûU OLU≈ûTUR
        let tempText = "";
        
        for (let i = 0; i < parts.length; i++) {
            let part = parts[i];
            
            // Eƒüer bu par√ßa bir noktalama i≈üaretiyse
            if ([',', ';', '.', '?', '!', ':'].includes(part)) {
                // Hangi duraklama?
                let delay = ['.', '?', '!', ':'].includes(part) ? PAUSE_DOT : PAUSE_COMMA;
                
                // Tamponda metin varsa i≈üareti ona ekle ve kuyruƒüa at
                if (tempText.trim()) {
                    ttsQueue.push({
                        text: tempText + part, 
                        delay: delay
                    });
                    tempText = ""; // Tamponu bo≈üalt
                }
            } else {
                // Metinse tampona ekle
                tempText += part;
            }
        }
        
        // Kalan son par√ßa varsa ekle (Noktalama yoksa)
        if (tempText.trim()) {
            ttsQueue.push({ text: tempText, delay: 0 });
        }

        // Okumayƒ± Tetikle
        forcePlayNextChunk();
    }
}

function forcePlayNextChunk() {
    if (!isTTSActive) return;

    // Kuyruk Bitti mi?
    if (ttsCurrentIndex >= ttsQueue.length) {
        isTTSActive = false;
        const pauseBtn = document.getElementById('ttsPauseBtn');
        if(pauseBtn) { pauseBtn.innerHTML = "‚ñ∂"; pauseBtn.classList.add('paused'); }
        // Highlight temizle
        document.querySelectorAll('.highlight-word').forEach(el => {
            el.classList.remove('highlight-word');
            el.style.backgroundColor = ""; el.style.color = "";
        });
        return;
    }

    const item = ttsQueue[ttsCurrentIndex];
    if (!item || !item.text) { 
        ttsCurrentIndex++; 
        forcePlayNextChunk(); 
        return; 
    }

    const u = new SpeechSynthesisUtterance(item.text);

    // AYARLAR
    const speedEl = document.getElementById('ttsSpeed');
    u.rate = speedEl ? parseFloat(speedEl.value) : 0.9;
    u.lang = (typeof isTrMode !== 'undefined' && isTrMode) ? 'tr-TR' : 'en-US';

    // --- BASƒ∞TLE≈ûTƒ∞Rƒ∞LMƒ∞≈û HIGHLIGHT Sƒ∞STEMƒ∞ ---
    // DOM e≈üle≈ütirmesi hataya a√ßƒ±k olduƒüu i√ßin, sƒ±rayla gidiyoruz.
    // Metin okunurken sayfadaki 'interactive-word' spanlarƒ±nƒ± sƒ±rasƒ±yla boyar.
    const allSpans = document.getElementById('pageLeft').querySelectorAll('.interactive-word');
    
    u.onboundary = (e) => {
        if (e.name === 'word') {
            // Eskileri temizle
            document.querySelectorAll('.highlight-word').forEach(el => {
                el.classList.remove('highlight-word');
                el.style.backgroundColor = ""; el.style.color = "";
            });

            // Global sayacƒ± kullanarak sƒ±radaki span'ƒ± bul
            if (globalSpanCounter < allSpans.length) {
                let s = allSpans[globalSpanCounter];
                
                // Basit bir kontrol: Okunan kelime ile span i√ßeriƒüi uyu≈üuyor mu? (Opsiyonel ama g√ºvenli)
                // ≈ûimdilik sadece sƒ±rayla gidiyoruz, bu en g√ºvenli y√∂ntemdir.
                
                s.classList.add('highlight-word');
                s.style.backgroundColor = "#f1c40f"; 
                s.style.color = "#000";
                
                // G√∂r√º≈ü alanƒ±na getir
                s.scrollIntoView({behavior: "smooth", block: "center"});
                
                globalSpanCounter++;
            }
        }
    };

    // --- ZORUNLU BEKLEME ---
    u.onend = () => {
        if (!isTTSActive) return;

        // Okuma bitti. Belirlenen s√ºre kadar BEKLE.
        let wait = item.delay || 50;

        ttsWaitTimer = setTimeout(() => {
            ttsCurrentIndex++;
            forcePlayNextChunk();
        }, wait);
    };

    u.onerror = (e) => {
        console.log("TTS Error, skipping...", e);
        ttsWaitTimer = setTimeout(() => { ttsCurrentIndex++; forcePlayNextChunk(); }, 100);
    };

    window.speechSynthesis.speak(u);
}

function getFormattedTime(seconds) { const m = Math.floor(seconds / 60); const s = Math.round(seconds % 60); return `${m}dk ${s}sn`; }
/* --- EKSƒ∞K FONKSƒ∞YON D√úZELTMESƒ∞ (ADMIN) --- */
function openAdmin() {
    document.getElementById('adminModal').style.display = 'flex';
    document.getElementById('bulkInput').value = ""; // Temiz a√ß
}
/* --- USER MANAGEMENT SYSTEM (NEW PAGE) --- */

// 1. Data Manager (Sadece Veri Y√ºkleme)
function openAdmin() {
    document.getElementById('adminModal').style.display = 'flex';
    document.getElementById('bulkInput').value = ""; 
}

// 2. Kullanƒ±cƒ±lar Sayfasƒ±nƒ± A√ß
function openUserPanel() {
    document.getElementById('userManagementModal').style.display = 'flex';
    renderUserList();
}

// 3. Listeyi Olu≈ütur (Arama ve ƒ∞statistik Dahil)
function renderUserList(filter = "") {
    const container = document.getElementById('userListArea');
    const statsHeader = document.getElementById('userStatsHeader');
    
    if(!masterDB) { container.innerHTML = "Veritabanƒ± hatasƒ±."; return; }

    let totalUsers = 0;
    let totalReads = 0;
    let tableHtml = `
    <table class="user-table" style="width:100%; border-collapse:collapse;">
        <thead>
            <tr style="background:#f8f9fa; text-align:left;">
                <th style="padding:15px; border-radius:10px 0 0 10px;">Kullanƒ±cƒ±</th>
                <th style="padding:15px;">Durum</th>
                <th style="padding:15px;">Toplam Puan</th>
                <th style="padding:15px;">ƒ∞lerleme</th>
                <th style="padding:15px; border-radius:0 10px 10px 0;">ƒ∞≈ülem</th>
            </tr>
        </thead>
        <tbody>
    `;

    for (let username in masterDB) {
        // Arama Filtresi
        if(filter && !username.toLowerCase().includes(filter.toLowerCase())) continue;

        totalUsers++;
        let uData = masterDB[username].data;
        let isMe = (username === currentUser);
        let isAdmin = (username === 'admin');
        
        // ƒ∞statistikler
        let score = 0;
        if(uData.userActivityLog) uData.userActivityLog.forEach(l => { score += (Number(l.points) || 0); });
        
        // Hata d√ºzeltmesi: Tek satƒ±rda kontrol
        let books = (uData.userStats && uData.userStats.booksRead) ? uData.userStats.booksRead : 0;
        if(books > 0) totalReads += books;

        let badge = isAdmin ? '<span style="background:#ffeaa7; color:#d35400; padding:3px 8px; border-radius:10px; font-size:0.8rem; font-weight:bold;">Admin</span>' : '<span style="background:#dfe6e9; color:#636e72; padding:3px 8px; border-radius:10px; font-size:0.8rem;">√úye</span>';
        
        // Admin kendini silemez, diƒüerlerini silebilir
        let delBtn = isAdmin ? '' : `<button onclick="deleteUser('${username}')" style="background:#fab1a0; color:#c0392b; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">Sil</button>`;

        tableHtml += `
            <tr style="border-bottom:1px solid #f1f2f6; ${isMe ? 'background:#f0fdf4;' : ''}">
                <td style="padding:15px;"><strong>${username}</strong> ${isMe ? '(Sen)' : ''}</td>
                <td style="padding:15px;">${badge}</td>
                <td style="padding:15px; color:#27ae60; font-weight:bold;">‚≠ê ${score}</td>
                <td style="padding:15px; color:#2980b9;">üìö ${books} Kitap</td>
                <td style="padding:15px;">${delBtn}</td>
            </tr>
        `;
    }
    tableHtml += `</tbody></table>`;
    container.innerHTML = tableHtml;

    // √úst Bilgi Kartlarƒ±nƒ± G√ºncelle
    statsHeader.innerHTML = `
        <div style="flex:1; background:#2980b9; color:white; padding:20px; border-radius:15px; text-align:center;">
            <div style="font-size:2rem; font-weight:800;">${totalUsers}</div>
            <div style="font-size:0.9rem; opacity:0.8;">Toplam Kullanƒ±cƒ±</div>
        </div>
        <div style="flex:1; background:#27ae60; color:white; padding:20px; border-radius:15px; text-align:center;">
            <div style="font-size:2rem; font-weight:800;">${totalReads}</div>
            <div style="font-size:0.9rem; opacity:0.8;">Toplam Okunan Kitap</div>
        </div>
    `;
}

function deleteUser(username) {
    if(confirm(`UYARI: "${username}" kullanƒ±cƒ±sƒ± ve t√ºm verileri silinecek!\n\nBu i≈ülem geri alƒ±namaz. Emin misin?`)) {
        delete masterDB[username];
        saveMasterDB();
        showToast(`${username} silindi.`);
        renderUserList(); // Listeyi yenile
    }
}
/* 2. BA≈ûLATMA (HATA KORUMALI G√úVENLƒ∞ MOD) */
window.onload = function() { 
    try {
        console.log("Sistem ba≈ülatƒ±lƒ±yor...");
        
        // 1. G√úVENLƒ∞K Kƒ∞Lƒ∞Dƒ∞: Veritabanƒ± silinmi≈üse bo≈ü olu≈ütur (Tu≈ülarƒ±n kaybolmasƒ±nƒ± √∂nler)
        if(!localStorage.getItem('EnglishProMasterDB')) {
            console.log("Veritabanƒ± bulunamadƒ±, yenisi olu≈üturuluyor...");
            const defaultDB = { 'admin': { pass: 'mkutlu2108', data: defaultUserData } };
            localStorage.setItem('EnglishProMasterDB', JSON.stringify(defaultDB));
        }

        initSystem(); 
        setupVoice(); 
        
        // --- OTOMATƒ∞K Gƒ∞Rƒ∞≈û ---
        const defaultUser = 'admin';
        
        // Admin kullanƒ±cƒ±sƒ± yoksa olu≈ütur
        if (!masterDB[defaultUser]) {
            initSystem(); 
        }

        currentUser = defaultUser;
        loadUserData(defaultUser);
        
        // Login ekranƒ±nƒ± kaldƒ±r
        const overlay = document.getElementById('loginOverlay');
        if(overlay) overlay.style.display = 'none';
        
        // Men√ºleri ve Tu≈ülarƒ± Zorla A√ß
        const adminSec = document.getElementById('adminSection');
        if(adminSec) adminSec.style.display = 'block';

        buildGlobalDictionary();
        switchCategory('reading');
        renderLibrary();
        
        console.log("Sistem ba≈üarƒ±yla ve hatasƒ±z a√ßƒ±ldƒ±.");
        
    } catch (e) {
        console.error("KRƒ∞Tƒ∞K BA≈ûLATMA HATASI:", e);
        alert("Sistem a√ßƒ±lƒ±rken bir hata oldu: " + e.message + "\n\nL√ºtfen sayfayƒ± yenileyin.");
    }
};
/* --- YENƒ∞ √ñZELLƒ∞K: T√úM READING SETLERƒ∞Nƒ∞ TXT OLARAK DI≈ûA AKTAR --- */
function exportSmartTXT() {
    // 1. Sadece Reading olanlarƒ± √ßek
    const readings = contentData.filter(x => x.category === 'reading');
    
    if (readings.length === 0) return alert("Sistemde hi√ß reading kaydƒ± yok!");

    let fullOutput = "";

    // 2. D√∂ng√ºye Ba≈üla
    readings.forEach(r => {
        // A) BA≈ûLIK
        fullOutput += `${r.title}\n\n`;

        // B) ƒ∞NGƒ∞Lƒ∞ZCE METƒ∞N (HTML etiketlerini temizle, paragraf yap)
        let enClean = r.enText
            .replace(/<\/p>|<br>/gi, '\n') // Paragraf sonlarƒ±nƒ± alt satƒ±ra al
            .replace(/<[^>]+>/g, '')       // Diƒüer HTML etiketlerini sil
            .trim();
        fullOutput += `${enClean}\n\n`;

        // C) AYRA√á
        fullOutput += `---\n\n`;

        // D) T√úRK√áE √áEVƒ∞Rƒ∞ BA≈ûLIƒûI
        fullOutput += `[T√ºrk√ße √áeviri]\n\n`;

        // E) T√úRK√áE METƒ∞N
        let trClean = (r.trText || "")
            .replace(/<\/p>|<br>/gi, '\n')
            .replace(/<[^>]+>/g, '')
            .trim();
        fullOutput += `${trClean}\n\n`;

        // F) SORULAR (E≈üle≈üen Quiz'i Bul)
        // Ba≈ülƒ±ƒüƒ± aynƒ± olan 'question' kategorisindeki veriyi arƒ±yoruz
        const quiz = contentData.find(q => q.category === 'question' && q.title.trim() === r.title.trim());

        if (quiz && quiz.questions && quiz.questions.length > 0) {
            fullOutput += `###SORULAR###\n`;
            fullOutput += `Ba≈ülƒ±k: ${r.title}\n\n`; // Import formatƒ±na uygun olmasƒ± i√ßin

            quiz.questions.forEach((q, idx) => {
                fullOutput += `Q${idx + 1}: ${q.text}\n`;
                // ≈ûƒ±klarƒ± ekle
                q.options.forEach(opt => {
                    fullOutput += `${opt}\n`;
                });
                // Doƒüru cevabƒ± ekle
                fullOutput += `Correct: ${q.correct}\n\n`;
            });
        }

        // G) SET SONU AYRACI (KRƒ∞Tƒ∞K KISIM)
        fullOutput += `===YENƒ∞===\n\n`;
    });

    // 3. Dosyayƒ± ƒ∞ndir
    const blob = new Blob([fullOutput], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TUM_READING_SETI_(${readings.length}_Adet).txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
        showToast(`${readings.length} adet set ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±!`);
}
/* --- EKSƒ∞K OLAN IMPORT FONKSƒ∞YONU --- */
/* --- D√úZENLEME FONKSƒ∞YONLARI --- */
function openEditContent() {
    if(!currentBook) return;
    
    document.getElementById('editTitle').value = currentBook.title;
    document.getElementById('editEn').value = currentBook.enText || (currentBook.content || "");
    document.getElementById('editTr').value = currentBook.trText || "";
    
    // Sorularƒ± Metne √áevir (Parse)
    let qText = "";
    if(currentBook.questions && currentBook.questions.length > 0) {
        currentBook.questions.forEach((q, i) => {
            qText += `Q${i+1}: ${q.text}\n`;
            q.options.forEach(opt => qText += `${opt}\n`);
            qText += `Correct: ${q.correct}\n\n`;
        });
    } else {
        // Eƒüer reading i√ßindeysek ama sorularƒ± ba≈üka bir objede tutuyorsak onu bul
        let linkedQuiz = contentData.find(q => q.category === 'question' && q.title.trim() === currentBook.title.trim());
        if(linkedQuiz && linkedQuiz.questions) {
            linkedQuiz.questions.forEach((q, i) => {
                qText += `Q${i+1}: ${q.text}\n`;
                q.options.forEach(opt => qText += `${opt}\n`);
                qText += `Correct: ${q.correct}\n\n`;
            });
        }
    }
    document.getElementById('editQuestions').value = qText;
    
    document.getElementById('editContentModal').style.display = 'flex';
}

function saveEditedContent() {
    if(!currentBook) return;
    
    // 1. Temel Verileri G√ºncelle
    currentBook.title = document.getElementById('editTitle').value;
    currentBook.enText = document.getElementById('editEn').value;
    currentBook.trText = document.getElementById('editTr').value;
    currentBook.content = currentBook.enText; // ƒ∞√ßerik uyumluluƒüu i√ßin
    
    // 2. Sorularƒ± Geri D√∂n√º≈üt√ºr (Reverse Parse)
    let qRaw = document.getElementById('editQuestions').value.trim();
    let newQuestions = [];
    
    if(qRaw) {
        let qBlocks = qRaw.split(/Q\d+:/).slice(1);
        qBlocks.forEach(b => {
            let lines = b.trim().split('\n');
            let qt = lines[0].trim();
            let op = [];
            let cor = "A";
            lines.forEach(x => {
                x = x.trim();
                if(/^[A-D]\)/.test(x)) op.push(x);
                if(x.toLowerCase().startsWith('correct:')) cor = x.split(':')[1].trim().toUpperCase();
            });
            if(qt) newQuestions.push({text: qt, options: op, correct: cor});
        });
    }

    // 3. Sorularƒ± Kaydet (Reading i√ßindeyse veya Question ise)
    if(currentCategory === 'question') {
        currentBook.questions = newQuestions;
    } else {
        // Reading modundaysak, baƒülƒ± olan Quiz'i bul ve g√ºncelle
        let linkedQuiz = contentData.find(q => q.category === 'question' && q.title.trim() === currentBook.title.trim());
        if(linkedQuiz) {
            linkedQuiz.questions = newQuestions;
            // Eƒüer ba≈ülƒ±k deƒüi≈ütiyse quiz ba≈ülƒ±ƒüƒ±nƒ± da g√ºncelle
            linkedQuiz.title = currentBook.title;
        } else if(newQuestions.length > 0) {
            // Quiz yoksa ama soru eklendiyse yeni quiz olu≈ütur
            contentData.push({
                id: Date.now().toString(),
                category: 'question',
                title: currentBook.title,
                questions: newQuestions,
                completed: false
            });
        }
    }

    saveToDB();
    document.getElementById('editContentModal').style.display = 'none';
    showToast("ƒ∞√ßerik Ba≈üarƒ±yla G√ºncellendi!");
    
    // Sayfayƒ± yenile (Deƒüi≈üiklikleri g√∂ster)
    // Biraz bekleyip yeniden a√ßƒ±yoruz ki veriler otursun
    setTimeout(() => openBook(currentBook), 100);
}

function importData(input) {
    const file = input.files[0]; 
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // Dosyayƒ± oku (Hem eski hem yeni formatƒ± destekle)
            let json;
            try { json = JSON.parse(e.target.result); } catch (parseErr) { return alert("Dosya hatalƒ±!"); }
            
            if(!currentUser) return alert("L√ºtfen giri≈ü yapƒ±n.");
            const d = masterDB[currentUser].data;

            // Veriyi g√ºvenli y√ºkle
            const safeLoad = (val) => {
                if (typeof val === 'string') { try { return JSON.parse(val); } catch(err) { return []; } }
                return val || [];
            };

            if (Array.isArray(json)) { d.contentData = json; } // Eski Format
            else if (typeof json === 'object') { // Yeni Format
                if (json.data) d.contentData = safeLoad(json.data);
                else if (json.contentData) d.contentData = safeLoad(json.contentData);
                
                if (json.stats) d.userStats = safeLoad(json.stats);
                if (json.unknowns) d.userUnknownWords = safeLoad(json.unknowns);
                if (json.knowns) d.userKnownVocabulary = safeLoad(json.knowns);
                if (json.favorites) d.userFavorites = safeLoad(json.favorites);
                if (json.activityLog) d.userActivityLog = safeLoad(json.activityLog);
            }

            saveMasterDB();
            buildGlobalDictionary();
            showToast("Yedek ba≈üarƒ±yla y√ºklendi!");
            setTimeout(() => location.reload(), 1000); // Sayfayƒ± yenile

        } catch(err) { 
            console.error(err); alert("Y√ºkleme hatasƒ±: " + err.message); 
        }
    }; 
    input.value = ''; 
    reader.readAsText(file);
}
/* --- OTOMATƒ∞K KAYIT VE G√úVENLƒ∞K Sƒ∞STEMƒ∞ --- */

// 1. PERƒ∞YODƒ∞K OTOMATƒ∞K KAYIT (Her 5 Saniyede Bir)
setInterval(function() {
    if (currentUser && masterDB[currentUser]) {
        saveToDB(); // Veriyi LocalStorage'a i≈üle
        
        // Opsiyonel: Konsola bilgi ver (Geli≈ütirici ara√ßlarƒ±nda g√∂r√ºn√ºr)
        // console.log("Otomatik kayƒ±t yapƒ±ldƒ±: " + new Date().toLocaleTimeString());
        
        // G√∂rsel Geri Bildirim (Saƒü alt k√∂≈üede k√º√ß√ºk bir yanƒ±p s√∂nme)
        let indicator = document.getElementById('autoSaveIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'autoSaveIndicator';
            indicator.style.position = 'fixed';
            indicator.style.bottom = '10px';
            indicator.style.right = '10px';
            indicator.style.width = '10px';
            indicator.style.height = '10px';
            indicator.style.borderRadius = '50%';
            indicator.style.backgroundColor = '#27ae60'; // Ye≈üil
            indicator.style.zIndex = '9999';
            indicator.style.transition = 'opacity 0.5s';
            indicator.style.opacity = '0';
            indicator.title = "Otomatik Kayƒ±t Aktif";
            document.body.appendChild(indicator);
        }
        
        // I≈üƒ±ƒüƒ± yak ve s√∂nd√ºr
        indicator.style.opacity = '1';
        setTimeout(() => { indicator.style.opacity = '0.2'; }, 1000);
    }
}, 5000); // 5000 ms = 5 saniye

// 2. CTRL + S KISAYOLU (Manuel Yedekleme ƒ∞ndir)
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault(); // Tarayƒ±cƒ±nƒ±n standart kaydetme penceresini engelle
        showToast("üíæ Hƒ±zlƒ± Yedekleme Ba≈ülatƒ±ldƒ±...");
        exportData(); // Bizim yedekleme fonksiyonunu √ßalƒ±≈ütƒ±r
    }
});

// 3. √áIKI≈û UYARISI (Sayfa Kapanƒ±rken Uyar)
window.onbeforeunload = function(e) {
    // Eƒüer sayfayƒ± yeniliyorsanƒ±z veya kapatƒ±yorsanƒ±z bu uyarƒ± √ßƒ±kar
    const confirmationMessage = 'Yaptƒ±ƒüƒ±nƒ±z deƒüi≈üiklikleri "Data Manager" √ºzerinden indirdiniz mi? ƒ∞ndirilmemi≈ü veriler ba≈üka bilgisayara ta≈üƒ±namaz.';
    
    (e || window.event).returnValue = confirmationMessage; // Eski tarayƒ±cƒ±lar i√ßin
    return confirmationMessage;
};
/* --- YENƒ∞ EKLENEN: DATA.JS √áIKTI ALMA TU≈ûU --- */
function downloadDataJsFormat() {
    if (!contentData || contentData.length === 0) {
        alert("Dƒ±≈üa aktarƒ±lacak veri yok! √ñnce i√ßerik ekleyin.");
        return;
    }
    // Veriyi data.js formatƒ±na √ßeviriyoruz
    const jsContent = "const systemContent = " + JSON.stringify(contentData, null, 4) + ";";
    
    // Dosyayƒ± olu≈üturuyoruz
    const blob = new Blob([jsContent], { type: 'text/javascript;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'data.js'; // Dosya adƒ± data.js olacak
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast("data.js dosyasƒ± indirildi!");
}
/* ------------------------------------------- */
</script>
</body>
</html>