<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ENGLISH LEARNING PRO HUB - V35.0 (STABLE SINGLE FILE)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* --- STYLE SYSTEM V31.0 ULTIMATE --- */
:root {
    --bg-body: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --primary: #2c3e50; 
    --secondary: #34495e;
    --accent: #2980b9; 
    --accent-grad: linear-gradient(to right, #2980b9, #6dd5fa); 
    --card-bg: #ffffff; 
    --text-color: #2d3436; 
    --success: #27ae60;
    --error: #c0392b;
    --warn: #f1c40f; 
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
    --shadow-hover: 0 15px 40px rgba(0,0,0,0.15);
    --font-main: 'Poppins', sans-serif;
}

* { box-sizing: border-box; outline: none; }

body { 
    margin: 0; padding: 0; 
    background: var(--bg-body); 
    height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    font-family: var(--font-main); 
    color: var(--text-color); 
    overflow: hidden; 
}

.app-container { 
    display: flex; width: 96%; max-width: 1700px; height: 95vh; 
    background: var(--card-bg); border-radius: 30px; box-shadow: var(--shadow); 
    overflow: hidden; border: none; 
}

/* SIDEBAR */
.sidebar { 
    width: 260px; background: var(--primary); display: flex; flex-direction: column; 
    padding: 25px 20px; gap: 10px; color: #ecf0f1; flex-shrink: 0; z-index: 20; 
    overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar::-webkit-scrollbar { width: 5px; } 
.sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 5px; }

.sidebar h2 { 
    font-family: var(--font-main); text-align: center; color: #fff; 
    border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin: 0 0 10px 0; 
    font-size: 1.5rem; font-weight: 700; letter-spacing: 1px;
}

.quick-dict-box { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 12px; margin-bottom: 10px; flex-shrink: 0; }
.quick-dict-input { width: 100%; background: transparent; border: none; color: #fff; font-family: var(--font-main); font-size: 0.9rem; }
.quick-dict-input::placeholder { color: rgba(255,255,255,0.6); }

.nav-btn { 
    background: transparent; border: none; color: rgba(255,255,255,0.7); 
    font-family: var(--font-main); font-size: 0.95rem; font-weight: 500; 
    padding: 12px 15px; border-radius: 12px; cursor: pointer; text-align: left; 
    transition: all 0.3s; display: flex; align-items: center; gap: 12px; flex-shrink: 0; 
}
.nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.15); color: #fff; transform: translateX(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: 600; }
.nav-btn[onclick="exportData()"] { background: var(--success) !important; border-radius: 50px; justify-content: center; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); margin-top: 15px; font-weight: bold;}
.admin-btn { margin-top: 5px; background: rgba(231, 76, 60, 0.2); color: #e74c3c; border-radius: 20px; justify-content: center; }
.admin-btn:hover { background: rgba(231, 76, 60, 0.4); color: white; }
.spacer { flex-grow: 1; min-height: 10px; }

/* WORKBOOK AREA */
.workbook-area { flex: 1; position: relative; background: #f4f6f8; display: flex; flex-direction: column; overflow: hidden; }

.library-header { padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.03); z-index: 5; }
.main-search-input { width: 100%; max-width: 600px; padding: 12px 20px; border-radius: 12px; border: 1px solid #dfe6e9; font-family: var(--font-main); font-size: 1rem; outline: none; background: #fff; color: var(--text-color); transition: 0.3s; }
.main-search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1); }

.library-grid { flex: 1; overflow-y: auto; padding: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; align-content: start; }
.library-grid.list-mode { display: flex; flex-direction: column; gap: 10px; }

.book-card { background: #fff; border-radius: 15px; padding: 20px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #f1f2f6; border-left: 5px solid var(--accent); height: 120px; display: flex; flex-direction: column; justify-content: center; position: relative; transition: transform 0.2s, box-shadow 0.2s; }
.book-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
.book-card.completed { border-left-color: var(--success) !important; background-color: #f0fdf4; }
.book-card.completed::after { content: '‚úî'; position: absolute; top: 10px; right: 10px; color: var(--success); font-size: 1.2em; font-weight: bold; background: rgba(39, 174, 96, 0.1); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;}
.book-title { font-family: var(--font-main); font-weight: 600; color: var(--text-color); font-size: 1rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.folder-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-left: 5px solid #3498db !important; align-items: center; text-align: center; }
.folder-icon { font-size: 2rem; margin-bottom: 5px;}
.folder-count { font-size: 0.8rem; color: #666; }
.new-item-card { border-left: none !important; border: 2px dashed #bdc3c7; background: transparent; color: #95a5a6; font-weight: 600; box-shadow: none; align-items: center; }
.new-item-card:hover { border-color: var(--accent); color: var(--accent); background: rgba(41, 128, 185, 0.05); }
.delete-btn { position: absolute; bottom: 10px; right: 10px; background:none; border:none; color: #fab1a0; cursor:pointer; opacity:0; font-size:1.2em; transition: 0.2s; }
.book-card:hover .delete-btn { opacity: 1; }
.delete-btn:hover { color:var(--error); transform: scale(1.2); }
.search-result-item { background: white; padding: 15px 20px; border-radius: 12px; border: 1px solid #eee; display: flex; justify-content: space-between; font-family: var(--font-main); align-items: center; }
.search-result-item strong { color: var(--accent); font-size: 1.1rem; }

/* ANALYTICS */
.analytics-view { display: none; padding: 40px; overflow-y: auto; height: 100%; background-color: #f8f9fa !important; font-family: var(--font-main); }
.analytics-header { text-align: center; margin-bottom: 30px; }
.analytics-header h2 { color: var(--primary); font-size: 2.2rem; margin: 0; font-weight: 700; letter-spacing: -1px; }
.level-dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
.total-score-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; padding: 30px; position: relative; overflow: hidden; box-shadow: 0 15px 30px rgba(118, 75, 162, 0.4); display: flex; flex-direction: column; justify-content: center; }
.total-score-card::after { content: 'üèÜ'; position: absolute; right: -20px; bottom: -30px; font-size: 180px; opacity: 0.15; transform: rotate(-15deg); }
.level-label { font-size: 1.1rem; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
.total-points { font-size: 5rem; font-weight: 800; line-height: 1; margin: 15px 0; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.level-progress-container { margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px; }
.level-bar-bg { width: 100%; height: 12px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; }
.level-bar-fill { height: 100%; background: #f1c40f; width: 0%; transition: width 1s ease-in-out; border-radius: 10px; }
.level-text { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.95rem; font-weight: 600; }
.daily-score-card { background: white; border-radius: 20px; padding: 25px; border: 1px solid #f1f2f6; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
.daily-title { color: #7f8c8d; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
.daily-val { font-size: 3.5rem; font-weight: 700; color: var(--success); }
.daily-time { font-size: 0.9rem; color: #95a5a6; margin-top: 10px; background: #f8f9fa; padding: 5px 15px; border-radius: 20px; }
.score-rules-toggle { border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s;}
.score-rules-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
.score-rules-box { display: none; background: white; margin-top: 20px; border-radius: 15px; padding: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); animation: slideDown 0.3s ease-out; margin-bottom: 30px; border: 1px solid #eee; }
.rules-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
.rules-table th { text-align: left; color: var(--primary); padding: 12px; border-bottom: 2px solid #f1f2f6; }
.rules-table td { padding: 12px; border-bottom: 1px solid #f1f2f6; color: #636e72; }
.rule-icon { margin-right: 10px; font-size: 1.2em; }
.weekly-score-container { display: flex; gap: 15px; margin-bottom: 30px; justify-content: space-between; height: 120px; align-items: flex-end;}
.weekly-day-box { flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 15px 10px; text-align: center; color: white; box-shadow: 0 5px 15px rgba(118, 75, 162, 0.2); transition: transform 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; height: 100%;}
.weekly-day-box:hover { transform: translateY(-5px); }
.weekly-day-box.today { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); box-shadow: 0 10px 20px rgba(0,0,0,0.15); border: 3px solid white; transform: scale(1.05); z-index: 2; }
.w-day-name { font-size: 0.85rem; font-weight: 500; margin-bottom: 5px; opacity: 0.9; text-transform: uppercase; }
.w-day-score { font-size: 1.6rem; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
.stat-card { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; border: none; border-bottom: 4px solid #eee; transition: transform 0.2s; }
.stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
.stat-number { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin: 5px 0; }
.stat-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;}
.monthly-chart-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #f1f2f6; }
.chart-bars { display: flex; align-items: flex-end; gap: 5px; height: 120px; margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid #dfe6e9; }
.chart-bar { flex: 1; background: var(--accent); border-radius: 5px 5px 0 0; position: relative; transition: height 0.5s ease; opacity: 0.7; }
.chart-bar:hover { opacity: 1; background: var(--primary); }
.chart-bar:hover::after { content: attr(data-date) ' : ' attr(data-score); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #2d3436; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; white-space: nowrap; z-index: 10; pointer-events: none; }
.accordion-box { border: 1px solid #eee; border-radius: 15px; overflow: hidden; margin-bottom: 20px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.02); }
.accordion-header { background: #f8f9fa; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--primary); transition: 0.2s; user-select: none; font-size: 1rem; }
.accordion-header:hover { background: #ecf0f1; }
.accordion-content { display: none; padding: 0; border-top: 1px solid #eee; }
.accordion-content.open { display: block; animation: slideDown 0.3s ease-out; }
.activity-item { padding: 15px 25px; border-bottom: 1px solid #f1f2f6; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; color: #2d3436; }
.log-point-badge { background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; margin-left: 10px; }
.vocab-stats-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 0.9rem; background:#fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-radius: 15px; overflow: hidden; border: 1px solid #eee;}
.vocab-stats-table th { background: #f8f9fa; color: var(--primary); padding: 15px; font-weight: 700; text-transform:uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #eee; }
.vocab-stats-table td { padding: 15px; text-align: center; border-bottom: 1px solid #f1f2f6; color: #636e72; }
.progress-track { width: 100%; background: #dfe6e9; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
.progress-fill-know { height: 100%; background: var(--success); border-radius: 4px; }
.section-title { font-size:1.3rem; color:var(--primary); font-weight: 700; margin:30px 0 15px 0; border-left: 5px solid var(--accent); padding-left: 15px; }
.analytics-grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }

/* WORD MASTER */
.wm-setup-title { text-align:center; color:var(--primary); margin-bottom:25px; font-weight:700; font-size: 1.3rem; position: relative; display: inline-block; left: 50%; transform: translateX(-50%); border-bottom: 3px solid var(--accent); padding-bottom: 10px;}
.wm-type-btn { display:flex; width:100%; padding:25px; margin-bottom:15px; background:#fff; border:2px solid #f1f2f6; border-radius:20px; font-family:var(--font-main); font-weight:700; font-size:1.2rem; color:var(--text-color); cursor:pointer; transition:0.2s; align-items:center; gap:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
.wm-type-btn:hover { border-color:var(--accent); background:#f8f9fa; transform: translateX(5px); }
.wm-type-btn.selected { border-color:var(--accent); background:var(--accent); color:#fff; box-shadow: 0 10px 20px rgba(41, 128, 185, 0.3); }
.wm-level-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; }
.wm-level-btn { padding:30px; border:none; background:#f1f2f6; border-radius:20px; font-family:var(--font-main); font-weight:800; font-size:1.4rem; color:var(--primary); cursor:pointer; transition:0.2s; }
.wm-level-btn:hover { background:var(--accent); color:white; transform:scale(1.05); box-shadow: 0 10px 20px rgba(41, 128, 185, 0.3); }
.wm-mode-toggle { display:flex; gap:10px; margin-bottom:30px; background:#f1f2f6; padding:8px; border-radius:50px; }
.wm-mode-opt { flex:1; text-align:center; padding:12px; border-radius:50px; cursor:pointer; font-weight:700; transition:0.2s; color: #95a5a6; }
.wm-mode-opt.active { background:white; color:var(--accent); box-shadow:0 4px 15px rgba(0,0,0,0.1); }

/* FLASHCARD */
.wm-card-container { width: 700px; max-width: 95%; height: 400px; perspective: 1500px; cursor: pointer; margin: 0 auto 40px auto; }
.wm-flip-inner { position:relative; width:100%; height:100%; transition:transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); transform-style:preserve-3d; transform-origin: center center; }
.wm-card-front, .wm-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); font-weight: 800; font-size: 3.5rem; text-align: center; padding: 30px; transition: transform 0.6s, z-index 0s 0.3s; }
.wm-card-front { background: linear-gradient(135deg, #ffffff 0%, #f1f2f6 100%); color: var(--primary); z-index: 2; transform: rotateY(0deg); pointer-events: auto; border: 1px solid #dfe6e9; }
.wm-card-back { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: #f1c40f; transform: rotateY(180deg); z-index: 1; pointer-events: none; font-size: 2.8rem; }
.wm-flipped .wm-flip-inner { transform:rotateY(180deg); }
.wm-flipped .wm-card-front { pointer-events: none; z-index: 1; }
.wm-flipped .wm-card-back { pointer-events: auto; z-index: 2; }
.card-action-wrapper { margin-top: auto; display: flex; gap: 20px; }
.card-tool-btn { font-size: 1rem; padding: 10px 20px; border-radius: 30px; background: rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; color: #636e72; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; }
.card-tool-btn:hover { background: var(--accent); color: white; transform: scale(1.1); }
.wm-controls { display:flex; gap:30px; justify-content:center; margin-top:20px; width:100%; max-width:650px; }
.wm-btn { flex:1; padding:20px; border-radius:20px; border:none; color:white; font-family:var(--font-main); font-weight:800; font-size:1.2rem; cursor:pointer; transition:transform 0.2s; box-shadow:0 10px 20px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center; gap:10px; }
.wm-btn:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(0,0,0,0.15); }
.wm-btn-know { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
.wm-btn-unknow { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
.wm-count-display { font-size:1.1rem; color:#95a5a6; font-weight:600; margin-bottom:15px; letter-spacing: 1px;}

/* OPEN BOOK VIEW */
.open-book-view { display: none; width: 100%; height: 100%; flex-direction: column; background: #fff; }
.book-top-bar { height: 70px; background: #fff; border-bottom: 1px solid #f1f2f6; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; flex-shrink: 0; }
.back-btn { border: 1px solid #dfe6e9; background: #fff; color: #636e72; padding: 10px 25px; border-radius: 30px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: 0.2s; font-family: var(--font-main); display: flex; align-items: center; gap: 5px; }
.back-btn:hover { background: #f1f2f6; color: var(--primary); }
.live-stats-bar { display:none; gap:20px; font-size:0.95rem; color:#636e72; font-family: var(--font-main); background:#f8f9fa; padding:8px 20px; border-radius:30px; border: 1px solid #eee; }
.stat-pill strong { color:var(--accent); font-size: 1.1rem; }
.notebook-tools { display:none; align-items:center; gap:10px; margin-left:20px; padding-left:20px; border-left:1px solid #eee; }
.tool-select { padding:5px 10px; border-radius:12px; border:1px solid #dfe6e9; font-size:0.85rem; background:#fff; color:var(--text-color); margin-right:5px; cursor:pointer; font-family: var(--font-main); }

/* BOOK CONTENT */
.book-spread { flex: 1; display: flex; position: relative; overflow: hidden; background: #fff; height: 100%; align-items: stretch; }
.spine-shadow { position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; background: linear-gradient(to right, transparent, rgba(0,0,0,0.04), transparent); transform: translateX(-50%); pointer-events: none; z-index: 2; }
#pageLeft { border-right: 1px solid #f1f2f6; } 
.single-page { flex: 1; padding: 50px 70px; overflow: hidden; font-size: 1.15rem; line-height: 1.9; color: var(--text-color); text-align: justify; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
.interactive-word { cursor: pointer; border-bottom: 2px solid rgba(41, 128, 185, 0.2); transition: background 0.2s, color 0.2s; border-radius: 4px; padding: 0 2px;}
.interactive-word:hover { background-color: rgba(255, 243, 205, 0.5); color: #d35400; border-bottom-color: #d35400; }
.interactive-word.saved { color: var(--error); font-weight: 600; border-bottom: 2px solid var(--error); background-color: rgba(231, 76, 60, 0.1); }
#wordTooltip { position: fixed; background: var(--primary); color: #fff; padding: 12px 25px; border-radius: 12px; font-family: var(--font-main); font-size: 1rem; pointer-events: none; font-weight: 500; z-index: 1000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
.nav-arrow { position: absolute; top: 0; bottom: 0; width: 100px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #dfe6e9; cursor: pointer; z-index: 10; transition: 0.2s; opacity: 0; }
.book-spread:hover .nav-arrow { opacity: 1; }
.nav-arrow:hover { background: linear-gradient(90deg, rgba(0,0,0,0.03), transparent); color: var(--accent); }
.nav-arrow.prev { left: 0; background: linear-gradient(90deg, rgba(0,0,0,0.02), transparent); } 
.nav-arrow.next { right: 0; background: linear-gradient(-90deg, rgba(0,0,0,0.02), transparent); }
.page-num { position: absolute; bottom: 20px; width: 60px; text-align: center; color: #b2bec3; font-size: 0.85rem; font-weight: 600; }
.page-num.left { left: 40px; } .page-num.right { right: 40px; }

/* QUIZ STYLES */
.quiz-centered-container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
.quiz-question-card { width: 100%; background: #fff; padding: 50px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.08); border: 1px solid #f1f2f6; }
.quiz-progress-bar { width: 100%; height: 6px; background: #f1f2f6; border-radius: 10px; margin-bottom: 25px; overflow: hidden; }
.quiz-progress-fill { height: 100%; background: var(--accent-grad); transition: width 0.3s ease; }
.quiz-q-text { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 30px; line-height: 1.5; }
.quiz-opt { padding: 20px 30px; margin: 15px 0; border: 2px solid #f1f2f6; border-radius: 15px; cursor: pointer; background: #fff; text-align: left; font-family: var(--font-main); font-size: 1.1rem; transition: 0.2s; color: var(--text-color); font-weight: 500; }
.quiz-opt:hover { border-color: #bdc3c7; transform: translateX(5px); background: #f8f9fa; }
.quiz-opt.selected { background: #ebf5fb; color: var(--accent); border-color: var(--accent); font-weight: 700; }
.quiz-next-btn { margin-top: 30px; padding: 18px 50px; background: var(--primary); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 20px rgba(44, 62, 80, 0.2); width: 100%; justify-content: center; }
.quiz-next-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(44, 62, 80, 0.3); background: var(--secondary); }
.quiz-final-wrapper { width: 100%; min-height: 100%; display: flex; flex-direction: column; position: relative; background: #fff; }
.quiz-sticky-header { position: sticky; top: 0; z-index: 1000; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-bottom: 1px solid #e0e0e0; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px 40px; width: 100%; display: flex; justify-content: space-between; align-items: center; }
.result-circle-score { width: 70px; height: 70px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.4rem; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
.quiz-detail-content { padding: 40px; max-width: 900px; margin: 0 auto; width: 100%; }
.review-item { padding: 20px; margin-bottom: 15px; border-radius: 15px; background: #f8f9fa; border: 1px solid #f1f2f6; }
.review-item.correct { border-left: 5px solid var(--success); background: #f0fdf4; }
.review-item.wrong { border-left: 5px solid var(--error); background: #fff5f5; }

/* MODALS & ADMIN PANEL STYLE V3 (MOBILE RESPONSIVE) */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.85); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; }
.modal { background: #fff; width: 850px; max-width: 95vw; max-height: 90vh; padding: 40px; border-radius: 30px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); overflow-y: auto; }
.modal::-webkit-scrollbar { width: 0; } 

.admin-grid-top { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
.admin-box { padding: 25px; border-radius: 20px; border: 1px solid transparent; display: flex; flex-direction: column; gap: 15px; }
.box-backup { background: #f8f9fa; border-color: #dfe6e9; }
.box-danger { background: #fff5f5; border-color: #fab1a0; }
.admin-box-title { font-weight: 700; color: var(--primary); font-size: 1.1rem; display:flex; align-items:center; gap:10px; }

.backup-actions { display: flex; gap: 10px; flex-wrap: wrap; }
.backup-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: var(--font-main); transition: 0.2s; font-size: 0.9rem; min-width: 120px; }
.dl-btn { background: var(--accent); } .dl-btn:hover { background: var(--secondary); }
.ul-btn { background: #f39c12; } .ul-btn:hover { background: #d35400; }
.danger-btn { background: white; border: 1px solid var(--error); color: var(--error); } 
.danger-btn:hover { background: var(--error); color: white; }

.input-area-wrapper { background: #fff; border-top: 2px solid #f1f2f6; padding-top: 25px; }
.admin-input-row { display: flex; gap: 15px; margin-bottom: 15px; }
.admin-select { flex: 1; padding: 15px; border: 2px solid #dfe6e9; border-radius: 15px; font-family: var(--font-main); font-weight: 600; color: var(--primary); outline: none; transition: 0.3s; background-image: none;}
.admin-select:focus { border-color: var(--accent); }
.admin-textarea { width: 100%; height: 200px; padding: 20px; border: 2px dashed #b2bec3; border-radius: 20px; font-family: 'Courier New', monospace; font-size: 0.95rem; color: var(--primary); resize: vertical; outline: none; background: #fdfdfd; transition:0.3s; }
.admin-textarea:focus { border-color: var(--accent); background: #fff; }
.save-btn-large { width: 100%; padding: 18px; background: var(--success); color: white; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); transition: 0.2s; letter-spacing: 1px;}
.save-btn-large:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(39, 174, 96, 0.4); }

.toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 15px 40px; border-radius: 50px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); z-index: 2000; display: none; font-weight: 600; font-family: var(--font-main); animation: slideUp 0.4s ease; }
.toast.error { background: var(--error); }
@keyframes slideUp { from { bottom: 0; opacity: 0; } to { bottom: 40px; opacity: 1; } }

/* --- ADMIN MOBILE RESPONSIVE --- */
@media (max-width: 900px) {
    .modal { padding: 20px; width: 95%; max-height: 95vh; border-radius: 20px; }
    .admin-grid-top { grid-template-columns: 1fr; gap: 15px; } /* Kutularƒ± Alt Alta Al */
    .admin-input-row { flex-direction: column; gap: 10px; } /* Se√ßim ve sil butonunu alt alta al */
    .backup-actions { flex-direction: column; } /* Butonlarƒ± alt alta sƒ±rala */
    .backup-btn { width: 100%; padding: 15px; font-size: 1rem; } /* Butonlarƒ± b√ºy√ºt */
    .admin-select { width: 100%; }
    .admin-textarea { height: 150px; }
    .save-btn-large { padding: 15px; font-size: 1rem; }
}
/* NOTEBOOK & EXTRAS */
.notebook-wrapper { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }
.notebook-paper { width: 100%; flex: 1; border: none; outline: none; resize: none; background: transparent; font-family: 'Courier New', Courier, monospace; color: var(--primary); background-image: linear-gradient(#f1f2f6 1px, transparent 1px); background-size: 100% 40px; line-height: 40px; padding-top: 5px; font-size: 1.2rem; }
.mic-controls { position: absolute; top: -50px; right: 0; display: flex; gap: 10px; z-index: 10; }
.mic-btn { background: #fff; border: 1px solid #dfe6e9; padding: 6px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; color: #636e72; display: flex; align-items: center; gap: 5px; font-family: var(--font-main); font-weight: 600; transition:0.2s; }
.mic-btn:hover { background: #f1f2f6; }
.mic-btn.listening { background: #ffebee; color: var(--error); border-color: var(--error); animation: pulse 1.5s infinite; }
.hint-btn { background: #fff; border: 1px solid #f39c12; color: #f39c12; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-family: var(--font-main); font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition:0.2s; margin-top: 5px; }
.hint-btn:hover { background: #f39c12; color: white; }
.hint-text-box { margin-top: 10px; background: #fff3cd; padding: 10px 15px; border-radius: 12px; color: #856404; font-size: 0.9rem; font-weight: 500; display: none; animation: slideDown 0.2s ease-out; border: 1px solid #ffeeba; }
.vocab-layout { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; align-content: start; width: 100%; padding: 20px; }
.vocab-item { background: #fff; border: 1px solid #f1f2f6; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.2s; }
.vocab-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: var(--accent); }
.vocab-en { font-weight: 700; color: var(--accent); font-size: 1.1rem; margin-bottom: 5px; display: flex; justify-content: center; align-items: center; gap: 8px;} 
.vocab-tr { font-style: italic; color: #636e72; font-size: 1rem; }
.unknown-list-item { font-size: 1.1rem; padding: 12px 0; border-bottom: 1px dashed #eee; color: #555; display: flex; align-items: center; }
.unknown-list-item strong { color: var(--primary); font-weight: 700; margin-right: 10px; font-size: 1.2rem; }
.tts-small { cursor: pointer; font-size: 1.1em; color: #f39c12; transition: 0.2s; padding: 2px; border-radius: 50%; }
.tts-small:hover { background: rgba(243, 156, 18, 0.1); transform: scale(1.2); }
.fav-btn { cursor:pointer; font-size:1.1em; color:#bdc3c7; transition:0.2s; padding:2px; margin-left:8px; }
.fav-btn.active { color:var(--warn); text-shadow:0 0 5px rgba(241, 196, 15, 0.5); transform:scale(1.1); }
.fav-btn:hover { color:var(--warn); }
.tts-controls-group { display: none; gap: 5px; background: #f1f2f6; padding: 3px; border-radius: 20px; align-items: center; }
.tts-ctrl-btn { border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: 0.2s; font-family: var(--font-main); }
.btn-restart { background: #e67e22; color: white; }
.btn-pause { background: #34495e; color: white; min-width: 40px;}
.btn-pause.paused { background: #27ae60; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* RESPONSIVE */
/* --- MOBƒ∞L UYUMLU Fƒ∞NAL AYARLARI (V35.0 FIX) --- */

/* 1. Tablet ve K√º√ß√ºk Ekran Ayarlarƒ± */
@media (max-width: 1200px) {
    .wm-card-container { width: 500px; height: 300px; }
    .wm-card-front, .wm-card-back { font-size: 2.5rem; }
}

/* 2. Mobil Ayarlarƒ± (TELEFONLAR ƒ∞√áƒ∞N) */
@media (max-width: 900px) {
    /* Sayfa Kilidini A√ßma (En √ñnemli Kƒ±sƒ±m) */
    body {
        height: auto !important;
        overflow-y: auto !important;
        overflow-x: hidden;
        position: relative;
    }

    /* Ana Kutuyu Esnek Yap */
    .app-container {
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        width: 100%;
        border-radius: 0;
        overflow: visible;
        box-shadow: none;
    }

    /* Yan Men√ºy√º (Sidebar) Yatay Yap */
    .sidebar {
        width: 100%;
        height: auto;
        padding: 10px;
        overflow-x: auto;
        white-space: nowrap;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: flex-start;
        gap: 10px;
        flex-shrink: 0;
    }
    .sidebar h2 { display: none; }
    .nav-btn { font-size: 0.85rem; padding: 8px 12px; flex-shrink: 0; }
    .quick-dict-box { min-width: 180px; }

    /* √áalƒ±≈üma Alanƒ±nƒ± Rahatlat */
    .workbook-area {
        height: auto;
        min-height: calc(100vh - 70px);
        overflow: visible;
    }

    /* Kitap G√∂r√ºn√ºm√º */
    .book-spread { flex-direction: column; overflow-y: visible; height: auto; }
    .single-page { 
        height: auto; 
        border-bottom: 1px solid #eee; 
        padding: 20px; 
        overflow: visible; 
        font-size: 1.1rem; 
    }
    #pageRight { display: block; border-left: none; }
    .spine-shadow { display: none; }

    /* Oyun ve Kartlar */
    .wm-card-container { width: 95%; height: 280px; margin-bottom: 20px; }
    .wm-card-front, .wm-card-back { font-size: 1.8rem; padding: 10px; }
    .vocab-layout { grid-template-columns: 1fr; }
    .quiz-sticky-header { flex-direction: column; gap: 10px; position: relative; }

    /* Yeni Dashboard (Kutucuklar) Mobil Ayarƒ± */
    .dash-wrapper { flex-direction: column; height: auto; gap: 20px; padding-bottom: 30px; }
    .dash-stat-box { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; padding: 20px; }
    .dash-stat-value { font-size: 1.8rem; margin: 0; }
    .dash-center-card { width: 100%; height: auto; padding: 30px; }

    /* Admin Paneli (Veri Y√ºkleme) Mobil Ayarƒ± */
    .modal { 
        width: 100%; 
        height: 100%; 
        max-height: 100vh; 
        border-radius: 0; 
        padding: 15px; 
        overflow-y: auto !important; 
    }
    .admin-grid-top { grid-template-columns: 1fr; gap: 15px; }
    .admin-input-row { flex-direction: column; gap: 10px; }
    .backup-actions { flex-direction: column; }
    .backup-btn { width: 100%; padding: 12px; }
    .admin-textarea { height: 150px; }
    .save-btn-large { padding: 15px; font-size: 1rem; }
}

/* Scrollbar Tasarƒ±mƒ± (PC ƒ∞√ßin) */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f2f6; }
::-webkit-scrollbar-thumb { background: #b2bec3; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #636e72; }

/* Mobilde Scrollbar'ƒ± Gizle (Daha Temiz G√∂r√ºn√ºm) */
@media (max-width: 900px) {
    ::-webkit-scrollbar { width: 0px; background: transparent; }
}
/* --- LEVEL DASHBOARD STYLES (NEW) --- */
.dash-wrapper {
    display: flex; justify-content: center; align-items: center; gap: 40px;
    height: 80%; width: 100%; padding: 20px; font-family: var(--font-main);
}
.dash-stat-box {
    background: white; border: 1px solid #dfe6e9; border-radius: 20px;
    padding: 30px; text-align: center; cursor: pointer; transition: 0.3s;
    width: 200px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); display:flex; flex-direction:column; justify-content:center;
}
.dash-stat-box:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: var(--accent); }
.dash-stat-title { font-size: 1.1rem; color: #7f8c8d; font-weight: 600; margin-bottom: 10px; }
.dash-stat-value { font-size: 2.5rem; color: var(--primary); font-weight: 800; }
.dash-stat-sub { font-size: 0.9rem; color: var(--success); font-weight: 700; margin-top: 5px; }

.dash-center-card {
    width: 500px; height: 350px; background: white; border-radius: 40px;
    border: 4px solid var(--primary); display: flex; flex-direction: column;
    justify-content: center; align-items: center; text-align: center;
    cursor: pointer; transition: 0.4s; box-shadow: 0 20px 50px rgba(0,0,0,0.1);
    position: relative; overflow: hidden; padding: 40px;
}
.dash-center-card:hover {
    transform: scale(1.02); background: var(--primary); border-color: var(--primary);
}
.dash-center-card:hover h1, .dash-center-card:hover p { color: white !important; }
.dash-center-label { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; color: #95a5a6; margin-bottom: 15px; font-weight: 700;}
.dash-center-title { font-size: 2.2rem; color: var(--primary); font-weight: 800; line-height: 1.3; }
.dash-center-action { margin-top: 25px; padding: 10px 30px; background: var(--accent); color: white; border-radius: 50px; font-weight: 600; }
.dash-center-card:hover .dash-center-action { background: white; color: var(--primary); }

/* Liste Modalƒ± i√ßin */
.dash-list-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;}
.dash-list-content { background:white; width:500px; max-height:80vh; border-radius:20px; padding:30px; overflow-y:auto; position:relative; }
.dash-list-item { padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.dash-list-item:hover { background:#f9f9f9; }
.dash-list-item.done { color:var(--success); text-decoration:line-through; }
</style>
</head>
<div id="dashListModal" class="dash-list-modal">
    <div class="dash-list-content">
        <button onclick="document.getElementById('dashListModal').style.display='none'" style="position:absolute; right:20px; top:20px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        <h3 id="dashListTitle" style="margin-top:0; color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:10px;">Liste</h3>
        <div id="dashListBody"></div>
    </div>
</div>
<body>

<div id="wordTooltip"></div>
<div id="toast" class="toast"></div>

<div class="app-container">
<div class="sidebar">
    <h2>English Hub</h2>
    <div class="quick-dict-box">
        <input type="text" id="quickDic" class="quick-dict-input" placeholder="üîç Hƒ±zlƒ± S√∂zl√ºk..." onkeypress="handleQuickDict(event)">
    </div>
    <button class="nav-btn active" onclick="switchCategory('reading')">üìñ Reading</button>
    <button class="nav-btn" onclick="switchCategory('vocabulary')" style="display:none;">üî§ Vocabulary</button>
    <button class="nav-btn" onclick="switchCategory('unknowns')" style="color:#ff7675;">üö´ Unknown Words</button>
    <button class="nav-btn" onclick="switchCategory('favorites')" style="color:#f1c40f;">‚≠ê Favorites</button> 
    <button class="nav-btn" onclick="switchCategory('grammar')">üìò Grammar</button>
    <button class="nav-btn" onclick="switchCategory('notes')">üìù My Notes</button>
    <div style="height:1px; background:rgba(255,255,255,0.1); margin:5px 0;"></div>
    <button class="nav-btn" onclick="switchCategory('analytics')">üìä Analizler</button>
    <div style="height:1px; background:rgba(255,255,255,0.1); margin:5px 0;"></div>
    <button class="nav-btn" onclick="openWordMasterApp()" style="color:#f1c40f;">üéÆ Word Master</button>
    <button class="nav-btn" onclick="openExternalGame('grammar.html', 'Grammar Practice')">üöÄ Grammar Practice</button>
    <button class="nav-btn" onclick="openExternalGame('phrase-master.html', 'Phrase Master')">‚ú® Phrase Master</button>
    
    <div class="spacer"></div>
    
    <button class="nav-btn" onclick="exportData()" style="color:white; font-weight:bold;">üíæ YEDEK AL</button>
    <button class="nav-btn admin-btn" onclick="openAdmin()">‚öôÔ∏è Data Manager</button>
  </div>
<div class="workbook-area">
    <div id="libraryHeader" class="library-header">
        <input type="text" id="mainSearch" class="main-search-input" placeholder="K√ºt√ºphanede Ara..." onkeyup="filterLibrary(this.value)">
    </div>

    <div id="libraryGrid" class="library-grid"></div>
    <div id="analyticsView" class="analytics-view"></div>

    <div id="openBookView" class="open-book-view">
        <div class="book-top-bar">
            <button class="back-btn" onclick="closeBook()">‚Üê K√ºt√ºphane</button>
            <strong id="bookHeaderTitle" style="color:var(--primary); font-size:1.1rem;">Title</strong>
            
            <div id="liveStats" class="live-stats-bar">
                <div class="stat-pill">üìñ Kelime: <strong id="liveWordCount">0</strong></div>
                <div class="stat-pill">‚è±Ô∏è S√ºre: <strong id="liveTimer">00:00</strong></div>
            </div>

            <div id="headerTools" style="display:flex; gap:10px; align-items:center;">
                <input id="myNoteTitleDisplay" type="text" style="display:none; border:none; border-bottom:1px solid #dfe6e9; text-align:center; font-family:var(--font-main);" onchange="saveNoteTitle(this.value)" placeholder="Ba≈ülƒ±k">
                
                <div id="notebookTools" class="notebook-tools">
                    <span style="font-size:0.8rem; color:#888;">Kalem:</span>
                    <input type="color" class="tool-select" value="#2c3e50" style="padding:0; height:30px; width:40px; border-radius:50%; border:none;" onchange="applyGlobalStyle('color', this.value)">
                    <select class="tool-select" onchange="applyGlobalStyle('size', this.value)">
                        <option value="16">16px</option><option value="20" selected>20px</option>
                        <option value="24">24px</option><option value="30">30px</option>
                        <option value="36">36px</option>
                    </select>
                </div>

                <select id="ttsSpeed" class="tool-select" style="display:none;">
                    <option value="0.7">0.7x</option><option value="0.8">0.8x</option>
                    <option value="0.9" selected>0.9x</option><option value="1.0">1.0x</option>
                </select>

                <div id="ttsControls" class="tts-controls-group">
                    <button class="tts-ctrl-btn btn-restart" onclick="handleTTS('restart')" title="Ba≈ütan Oku">üîÑ</button>
                    <button id="ttsPauseBtn" class="tts-ctrl-btn btn-pause" onclick="handleTTS('pause')" title="Duraklat/Devam Et">‚è∏</button>
                </div>
                
                <button id="langToggle" onclick="toggleLang()" style="display:none; border:none; background:var(--accent); color:white; padding:5px 15px; border-radius:15px; font-size:0.8em; cursor:pointer;">TR / ENG</button>
                <button id="addPageBtn" onclick="addPageToNote()" style="display:none; border:none; background:var(--success); color:white; padding:5px 15px; border-radius:15px; font-size:0.8em; cursor:pointer;">+ Sayfa</button>
                <button id="flashcardBtn" onclick="startFlashcardMode()" style="display:none; border:none; background:#8e44ad; color:white; padding:5px 15px; border-radius:15px; font-size:0.8em; cursor:pointer;">‚ö° KART MODU</button>
            </div>
        </div>

        <div class="book-spread">
            <div class="spine-shadow"></div>
            <div class="nav-arrow prev" onclick="turnPage(-2)">‚Äπ</div>
            <div id="pageLeft" class="single-page"></div>
            <div id="pageRight" class="single-page"></div>
            <div class="nav-arrow next" onclick="turnPage(2)">‚Ä∫</div>
            <div class="page-num left" id="pageNumL">1</div>
            <div class="page-num right" id="pageNumR">2</div>
        </div>
    </div>
    
    <div id="externalAppView" style="display:none; width:100%; height:100%; flex-direction:column;">
        <div class="book-top-bar">
            <button class="back-btn" onclick="closeExternalApp()">‚Üê Kapat</button>
            <strong id="appTitle" style="color:var(--primary); margin-left: 20px;">Uygulama</strong>
            <div style="flex:1;"></div> </div>
        <iframe id="appFrame" style="flex:1; border:none; width:100%; height:100%;"></iframe>
    </div>

</div> <div class="modal-overlay" id="flashcardModal" style="display:none; align-items:center; justify-content:center;">
    <div class="modal" style="height:auto; width:600px; background:transparent; box-shadow:none;">
        <div id="flashcardContainer" style="text-align:center;"></div>
        <button onclick="document.getElementById('flashcardModal').style.display='none'" style="margin-top:20px; background:rgba(255,255,255,0.2); border:1px solid white; color:white; padding:10px 25px; border-radius:50px; cursor:pointer;">Kapat</button>
    </div>
</div>

<div class="modal-overlay" id="quickQuizModal" style="display:none;">
  <div class="modal" style="height:auto; max-height:90vh;">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="color:var(--primary); margin:0;">Yeni Test Ekle</h3><button onclick="document.getElementById('quickQuizModal').style.display='none'" style="border:none; background:none; font-size:1.5em; cursor:pointer;">&times;</button></div>
    <div style="background:#e8f8f5; padding:15px; font-size:0.85em; color:#16a085; border-radius:12px;">Format:<br>###SORULAR###<br>Ba≈ülƒ±k: A1 Airport<br>Q1: Soru... A)... Correct: A</div>
    <textarea id="quickQuizInput" style="height:300px;" placeholder="Sorularƒ± buraya yapƒ±≈ütƒ±r..."></textarea>
    <button onclick="saveQuickQuiz()" style="padding:15px; background:var(--success); color:white; border:none; font-weight:bold; cursor:pointer; border-radius:12px;">TESTƒ∞ KAYDET</button>
  </div>
</div>

<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="color:var(--primary); margin:0; font-weight:800; letter-spacing:-1px;">‚öôÔ∏è Data Manager Pro</h2>
        <button onclick="closeAdmin()" style="border:none; background:none; font-size:2rem; cursor:pointer; color:#95a5a6;">&times;</button>
    </div>

    <div class="admin-grid-top">
        <div class="admin-box box-backup">
            <div class="admin-box-title">üíæ Sistem Yedekleme</div>
            <div class="backup-actions">
                <button class="backup-btn dl-btn" onclick="exportData()">ƒ∞ndir (.json)</button>
                <button class="backup-btn ul-btn" onclick="document.getElementById('restoreFile').click()">Y√ºkle</button>
                <input type="file" id="restoreFile" style="display:none;" accept=".json" onchange="importData(this)">
            </div>
            <div style="font-size:0.8rem; color:#7f8c8d; margin-top:5px;">Verilerinizi d√ºzenli olarak yedeklemeniz √∂nerilir.</div>
        </div>

        <div class="admin-box box-danger">
            <div class="admin-box-title" style="color:var(--error);">üö® Tehlikeli B√∂lge</div>
            <div class="backup-actions">
                <button class="backup-btn danger-btn" onclick="resetProgress()">üî• ƒ∞lerlemeyi Sƒ±fƒ±rla</button>
                <button class="backup-btn danger-btn" onclick="clearGameLogs()">üéÆ Oyun Puanƒ± Sil</button>
                <button class="backup-btn danger-btn" onclick="removeDuplicates()">‚ôª √áiftleri Sil</button>
            </div>
            <div style="font-size:0.8rem; color:#fab1a0; margin-top:5px;">Dikkat: Bu i≈ülemler geri alƒ±namaz!</div>
        </div>
    </div>

    <div class="input-area-wrapper">
        <h3 style="margin:0 0 15px 0; color:var(--primary);">üìù Yeni ƒ∞√ßerik Ekle</h3>
        
        <div class="admin-input-row">
            <select id="inputCategory" class="admin-select">
                <option value="reading">üìñ Reading</option>
                <option value="vocabulary">üìó Vocabulary (Kelime)</option>
                <option value="idioms">üîÆ Vocabulary (Deyim)</option>
                <option value="phrases">üí¨ Vocabulary (Kalƒ±plar)</option>
                <option value="grammar">üìò Grammar</option>
                <option value="question">‚ùì Questions (Test)</option>
            </select>
            <button onclick="clearCategoryData()" class="backup-btn danger-btn" style="flex:0; min-width:140px;">Bu Kategoriyi Sil</button>
        </div>

        <input type="text" id="inputTitle" placeholder="Ba≈ülƒ±k (Opsiyonel)" style="width:100%; padding:15px; border:2px solid #dfe6e9; border-radius:15px; font-family:var(--font-main); display:none; margin-bottom:15px;">
        
        <textarea id="bulkInput" class="admin-textarea" placeholder="Verilerinizi buraya yapƒ±≈ütƒ±rƒ±n... (JSON formatƒ± veya D√ºz Metin)"></textarea>
        
        <button onclick="saveData()" class="save-btn-large">üíæ ƒ∞√áERƒ∞ƒûƒ∞ KAYDET VE YAYINLA</button>
    </div>
  </div>
</div>
<script>
/* --- ENGLISH PRO HUB MASTER SCRIPT (V35.0 STABLE) --- */

/* 1. VERƒ∞TABANI VE DEƒûƒ∞≈ûKENLER */
function safeLoad(key, defaultVal) {
    try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultVal;
    } catch (e) {
        console.error("Veri y√ºkleme hatasƒ±:", key, e);
        return defaultVal;
    }
}

let contentData = safeLoad('englishWorkbookData', []);
let userStats = safeLoad('userStats', { 
    booksRead:0, pagesTurned:0, quizzesTaken:0, wordsAdded:0, notesTaken:0, totalCorrect:0, totalWrong:0,
    dailyActivity: {} 
});
let userUnknownWords = safeLoad('userUnknownWords', []);
let userKnownVocabulary = safeLoad('userKnownVocabulary', []);
let userActivityLog = safeLoad('userActivityLog', []);
let userFavorites = safeLoad('userFavorites', []);

let globalLexicon = {}; 
let recognition; 
let isListening = false; 
let currentTargetId = "";
let currentLevelFolder = null; 

// GAME STATE
let wmState = 'setup';
let wmType = 'vocab';
let wmMode = 'learn';
let gameQueue = []; 
let gameIndex = 0;
let wmSessionCount = 0;
let fcSessionCount = 0;

// TIMER VARIABLES
let readingTimerInterval;
let activeReadingSeconds = 0; 
let currentQuizTime = 0;
let externalAppStartTime = parseInt(localStorage.getItem('tempExternalTimer')) || 0; 
let externalTimerInterval; 
let currentPenStyle = { color: '#2c3e50', size: '20' }; 
let isTogglingContext = false;
let ttsObj = null;

// PAGE STATE
let currentCategory='reading'; 
let currentBook=null; 
let pageIndex=0; 
let isTrMode=false; 
let quizAnswers={};

/* 2. BA≈ûLATMA VE GLOBAL EVENTLER */
window.onload = function() { 
    buildGlobalDictionary(); 
    switchCategory('reading'); 
    setupVoice(); 
    
    if(externalAppStartTime > 0) {
        document.getElementById('externalAppView').style.display = 'flex';
        startExternalTimerUI();
    }
};

// TOOLTIP EVENT LISTENER
document.addEventListener('mouseover', function(e) {
    if(e.target.classList.contains('interactive-word')) {
        let m = e.target.getAttribute('data-meaning');
        if(m && m !== 'null' && m !== 'undefined' && m !== '') {
            let t = document.getElementById('wordTooltip');
            t.innerHTML = m;
            t.style.display = 'block';
            t.style.left = (e.pageX + 10) + 'px';
            t.style.top = (e.pageY + 15) + 'px';
        }
    }
});

document.addEventListener('mouseout', function(e) {
    if(e.target.classList.contains('interactive-word')) {
        document.getElementById('wordTooltip').style.display = 'none';
    }
});

// KELƒ∞ME TIKLAMA (KAYDETME/Sƒ∞LME)
document.addEventListener('click', function(e) {
    if(e.target.classList.contains('interactive-word')) {
        let word = e.target.innerText.replace(/[^a-zA-Z0-9'√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]/g, '');
        let meaning = e.target.getAttribute('data-meaning');
        toggleUnknown(e.target, word, meaning);
    }
});

function trackStat(key, val=1) { 
    userStats[key]=(userStats[key]||0)+val; 
    localStorage.setItem('userStats',JSON.stringify(userStats)); 
}

function showToast(msg, err=false) { 
    const t=document.getElementById('toast'); 
    if(t) {
        t.textContent=msg; 
        t.className=err?'toast error':'toast'; 
        t.style.display='block'; 
        setTimeout(()=>t.style.display='none',3000); 
    }
}

/* 3. LOGLAMA */
function logActivity(type, title, detail, durationSeconds = 0, points = 0) {
    const date = new Date().toLocaleDateString('tr-TR');
    userActivityLog.push({ 
        date, type, title, detail, 
        timestamp: Date.now(), 
        duration: durationSeconds, 
        points: points 
    });
    localStorage.setItem('userActivityLog', JSON.stringify(userActivityLog));
}

function calculateDetailedScore(dateStr) {
    const logs = userActivityLog.filter(l => l.date === dateStr);
    let report = { totalScore: 0, vocabCount: 0, questionCount: 0, timeMinutes: 0, gameMinutes: 0, pageCount: 0 };

    logs.forEach(l => {
        let pts = Number(l.points) || 0;
        if(pts > 0) report.totalScore += pts;
        
        if(l.duration) {
            if(l.type === 'external_game') report.gameMinutes += Math.floor(l.duration / 60);
            else report.timeMinutes += Math.floor(l.duration / 60);
        }
    });

    if(userStats.dailyActivity && userStats.dailyActivity[dateStr]) {
        report.pageCount = userStats.dailyActivity[dateStr].pages || 0;
    }
    report.totalScore += (report.pageCount * 10);
    return report;
}

function calculateLifetimeScore() {
    let total = 0;
    userActivityLog.forEach(l => {
        let pts = Number(l.points) || 0;
        if(pts > 0) total += pts;
    });
    let totalPages = 0;
    if(userStats.dailyActivity) {
        for(let date in userStats.dailyActivity) {
            totalPages += (userStats.dailyActivity[date].pages || 0);
        }
    }
    total += (totalPages * 10);
    return total;
}

/* ANALYTICS */
function openAnalytics() {
    document.getElementById('libraryGrid').style.display='none'; 
    document.getElementById('libraryHeader').style.display='none'; 
    document.getElementById('openBookView').style.display='none';
    document.getElementById('analyticsView').style.display='block';
    
    const today = new Date(); const todayStr = today.toLocaleDateString('tr-TR');
    const reportToday = calculateDetailedScore(todayStr);
    const lifetimeScore = calculateLifetimeScore();
    const currentLevel = Math.floor(lifetimeScore / 1000) + 1;
    const progressPercent = (lifetimeScore % 1000) / 10;

    let scoreboardHtml = `
        <div class="level-dashboard">
            <div class="total-score-card">
                <div class="level-label">‚≠ê TOPLAM PUAN (SEVƒ∞YE ${currentLevel})</div>
                <div class="total-points">${lifetimeScore}</div>
                <div class="level-progress-container">
                    <div class="level-bar-bg"><div class="level-bar-fill" style="width:${progressPercent}%"></div></div>
                    <div class="level-text"><span>Sonraki Seviye: ${currentLevel + 1}</span><span>%${Math.round(progressPercent)}</span></div>
                </div>
            </div>
            <div class="daily-score-card">
                <div class="daily-title">BUG√úN√úN KAZANCI</div>
                <div class="daily-val">+${reportToday.totalScore}</div>
                <div class="daily-time">${Math.floor((reportToday.timeMinutes + reportToday.gameMinutes)/60)}sa ${(reportToday.timeMinutes + reportToday.gameMinutes)%60}dk</div>
            </div>
        </div>
        <div style="text-align:center; margin-bottom:20px;">
             <button class="score-rules-toggle" style="position:static;" onclick="toggleScoreRules()">‚ùì Puanlama Sistemi</button>
        </div>
        <div id="scoreRules" class="score-rules-box">
             <h4 style="margin-top:0; color:var(--primary);">üìä Puanlama Sistemi</h4>
            <table class="rules-table"><thead><tr><th>Aktivite</th><th>Puan Deƒüeri</th></tr></thead><tbody><tr><td><span class="rule-icon">üìÑ</span> Sayfa √áevirme</td><td><strong>10 Puan</strong> / sayfa</td></tr><tr><td><span class="rule-icon">‚úÖ</span> Soru √á√∂z√ºm√º</td><td><strong>15 Puan</strong> / doƒüru</td></tr><tr><td><span class="rule-icon">üß†</span> Kelime Ezberi</td><td><strong>10 Puan</strong> / kelime</td></tr><tr><td><span class="rule-icon">üöÄ</span> Oyunlar & Pratik</td><td><strong>20 Puan</strong> / dakika</td></tr><tr><td><span class="rule-icon">üìñ</span> Okuma Tamamlama</td><td><strong>10 Puan</strong></td></tr></tbody></table>
        </div>
    `;

    let weeklyHtml = `<h4 style="margin:20px 0 10px 0; color:var(--primary); opacity:0.7;">üìÖ Haftalƒ±k Performans</h4><div class="weekly-score-container">`;
    const daysShort = ['Paz', 'Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt'];
    for (let i = 6; i >= 0; i--) {
        let d = new Date(); d.setDate(d.getDate() - i);
        let dStr = d.toLocaleDateString('tr-TR');
        let dName = daysShort[d.getDay()];
        let dScore = calculateDetailedScore(dStr).totalScore;
        let activeClass = (i === 0) ? 'today' : '';
        weeklyHtml += `<div class="weekly-day-box ${activeClass}"><div class="w-day-name">${dName}</div><div class="w-day-score">${dScore}</div></div>`;
    }
    weeklyHtml += `</div>`;

    let monthlyHtml = `<div class="monthly-chart-container"><div style="font-weight:700; color:var(--primary);">üìÖ Aylƒ±k Aktivite Yoƒüunluƒüu (Son 30 G√ºn)</div><div class="chart-bars">`;
    let maxMonthScore = 1;
    let monthData = [];
    for(let i=29; i>=0; i--){
        let d = new Date(); d.setDate(d.getDate() - i);
        let dStr = d.toLocaleDateString('tr-TR');
        let s = calculateDetailedScore(dStr).totalScore;
        if(s > maxMonthScore) maxMonthScore = s;
        monthData.push({date: dStr, score: s});
    }
    monthData.forEach(day => {
        let h = (day.score / maxMonthScore) * 100;
        if(h < 5 && day.score > 0) h = 5; 
        monthlyHtml += `<div class="chart-bar" style="height:${h}%" data-date="${day.date.split('.')[0]}" data-score="${day.score}"></div>`;
    });
    monthlyHtml += `</div></div>`;

    const rTot = contentData.filter(i=>i.category==='reading').length; 
    const rComp = contentData.filter(i=>i.category==='reading' && i.completed).length;
    const qTot = contentData.filter(i=>i.category==='question').length; 
    const qComp = contentData.filter(i=>i.category==='question' && i.completed).length;
    const gTot = contentData.filter(i=>i.category==='grammar').length; 
    const gComp = contentData.filter(i=>i.category==='grammar' && i.completed).length;

    let activityInnerHtml = "";
    const sortedLogs = [...userActivityLog].sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
    const groupedLogs = {};
    sortedLogs.forEach(log => { if (!groupedLogs[log.date]) groupedLogs[log.date] = []; groupedLogs[log.date].push(log); });

    if (Object.keys(groupedLogs).length === 0) {
        activityInnerHtml += `<div style="text-align:center; color:#999; padding:20px;">Kayƒ±t yok.</div>`;
    } else {
        for (const date in groupedLogs) {
            activityInnerHtml += `<div class="activity-date-header" style="background:#f1f2f6; margin-top:10px;">üìÖ ${date}</div>`;
            groupedLogs[date].forEach(log => {
                 let icon = 'üîπ'; 
                if(log.type === 'reading') icon = 'üìñ'; 
                if(log.type === 'quiz') icon = '‚ùì'; 
                if(log.type === 'vocab') icon = 'üß†'; 
                if(log.type === 'grammar') icon = 'üìò'; 
                if(log.type === 'external_game') icon = 'üöÄ';
                let durText = log.duration ? ` <span class="log-duration">(${Math.floor(log.duration/60)}dk ${log.duration%60}sn)</span>` : "";
                let pts = log.points || 0;
                let pointBadge = pts ? `<span class="log-point-badge">+${pts} Puan</span>` : "";
                activityInnerHtml += `<div class="activity-item"><div><span class="activity-type-icon">${icon}</span> ${log.title} <span class="log-detail-text">${log.detail || ''}</span></div><div class="log-meta">${durText} ${pointBadge}</div></div>`;
            });
        }
    }
    
    let activitySection = `
        <div class="accordion-box">
            <div class="accordion-header" onclick="toggleAccordion('actLogs')">
                <span>üìã G√ºnl√ºk Hareket D√∂k√ºm√º</span>
                <span class="arrow-icon">‚ñº</span>
            </div>
            <div id="actLogs" class="accordion-content">
                <div style="padding:15px; max-height:400px; overflow-y:auto;">${activityInnerHtml}</div>
            </div>
        </div>
    `;

    const createLevelTable = (title, keyword) => {
        let html = `<div style="flex:1;"><div class="section-title">${title}</div><table class="vocab-stats-table"><thead><tr><th>Seviye</th><th>Toplam</th><th>Bildiƒüin</th><th>Durum</th></tr></thead><tbody>`;
        const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
        
        levels.forEach(lvl => {
            let lvlWords = [];
            const relevantBooks = contentData.filter(b => {
                if (b.category !== 'vocabulary') return false;
                const titleUpper = b.title.toUpperCase();
                if (!titleUpper.includes(lvl)) return false;
                if (keyword === 'Idioms') return titleUpper.includes('IDIOMS');
                if (keyword === 'Phrases') return titleUpper.includes('PHRASES');
                return !titleUpper.includes('IDIOMS') && !titleUpper.includes('PHRASES');
            });

            relevantBooks.forEach(b => { 
                if(b.words) lvlWords = lvlWords.concat(b.words.map(w => w.en)); 
            });
            
            lvlWords = [...new Set(lvlWords)];
            const total = lvlWords.length;

            if(total > 0) {
                const knownCount = lvlWords.filter(w => {
                    return userKnownVocabulary.some(known => known.toLowerCase() === w.toLowerCase());
                }).length;

                const percent = Math.round((knownCount / total) * 100);
                html += `<tr><td><strong>${lvl}</strong></td><td>${total}</td><td style="color:#27ae60">${knownCount}</td><td><div class="progress-track"><div class="progress-fill-know" style="width:${percent}%"></div></div></td></tr>`;
            } else { 
                html += `<tr><td>${lvl}</td><td colspan="3" style="color:#ccc;">Veri Yok</td></tr>`; 
            }
        });
        return html + `</tbody></table></div>`;
    };

    const v = document.getElementById('analyticsView');
    v.innerHTML = `
        <div class="analytics-header"><h2>üìà Performans Merkezi</h2></div>
        ${scoreboardHtml}
        ${weeklyHtml}
        <div class="stats-grid">
            <div class="stat-card" style="border-bottom-color:#e67e22;"><div class="stat-number" style="color:#e67e22">${rComp}/${rTot}</div><div class="stat-label">Okunan Kitap</div></div>
            <div class="stat-card" style="border-bottom-color:#27ae60;"><div class="stat-number" style="color:#27ae60">${qComp}/${qTot}</div><div class="stat-label">Bitirilen Test</div></div>
            <div class="stat-card" style="border-bottom-color:#f1c40f;"><div class="stat-number" style="color:#f1c40f">${gComp}/${gTot}</div><div class="stat-label">Tamamlanan Gramer</div></div>
            <div class="stat-card" style="border-bottom-color:#3498db;"><div class="stat-number" style="color:#3498db">${userKnownVocabulary.length}</div><div class="stat-label">Ezberlenen Kelime</div></div>
        </div>
        ${activitySection}
        <div class="analytics-grid-row" style="margin-top:30px;">
            ${createLevelTable('üìó Kelime Analizi', 'Vocab')}
            ${createLevelTable('üîÆ Deyim Analizi', 'Idioms')}
            ${createLevelTable('üí¨ Kalƒ±p Analizi', 'Phrases')}
        </div>
    `;
}

function toggleAccordion(id) {
    const el = document.getElementById(id);
    if(el.classList.contains('open')) el.classList.remove('open');
    else el.classList.add('open');
}

function toggleScoreRules() {
    const box = document.getElementById('scoreRules');
    if(box.style.display === 'block') box.style.display = 'none';
    else box.style.display = 'block';
}

function speakWord(text) {
    if('speechSynthesis' in window){
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }
}

function toggleFavorite(en, tr) {
    const idx = userFavorites.findIndex(f => f.en === en);
    if(idx > -1) { 
        userFavorites.splice(idx, 1); 
        showToast("Favorilerden √ßƒ±karƒ±ldƒ±");
    } else { 
        userFavorites.push({en, tr}); 
        showToast("Favorilere eklendi"); 
    }
    localStorage.setItem('userFavorites', JSON.stringify(userFavorites));
    if(currentCategory === 'wordmaster' || currentCategory === 'favorites_flashcard' || currentCategory === 'unknowns_flashcard') {
        renderSpread();
    }
}
function isFavorite(en) { return userFavorites.some(f => f.en === en); }

/* 4. HARƒ∞Cƒ∞ OYUNLAR */
function openExternalGame(url, title) {
    document.getElementById('libraryGrid').style.display = 'none'; 
    document.getElementById('libraryHeader').style.display = 'none'; 
    document.getElementById('analyticsView').style.display = 'none'; 
    document.getElementById('openBookView').style.display = 'none';
    
    // Okuma sayacƒ± a√ßƒ±ksa durdur
    stopReadingTimer();

    const view = document.getElementById('externalAppView'); 
    const frame = document.getElementById('appFrame'); 
    const titleEl = document.getElementById('appTitle');
    
    if(titleEl) titleEl.innerText = title; 
    if(frame) frame.src = url; 
    view.style.display = 'flex';
}

function closeExternalApp() {
    // Varsa zamanlayƒ±cƒ±yƒ± garanti durdur
    if(typeof externalTimerInterval !== 'undefined') clearInterval(externalTimerInterval);

    const view = document.getElementById('externalAppView');
    const frame = document.getElementById('appFrame');
    
    if(view) view.style.display = 'none'; 
    if(frame) frame.src = ""; // Iframe'i bo≈üaltarak y√ºk√º azalt
    
    // Ana ekrana d√∂n
    switchCategory('reading'); 
    renderLibrary(); 
}
/* 5. WORD MASTER */
function openWordMasterApp() {
    closeBook();
    currentCategory = 'wordmaster';
    wmState = 'setup';
    wmSessionCount = 0;
    document.getElementById('libraryGrid').style.display='none';
    document.getElementById('libraryHeader').style.display='none';
    document.getElementById('openBookView').style.display='flex';
    document.getElementById('bookHeaderTitle').innerText = "üéÆ Word Master";
    
    ['myNoteTitleDisplay','langToggle','addPageBtn','flashcardBtn','ttsControls','ttsSpeed','liveStats','notebookTools'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display='none';
    });
    
    document.querySelector('.nav-arrow.prev').style.display='none'; 
    document.querySelector('.nav-arrow.next').style.display='none';
    renderSpread();
}

function startWordGame(level) {
    let candidates = [];
    const books = contentData.filter(b => {
        if(b.category !== 'vocabulary') return false;
        if(!b.title.includes(level)) return false;
        if(wmType === 'idioms') return b.title.includes('Idioms');
        else if(wmType === 'phrasals') return b.title.includes('Phrases');
        else return !b.title.includes('Idioms') && !b.title.includes('Phrases');
    });
    books.forEach(b => { candidates = candidates.concat(b.words); });
    
    if(candidates.length === 0) return alert("Bu seviyede kelime bulunamadƒ±!");
    
    if (wmMode === 'learn') {
        gameQueue = candidates.filter(w => !userKnownVocabulary.includes(w.en));
        if(gameQueue.length === 0) return alert("Hepsini biliyorsun! Tekrar modunu dene.");
    } else {
        gameQueue = candidates.filter(w => userKnownVocabulary.includes(w.en));
        if(gameQueue.length === 0) return alert("Hen√ºz bildiƒüin kelime yok.");
    }
    
    gameQueue = gameQueue.sort(() => Math.random() - 0.5); 
    gameIndex = 0;
    wmState = 'playing';
    renderSpread();
}

function handleGameResult(isKnown) {
    wmSessionCount++;
    const w = gameQueue[gameIndex];
    if(isKnown) {
        if(!userKnownVocabulary.includes(w.en)) { 
            userKnownVocabulary.push(w.en); 
            localStorage.setItem('userKnownVocabulary', JSON.stringify(userKnownVocabulary)); 
        }
        const uIdx = userUnknownWords.findIndex(u => u.en === w.en);
        if(uIdx > -1) { 
            userUnknownWords.splice(uIdx, 1); 
            localStorage.setItem('userUnknownWords', JSON.stringify(userUnknownWords)); 
        }
    } else {
        if(!isUnknown(w.en)) { 
            userUnknownWords.push({en: w.en, tr: w.tr}); 
            localStorage.setItem('userUnknownWords', JSON.stringify(userUnknownWords)); 
        }
        const kIdx = userKnownVocabulary.indexOf(w.en);
        if(kIdx > -1) { 
            userKnownVocabulary.splice(kIdx, 1); 
            localStorage.setItem('userKnownVocabulary', JSON.stringify(userKnownVocabulary)); 
            showToast("Unutulanlara eklendi", true);
        }
    }
    trackStat('wordsAdded', 0);
    gameIndex++; 
    if(gameIndex >= gameQueue.length) wmState = 'result';
    renderSpread();
}

function finishWordMasterSession() {
    let score = wmSessionCount;
    wmSessionCount = 0; 
    if (score > 0) {
        logActivity('vocab', 'Word Master', `${score} Kelime`, 0, score * 10);
        showToast(`${score} kelime i≈ülendi!`);
    }
    wmState = 'setup';
    renderSpread();
}

function renderWordMasterGame(pL, pR) {
    if(wmState === 'setup') {
        pL.style.flex = "1"; pL.style.borderRight = "1px solid #f1f2f6"; pL.style.alignItems = "stretch"; pL.style.justifyContent = "flex-start";
        pR.style.display = "flex";
        pL.innerHTML = `
            <div class="wm-setup-title">1. Mod ve T√ºr</div>
            <div class="wm-mode-toggle">
                <div class="wm-mode-opt ${wmMode==='learn'?'active':''}" onclick="setWmMode('learn')">√ñƒüren</div>
                <div class="wm-mode-opt ${wmMode==='review'?'active':''}" onclick="setWmMode('review')">Tekrar Et</div>
            </div>
            <button class="wm-type-btn ${wmType==='vocab'?'selected':''}" onclick="selectWmType('vocab')">üìó Kelime</button>
            <button class="wm-type-btn ${wmType==='idioms'?'selected':''}" onclick="selectWmType('idioms')">üîÆ Deyim</button>
            <button class="wm-type-btn ${wmType==='phrasals'?'selected':''}" onclick="selectWmType('phrasals')">üí¨ Kalƒ±p</button>
        `;
        pR.innerHTML = `
            <div class="wm-setup-title">2. Seviye Se√ß</div>
            <div class="wm-level-grid">
                ${['A1','A2','B1','B2','C1','C2'].map(l => `<button class="wm-level-btn" onclick="startWordGame('${l}')">${l}</button>`).join('')}
            </div>
        `;
    } 
    else if(wmState === 'playing') {
        const w = gameQueue[gameIndex];
        let favClass = isFavorite(w.en) ? 'active' : '';
        pL.style.flex = "2"; pL.style.borderRight = "none"; pL.style.alignItems = "center"; pL.style.justifyContent = "center";
        pR.style.display = "none";
        
        pL.innerHTML = `
            <div style="width:100%; max-width:500px; display:flex; flex-direction:column; align-items:center;">
                <div class="wm-count-display">${wmMode === 'review' ? 'Tekrar' : '√ñƒürenme'} | Kalan: ${gameQueue.length - gameIndex}</div>
                <div class="wm-card-container" onclick="this.classList.toggle('wm-flipped')">
                    <div class="wm-flip-inner">
                        <div class="wm-card-front">
                            <div style="margin-bottom:15px;">${w.en}</div>
                            <div class="card-action-wrapper">
                                <span class="card-tool-btn btn-listen" onmousedown="event.stopPropagation(); speakWord('${w.en}')">üîä</span>
                                <span class="card-tool-btn btn-fav ${favClass}" onmousedown="event.stopPropagation(); toggleFavorite('${w.en}', '${w.tr}')">‚òÖ</span>
                            </div>
                        </div>
                        <div class="wm-card-back">${w.tr}</div>
                    </div>
                </div>
                <div class="wm-controls">
                    <button class="wm-btn wm-btn-unknow" onmousedown="handleGameResult(false)" ontouchstart="handleGameResult(false); event.preventDefault();">‚ùå Bilmiyorum</button>
                    <button class="wm-btn wm-btn-know" onmousedown="handleGameResult(true)" ontouchstart="handleGameResult(true); event.preventDefault();">‚úÖ Biliyorum</button>
                </div>
                <button onclick="finishWordMasterSession()" style="margin-top:20px; border:none; background:none; color:#95a5a6; cursor:pointer;">Bitir ve Kaydet</button>
            </div>
        `;
    }
    else if(wmState === 'result') {
        pL.style.flex = "2"; pL.style.alignItems = "center"; pL.style.justifyContent = "center"; pR.style.display = "none";
        pL.innerHTML = `<div style="text-align:center;"><h1>üéâ Bitti!</h1><button class="wm-btn" style="background:var(--primary);" onclick="finishWordMasterSession()">Men√ºye D√∂n</button></div>`;
    }
}
function selectWmType(type) { wmType = type; renderSpread(); }
function setWmMode(mode) { wmMode = mode; renderSpread(); }

/* 6. READING & PAGINATION (BUG FIX) */
function openBook(i) {
    stopReadingTimer();
    currentQuizTime = 0; 
    activeReadingSeconds = 0;
    
    // Index sƒ±fƒ±rla
    pageIndex = 0; 
    
    if(currentCategory !== 'unknowns') trackStat('booksRead');
    currentBook=i; 
    isTrMode=false; 
    quizAnswers={};
    
    // G√ñR√úN√úRL√úK AYARLARI (√ñnce ekranƒ± a√ß, sonra hesapla)
    document.getElementById('libraryGrid').style.display='none'; 
    document.getElementById('libraryHeader').style.display='none'; 
    document.getElementById('openBookView').style.display='flex'; // √ñNCE BUNU A√áIYORUZ
    document.getElementById('bookHeaderTitle').innerText=i.title;
    
    // Ara√ßlarƒ± gizle/g√∂ster
    const toolIds = ['myNoteTitleDisplay','langToggle','addPageBtn','flashcardBtn','ttsControls','ttsSpeed','liveStats','notebookTools'];
    toolIds.forEach(id => { 
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });

    document.querySelector('.nav-arrow.prev').style.display='flex'; 
    document.querySelector('.nav-arrow.next').style.display='flex';
    
    if(currentCategory==='reading') { 
        document.getElementById('langToggle').style.display='block'; 
        document.getElementById('ttsControls').style.display='flex'; 
        document.getElementById('ttsSpeed').style.display='block';
        document.getElementById('liveStats').style.display='flex'; 
        const cleanText = i.enText ? i.enText.replace(/<[^>]*>/g, '') : "";
        const wCount = document.getElementById('liveWordCount');
        if(wCount) wCount.innerText = cleanText.trim().split(/\s+/).length;
        startReadingTimer(); 
    }
    else if(currentCategory==='grammar') {
        document.getElementById('notebookTools').style.display='flex'; 
        document.getElementById('liveStats').style.display='flex';
        startReadingTimer(); 
    }
    else if(currentCategory==='question') {
        document.getElementById('liveStats').style.display='flex';
        document.querySelector('.nav-arrow.prev').style.display='none'; 
        document.querySelector('.nav-arrow.next').style.display='none';
        startReadingTimer(); 
    }
    else if(currentCategory==='unknowns' || currentCategory==='favorites') {
        const fb = document.getElementById('flashcardBtn');
        if(fb) fb.style.display='block';
    }
    
    // DOM'un render edilmesi i√ßin minik bir gecikme ile sayfalarƒ± olu≈ütur
    setTimeout(() => {
        renderSpread();
    }, 50);
}

function renderSpread() {
    if ('speechSynthesis' in window) speechSynthesis.cancel(); 
    const pL=document.getElementById('pageLeft'); 
    const pR=document.getElementById('pageRight'); 
    pL.innerHTML=""; pR.innerHTML="";
    
    pL.style.flex = "1"; pL.style.borderRight = "1px solid #f1f2f6"; pL.style.alignItems = "stretch"; pL.style.justifyContent = "flex-start";
    pR.style.display = "flex";

    if(currentCategory === 'wordmaster') { renderWordMasterGame(pL, pR); return; }
    if(currentCategory === 'unknowns_flashcard' || currentCategory === 'favorites_flashcard') { renderUnknownFlashcards(pL, pR); return; }
    if(currentCategory==='question'){ 
        pL.style.borderRight = "none"; pL.style.alignItems = "center"; pL.style.justifyContent = "center"; pR.style.display = "none";
        renderQuizSingleMode(pL); return; 
    }
    
    // GRAMMAR
    if(currentCategory==='grammar'){ 
        let completeBtn = !currentBook.completed ? 
            `<button onclick="markAsCompleted()" style="width:100%; margin-top:15px; padding:15px; background:#f1c40f; color:#fff; border:none; border-radius:15px; cursor:pointer; font-weight:bold;">‚úî KONUYU TAMAMLA</button>` : 
            `<div style="margin-top:15px; text-align:center; color:#27ae60; font-weight:bold; border:1px solid #27ae60; padding:5px; border-radius:12px;">‚úî TAMAMLANDI</div>`;
        
        pL.innerHTML=`<div class="content-text">${currentBook.content}</div>${completeBtn}`; 
        pR.innerHTML=`<div class="notebook-wrapper"><textarea id="t" class="notebook-paper" oninput="saveTopicNote(this.value)" placeholder="Notlarƒ±nƒ±z...">${currentBook.userNotes||""}</textarea></div>`; 
        applyStyleToElement(document.getElementById('t'));
        document.querySelector('.nav-arrow.prev').style.visibility='hidden'; 
        document.querySelector('.nav-arrow.next').style.visibility='hidden'; 
        return; 
    }

    // READING
    let pages=[];
    if(currentCategory==='vocabulary') pages=paginateVocab(currentBook.words, false);
    else if(currentCategory==='unknowns' || currentCategory==='favorites') pages=paginateVocab(currentBook.words, true); 
    else if(currentCategory==='reading') { 
        let txt = isTrMode ? (currentBook.trText || "√áeviri yok.") : currentBook.enText; 
        pages = paginateText(txt, true); 
    }

    if(pages.length === 0) pages = ["<p>ƒ∞√ßerik yok.</p>"];
    if(pageIndex >= pages.length) pageIndex = pages.length > 0 ? pages.length - (pages.length % 2 === 0 ? 2 : 1) : 0;
    if(pageIndex < 0) pageIndex = 0;

    pL.innerHTML = pages[pageIndex] || "";
    pR.innerHTML = pages[pageIndex+1] || "";

    // TESTE GE√áƒ∞≈û BUTONU D√úZELTMESƒ∞ (ID KONTROL√ú)
    if(currentCategory === 'reading' && (pageIndex + 2) >= pages.length) {
        let finishBtn = !currentBook.completed ? 
            `<button onclick="markAsCompleted()" style="width:100%; margin-top:20px; padding:15px; background:var(--success); color:white; border:none; border-radius:50px; cursor:pointer; font-weight:bold;">‚úÖ OKUMAYI TAMAMLA</button>` : 
            `<div style="margin-top:20px; text-align:center; color:var(--success); font-weight:bold; border:2px solid var(--success); padding:10px; border-radius:12px;">üéâ OKUMA TAMAMLANDI</div>`;
        
        // ƒ∞sme g√∂re e≈üle≈ütirme (Bo≈üluklarƒ± sil, k√º√ß√ºk harf yap)
        const currentTitleClean = currentBook.title.trim().toLowerCase();
        const linkedQuiz = contentData.find(q => q.category === 'question' && q.title.trim().toLowerCase() === currentTitleClean);
        
        if (linkedQuiz) { 
            let qText = linkedQuiz.completed ? "‚Ü∫ TESTƒ∞ TEKRAR √á√ñZ" : "üß† ƒ∞LGƒ∞Lƒ∞ TESTƒ∞ √á√ñZ"; 
            let qColor = linkedQuiz.completed ? "#7f8c8d" : "#e67e22"; 
            // ID'yi tƒ±rnak i√ßinde g√∂nder
            finishBtn += `<div style="margin-top:15px; padding-top:15px; border-top:1px dashed #ccc;"><p style="text-align:center; color:#555; font-size:0.9em;">ƒ∞lgili test mevcut:</p><button onclick="switchFromReadingToQuiz('${linkedQuiz.id}')" style="width:100%; padding:15px; background:${qColor}; color:white; border:none; border-radius:50px; cursor:pointer; font-weight:bold;">${qText}</button></div>`; 
        }
        
        if(pR.innerHTML.trim() === "") pR.innerHTML = `<div class="single-page" style="justify-content:center;">${finishBtn}</div>`;
        else pR.innerHTML += finishBtn;
    }
    
    updateNav(pages.length);
}

// G√úVENLƒ∞ SAYFALAMA VE DONMA √ñNLEMƒ∞
/* --- G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û SAYFALAMA MOTORU (V35.1) --- */
function paginateText(html, makeInteractive) {
    // 1. ƒ∞√ßeriƒüi Hazƒ±rla
    let tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    // Kelime Etkile≈üimi (Tƒ±klanabilir yapma)
    if (makeInteractive) {
        let paragraphs = tempDiv.querySelectorAll('p, li, h1, h2, h3, h4');
        if(paragraphs.length === 0 && tempDiv.innerText.trim().length > 0) {
             // Eƒüer p tagi yoksa d√ºz metni p i√ßine al
             tempDiv.innerHTML = `<p>${tempDiv.innerHTML}</p>`;
             paragraphs = tempDiv.querySelectorAll('p');
        }
        
        paragraphs.forEach(p => {
            if(!p.innerText.trim()) return;
            // HTML yapƒ±sƒ±nƒ± bozmadan sadece metinleri i≈üle
            p.innerHTML = p.innerText.split(' ').map(w => {
                let cl = w.replace(/[^a-zA-Z0-9'√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]/g, ''); 
                if (cl.length <= 1) return w;
                let m = getWordMeaning(cl);
                let savedClass = isUnknown(cl) ? 'saved' : '';
                // data-meaning null gelirse bo≈ü string yap
                return `<span class="interactive-word ${savedClass}" data-meaning="${m || ''}">${w}</span>`;
            }).join(' ');
            p.style.marginBottom = "15px"; 
            p.style.lineHeight = "1.8";
        });
    }

    // 2. Sayfa Boyutlarƒ±nƒ± Al (Hata √ñnleyici Fallback)
    // Eƒüer sayfa gizliyse geni≈ülik 0 gelir, bunu √∂nlemek i√ßin varsayƒ±lan deƒüerler atƒ±yoruz.
    let pL = document.getElementById('pageLeft');
    let contentWidth = (pL && pL.clientWidth > 50) ? pL.clientWidth : 500; // Varsayƒ±lan 500px
    let maxPageHeight = (window.innerHeight * 0.75) - 60; 
    if(maxPageHeight < 300) maxPageHeight = 500; // √áok k√º√ß√ºk ekran korumasƒ±

    // 3. √ñl√ß√ºm Kutusunu Olu≈ütur
    let measureBox = document.createElement('div');
    measureBox.className = 'single-page';
    measureBox.style.position = 'fixed';
    measureBox.style.visibility = 'hidden';
    measureBox.style.width = contentWidth + "px";
    measureBox.style.padding = "50px 70px"; // CSS ile aynƒ± olmalƒ±
    document.body.appendChild(measureBox);

    let pages = [];
    let currentPageHTML = "";
    let allElements = Array.from(tempDiv.children); 

    // Eƒüer hi√ß child element yoksa (d√ºz metin geldiyse)
    if(allElements.length === 0) {
        document.body.removeChild(measureBox);
        return [`<p>${tempDiv.innerHTML}</p>`]; 
    }

    try {
        allElements.forEach(el => {
            let elHTML = el.outerHTML;
            measureBox.innerHTML = currentPageHTML + elHTML;
            
            // Y√ºkseklik ta≈ütƒ± mƒ±?
            if (measureBox.offsetHeight > maxPageHeight) {
                // Ta≈ütƒ±ysa, mevcut sayfayƒ± kaydet
                if (currentPageHTML !== "") {
                    pages.push(currentPageHTML);
                    currentPageHTML = elHTML; // Yeni sayfaya ta≈üan elementi koy
                    
                    // Eƒüer tek bir element (√∂rn: √ßok uzun bir paragraf) tek ba≈üƒ±na sayfadan b√ºy√ºkse?
                    measureBox.innerHTML = currentPageHTML;
                    if(measureBox.offsetHeight > maxPageHeight) {
                        // Mecburen ekle, CSS scroll edecek
                        pages.push(currentPageHTML);
                        currentPageHTML = "";
                    }
                } else {
                    // Sayfa bo≈üken bile sƒ±ƒümƒ±yorsa (dev element)
                    pages.push(elHTML);
                }
            } else {
                // Ta≈ümadƒ±ysa eklemeye devam et
                currentPageHTML += elHTML;
            }
        });

        if (currentPageHTML !== "") pages.push(currentPageHTML);

    } catch(err) {
        console.error("Pagination Error:", err);
        // Hata olursa t√ºm metni tek sayfada g√∂ster (√á√∂kmemesi i√ßin)
        return [tempDiv.innerHTML];
    } finally {
        if(document.body.contains(measureBox)) document.body.removeChild(measureBox);
    }
    
    return pages.length > 0 ? pages : ["<p>ƒ∞√ßerik y√ºklenemedi veya bo≈ü.</p>"];
}
function updateNav(len) { 
    const pNL = document.getElementById('pageNumL');
    const pNR = document.getElementById('pageNumR');
    if(pNL) pNL.innerText = pageIndex+1; 
    if(pNR) pNR.innerText = pageIndex+2; 
    
    const prev = document.querySelector('.nav-arrow.prev');
    const next = document.querySelector('.nav-arrow.next');
    
    if(prev) prev.style.visibility = (pageIndex<=0) ? 'hidden' : 'visible'; 
    if(next) next.style.visibility = (pageIndex + 2 >= len) ? 'hidden' : 'visible'; 
}

function turnPage(d){ 
    let newIndex = pageIndex + d;
    if(newIndex < 0) newIndex = 0;
    pageIndex = newIndex;

    if(d > 0) { 
        trackStat('pagesTurned'); 
        const today = new Date().toLocaleDateString('tr-TR');
        if(!userStats.dailyActivity) userStats.dailyActivity = {};
        if(!userStats.dailyActivity[today]) userStats.dailyActivity[today] = { pages: 0 };
        userStats.dailyActivity[today].pages += 1;
        localStorage.setItem('userStats', JSON.stringify(userStats));
    }
    renderSpread(); 
}

function toggleLang(){ 
    isTrMode = !isTrMode; 
    renderSpread(); 
}

function switchFromReadingToQuiz(quizId) {
    saveReadingProgress();
    let targetQuiz = contentData.find(x => x.id == quizId);
    
    if(targetQuiz) {
        currentCategory = 'question';
        closeBook(); 
        setTimeout(() => { 
            // Men√º butonunu aktif yap
            document.querySelectorAll('.nav-btn').forEach(b=>{ 
                b.classList.remove('active'); 
                if(b.getAttribute('onclick') && b.getAttribute('onclick').includes('question')) b.classList.add('active'); 
            });
            openBook(targetQuiz); 
        }, 100);
    } else {
        alert("ƒ∞lgili test verisi bulunamadƒ±! (Ba≈ülƒ±klar birebir aynƒ± olmalƒ±)");
    }
}

function markAsCompleted() { 
    if(!currentBook) return; 

    let durationText = activeReadingSeconds > 0 ? ` (${getFormattedTime(activeReadingSeconds)})` : "";
    let pts = 10;
    
    if(currentCategory === 'reading') {
        if(!currentBook.completed) showToast("Reading Tamamlandƒ±: +10 Puan"); 
        trackStat('booksRead');
        logActivity('reading', currentBook.title, 'Okuma Tamamlandƒ±' + durationText, activeReadingSeconds, pts);
    }
    else if(currentCategory === 'grammar') {
        if(!currentBook.completed) showToast("Gramer Tamamlandƒ±: +10 Puan"); 
        logActivity('grammar', currentBook.title, 'Gramer Tamamlandƒ±' + durationText, activeReadingSeconds, pts);
    }

    currentBook.readingDuration = (currentBook.readingDuration || 0) + activeReadingSeconds;
    activeReadingSeconds = 0; 
    currentBook.completed = true;
    
    saveToDB();
    renderSpread(); 
    renderLibrary(); // Ye≈üil tƒ±k i√ßin aray√ºz√º g√ºncelle
}

/* 7. FLASHCARDS & UNKNOWNS */
function startFlashcardMode() { 
    let list = (currentCategory === 'favorites') ? userFavorites : userUnknownWords;
    if(list.length === 0) return alert("Liste bo≈ü!");
    
    currentCategory = (currentCategory === 'favorites') ? 'favorites_flashcard' : 'unknowns_flashcard';
    fcSessionCount = 0;
    fcIndex = 0;
    document.querySelector('.nav-arrow.prev').style.display='none'; 
    document.querySelector('.nav-arrow.next').style.display='none';
    renderSpread();
}

function renderUnknownFlashcards(pL, pR) {
    const isFavMode = currentCategory === 'favorites_flashcard';
    const list = isFavMode ? userFavorites : userUnknownWords;
    if (!list || list.length === 0) {
        switchCategory(isFavMode ? 'favorites' : 'unknowns');
        return;
    }
    if (fcIndex >= list.length) fcIndex = 0;
    const w = list[fcIndex];
    let favClass = isFavorite(w.en) ? 'active' : '';

    pL.style.flex = "2"; pL.style.borderRight = "none"; pL.style.alignItems = "center"; pL.style.justifyContent = "center";
    pR.style.display = "none";
    
    let btnLeftText = isFavMode ? "‚òÖ √áƒ±kar" : "‚úÖ √ñƒürendim (Sil)";
    let hintHtml = w.hint ? `<div class="hint-section" style="margin:5px 0;"><button onclick="event.stopPropagation(); toggleHint()" class="hint-btn">üí° ƒ∞pucu</button><div id="hintText" class="hint-text-box" style="position:absolute;bottom:60px;left:20px;right:20px;z-index:20;background:rgba(0,0,0,0.8);color:#fff;display:none;">${w.hint}</div></div>` : `<div class="hint-section"><button onclick="event.stopPropagation(); addHint()" class="hint-btn">‚ûï ƒ∞pucu Ekle</button></div>`;

    pL.innerHTML = `
        <div style="width:100%; max-width:500px; display:flex; flex-direction:column; align-items:center;">
            <div class="wm-count-display">${isFavMode ? 'Favori' : 'Bilinmeyen'}: ${fcIndex + 1} / ${list.length}</div>
            <div class="wm-card-container" onclick="this.classList.toggle('wm-flipped')">
                <div class="wm-flip-inner">
                    <div class="wm-card-front">
                        <div style="margin-bottom:5px;">${w.en}</div>${hintHtml}
                        <div class="card-action-wrapper">
                            <span class="card-tool-btn btn-listen" onmousedown="event.stopPropagation(); speakWord('${w.en}')">üîä</span>
                            <span class="card-tool-btn btn-fav ${favClass}" onmousedown="event.stopPropagation(); toggleFavorite('${w.en}', '${w.tr}')">‚òÖ</span>
                        </div>
                    </div>
                    <div class="wm-card-back">${w.tr}</div>
                </div>
            </div>
            <div class="wm-controls">
                <button class="wm-btn wm-btn-know" onmousedown="handleUnknownFlashcardResult('delete')" ontouchstart="handleUnknownFlashcardResult('delete'); event.preventDefault();">${btnLeftText}</button>
                <button class="wm-btn" style="background:#95a5a6;" onmousedown="handleUnknownFlashcardResult('next')" ontouchstart="handleUnknownFlashcardResult('next'); event.preventDefault();">‚û°Ô∏è Sƒ±radaki</button>
            </div>
            <button onclick="switchCategory('${isFavMode ? 'favorites' : 'unknowns'}')" style="margin-top:20px; border:none; background:none; color:#95a5a6; cursor:pointer;">Listeye D√∂n</button>
        </div>
    `;
}

function handleUnknownFlashcardResult(action) {
    fcSessionCount++;
    const isFavMode = currentCategory === 'favorites_flashcard';
    const list = isFavMode ? userFavorites : userUnknownWords;
    const storageKey = isFavMode ? 'userFavorites' : 'userUnknownWords';

    if(action === 'delete') {
        const w = list[fcIndex];
        list.splice(fcIndex, 1);
        localStorage.setItem(storageKey, JSON.stringify(list));
        if (!isFavMode) { 
             logActivity('vocab', 'Kelime √ñƒürenildi', w.en, 0, 10); 
             showToast("+10 Puan");
        }
        if(list.length === 0) { alert("Liste bitti."); switchCategory(isFavMode ? 'favorites' : 'unknowns'); return; }
        if(fcIndex >= list.length) fcIndex = 0;
    } else {
        fcIndex++;
        if(fcIndex >= list.length) fcIndex = 0;
    }
    renderSpread();
}

function toggleHint() { const el = document.getElementById('hintText'); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
function addHint() {
    const list = currentCategory === 'favorites_flashcard' ? userFavorites : userUnknownWords;
    const hint = prompt("ƒ∞pucu girin:");
    if(hint) { list[fcIndex].hint = hint; localStorage.setItem(currentCategory === 'favorites_flashcard'?'userFavorites':'userUnknownWords', JSON.stringify(list)); renderSpread(); }
}

/* 8. QUIZ Sƒ∞STEMƒ∞ */
function renderQuizSingleMode(container) {
    let qs = currentBook.questions || [];
    if(pageIndex >= qs.length) { finishQuizSingleMode(container); return; }

    let q = qs[pageIndex];
    let qNum = pageIndex + 1;
    let progress = Math.round((qNum / qs.length) * 100);
    
    let optsHtml = q.options.map(o => {
        let key = o.charAt(0);
        let selected = quizAnswers[qNum] === key ? 'selected' : '';
        return `<div class="quiz-opt ${selected}" onclick="selAnsSingle(${qNum}, '${key}')">${o}</div>`;
    }).join('');

    let isAnswered = quizAnswers[qNum] ? true : false;
    let btnText = (pageIndex === qs.length - 1) ? "Testi Bitir" : "Sonraki Soru";
    
    container.innerHTML = `
        <div class="quiz-centered-container">
            <div class="quiz-question-card">
                <div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:${progress}%"></div></div>
                <div class="quiz-q-text"><span style="color:var(--accent); margin-right:5px;">Soru ${qNum}:</span> ${q.text}</div>
                <div class="quiz-options-area">${optsHtml}</div>
                <button id="qNextBtn" class="quiz-next-btn" onclick="nextQuestionSingle()" ${isAnswered ? '' : 'disabled'}>${btnText} ‚û°Ô∏è</button>
            </div>
        </div>
    `;
}

function selAnsSingle(n, k) { quizAnswers[n] = k; renderSpread(); }
function nextQuestionSingle() { pageIndex++; renderSpread(); }

function finishQuizSingleMode(container) { 
    stopReadingTimer();
    let correct=0, wrong=0; 
    let qs=currentBook.questions; 
    let reviewHtml = "";
    
    qs.forEach((q,i)=>{ 
        let userAnsKey = quizAnswers[i+1];
        let correctAnsText = q.options.find(o => o.startsWith(q.correct)) || q.correct;
        
        if(userAnsKey === q.correct) { 
            correct++; 
            reviewHtml += `<div class="review-item correct"><span>${i+1}. ${q.text}</span><span style="color:green">‚úî Doƒüru</span></div>`; 
        } else { 
            wrong++; 
            reviewHtml += `<div class="review-item wrong"><span>${i+1}. ${q.text}</span><span>‚ùå Yanlƒ±≈ü (Doƒüru: ${correctAnsText})</span></div>`; 
        } 
    });
    
    let score = Math.round((correct/qs.length)*100);
    const earnedPoints = correct * 15; 

    if (!currentBook.completed) {
        currentBook.completed = true;
        trackStat('quizzesTaken');
        logActivity('quiz', currentBook.title, `Quiz: ${correct}D / ${wrong}Y`, currentQuizTime, earnedPoints);
    } else {
        logActivity('quiz', currentBook.title, `Tekrar: ${correct}D / ${wrong}Y`, currentQuizTime, 0);
    }
    
    currentBook.stats = { readingTime: 0, quizTime: currentQuizTime, score: score };
    saveToDB();
    userStats.totalCorrect = (userStats.totalCorrect || 0) + correct; 
    userStats.totalWrong = (userStats.totalWrong || 0) + wrong; 
    localStorage.setItem('userStats', JSON.stringify(userStats));
    
    let color = score >= 70 ? '#27ae60' : (score >= 50 ? '#f39c12' : '#c0392b');
    container.style.justifyContent = "flex-start"; container.style.overflowY = "auto"; 

    container.innerHTML = `
        <div class="quiz-final-wrapper">
            <div class="quiz-sticky-header">
                <div style="display:flex; align-items:center; gap:20px;">
                    <div class="result-circle-score" style="background:${color}; width:60px; height:60px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; font-size:1.2rem; border-radius:50%; border:3px solid white;">%${score}</div>
                    <div><h3 style="margin:0; color:var(--primary);">Test Sonucu</h3><div>‚úÖ ${correct} D | ‚ùå ${wrong} Y</div></div>
                </div>
                <div><button onclick="closeBook()" style="padding:10px 25px; background:var(--primary); color:white; border:none; border-radius:50px; cursor:pointer;">√áIKI≈û ‚ûî</button></div>
            </div>
            <div class="quiz-detail-content">
                <div style="background:#fff; border-radius:20px; border:1px solid #eee; padding:10px;">${reviewHtml}</div>
            </div>
        </div>
    `;
}

/* 9. STANDART FONKSƒ∞YONLAR (S√ñZL√úK, ADMƒ∞N, VB.) */
function paginateVocab(w, isListMode = false){ 
    if(!w)return[]; 
    const itemsPerPage = isListMode ? 13 : 69; 
    let p=[]; 
    for(let i=0;i<w.length;i+=itemsPerPage){
        let c=w.slice(i,i+itemsPerPage); 
        let h = "";
        if(isListMode) {
             h = `<div>`;
             c.forEach(x=> {
                 let favClass = isFavorite(x.en) ? 'active' : '';
                 h+=`<div class="unknown-list-item"><strong>${x.en} <span class="tts-small" onclick="speakWord('${x.en}')">üîä</span> <span class="fav-btn ${favClass}" onclick="toggleFavorite('${x.en}', '${x.tr}')">‚òÖ</span></strong> : ${x.tr}</div>`;
             });
             h += `</div>`;
        } else {
             h=`<div class="vocab-layout">`; 
             c.forEach(x=> {
                 let favClass = isFavorite(x.en) ? 'active' : '';
                 h+=`<div class="vocab-item"><span class="vocab-en">${x.en} <span class="tts-small" onclick="speakWord('${x.en}')">üîä</span> <span class="fav-btn ${favClass}" onclick="toggleFavorite('${x.en}', '${x.tr}')">‚òÖ</span></span><span class="vocab-tr">${x.tr}</span></div>`;
             });
             h+=`</div>`;
        }
        p.push(h);
    } 
    return p; 
}

function switchCategory(cat) {
    currentCategory=cat; currentLevelFolder = null; closeBook();
    document.querySelectorAll('.nav-btn').forEach(b=>{ b.classList.remove('active'); if(b.getAttribute('onclick').includes(cat)) b.classList.add('active'); });
    
    if(cat === 'unknowns') { openBook({ title: "Bilmediƒüim Kelimeler", words: userUnknownWords }); document.getElementById('libraryGrid').style.display='none'; return; }
    if(cat === 'favorites') { openBook({ title: "‚≠ê Favorilerim", words: userFavorites }); document.getElementById('libraryGrid').style.display='none'; return; }
    
    const s=document.getElementById('mainSearch'); s.value="";
    s.placeholder = (cat==='vocabulary') ? "Kelime Ara..." : "K√ºt√ºphanede Ara...";
    
    if(cat==='analytics') openAnalytics(); else renderLibrary();
}

function renderLibrary(q="") {
    // 1. Ekran Temizliƒüi
    document.getElementById('analyticsView').style.display='none'; 
    document.getElementById('libraryHeader').style.display='flex'; 
    document.getElementById('externalAppView').style.display='none';
    const g=document.getElementById('libraryGrid'); 
    g.innerHTML=''; 
    
    // 2. Veri Filtreleme
    let f=contentData.filter(i=>i.category===currentCategory); 
    if(q) f=f.filter(i=>i.title.toLowerCase().includes(q.toLowerCase()));

    // 3. Sƒ±ralama (A1 -> C2)
    if(currentCategory==='reading' || currentCategory==='question' || currentCategory==='vocabulary'){
        const levels = {"A1":1, "A2":2, "B1":3, "B2":4, "C1":5, "C2":6};
        f.sort((a, b) => {
            const getVal = (t) => { let m = t.match(/\b(A1|A2|B1|B2|C1|C2)\b/i); return m ? levels[m[0].toUpperCase()] : 99; };
            let valA = getVal(a.title); let valB = getVal(b.title);
            if(valA !== valB) return valA - valB; 
            return a.title.localeCompare(b.title, 'tr', {numeric:true});
        });
    }

    // --- G√ñR√úNT√úLEME SENARYOLARI ---
    
    // SENARYO 1: ANA KATEGORƒ∞ G√ñR√úN√úM√ú (Hen√ºz klas√∂r se√ßilmemi≈ü)
    if((currentCategory === 'reading' || currentCategory === 'question' || currentCategory === 'vocabulary') && !q && currentLevelFolder === null) {
        g.className='library-grid'; g.style.display='grid'; // Standart Grid
        
        // Klas√∂rleri Listele
        ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].forEach(lvl => {
            const count = f.filter(i => new RegExp(`\\b${lvl}\\b`, 'i').test(i.title)).length;
            if(count > 0) {
                const folder = document.createElement('div'); folder.className = 'book-card folder-card';
                folder.innerHTML = `<div class="folder-icon">üìÇ</div><div class="folder-info"><div class="book-title">${lvl} Seviyesi</div><div class="folder-count">${count} √ñge</div></div>`;
                folder.onclick = () => { currentLevelFolder = lvl; renderLibrary(); };
                g.appendChild(folder);
            }
        });
        // Klas√∂rs√ºz √∂ƒüeler
        f.forEach(i => { if(!/\b(A1|A2|B1|B2|C1|C2)\b/i.test(i.title)) renderBookCard(i, g); });

    } 
    // SENARYO 2: √ñZEL DASHBOARD G√ñR√úN√úM√ú (Bir seviye klas√∂r√ºne girilmi≈ü)
    else if (currentLevelFolder !== null && !q) {
        g.className = ''; g.style.display = 'block'; // Grid'i kapat
        
        let levelItems = f.filter(i => new RegExp(`\\b${currentLevelFolder}\\b`, 'i').test(i.title));
        
        // ƒ∞statistikler
        let total = levelItems.length;
        let completed = levelItems.filter(i => i.completed).length;
        let percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        // Sƒ±radaki G√∂rev
        let nextTask = levelItems.find(i => !i.completed);
        
        // Orta Kart Metinleri
        let centerTitle = nextTask ? nextTask.title : "üéâ Harika!";
        let centerLabel = nextTask ? "SIRADAKƒ∞ G√ñREV" : "SEVƒ∞YE TAMAMLANDI";
        let centerAction = nextTask ? "BA≈ûLA üöÄ" : "Lƒ∞STEYE G√ñZ AT ‚Ü∫";
        let clickAction = nextTask ? `openBook(contentData.find(x=>x.id=='${nextTask.id}'))` : `openDashList('all')`;

        // DASHBOARD HTML (Senin Tasarƒ±mƒ±n)
        g.innerHTML = `
            <div style="padding:20px; margin-bottom:10px;">
                <button onclick="currentLevelFolder=null; renderLibrary()" class="back-btn">‚¨Ö Seviye Listesine D√∂n</button>
            </div>
            
            <div class="dash-wrapper">
                <div class="dash-stat-box" onclick="openDashList('all')">
                    <div class="dash-stat-title">Toplam Konu</div>
                    <div class="dash-stat-value">${total}</div>
                    <div class="dash-stat-sub">Listeyi G√∂r ‚ò∞</div>
                </div>

                <div class="dash-center-card" onclick="${clickAction}">
                    <div class="dash-center-label">${centerLabel}</div>
                    <div class="dash-center-title">${centerTitle}</div>
                    <div class="dash-center-action">${centerAction}</div>
                </div>

                <div class="dash-stat-box" onclick="openDashList('completed')">
                    <div class="dash-stat-title">Tamamlanan</div>
                    <div class="dash-stat-value">${completed}</div>
                    <div class="dash-stat-sub">%${percent} Tamamlandƒ±</div>
                </div>
            </div>
        `;
        window.tempLevelItems = levelItems; // Listeyi sakla
    } 
    // SENARYO 3: STANDART Lƒ∞STELEME (Arama vb.)
    else {
        g.className='library-grid'; g.style.display='grid';
        f.forEach(i => renderBookCard(i, g)); 
    }

    // Butonlar
    if(currentCategory==='question' && currentLevelFolder === null){ 
        const n=document.createElement('div'); n.className='book-card new-item-card'; n.innerHTML='<div>+ TEST EKLE</div>'; n.onclick=()=>document.getElementById('quickQuizModal').style.display='flex'; g.appendChild(n); 
    }
    if(currentCategory==='notes'){ 
        const n=document.createElement('div'); n.className='book-card new-item-card'; n.innerHTML='<div>+ NOT EKLE</div>'; n.onclick=createNewNote; g.appendChild(n); 
    }
}

// Lƒ∞STE A√áMA FONKSƒ∞YONU
function openDashList(type) {
    const modal = document.getElementById('dashListModal');
    const title = document.getElementById('dashListTitle');
    const body = document.getElementById('dashListBody');
    const items = window.tempLevelItems || [];
    
    body.innerHTML = ""; 
    modal.style.display = 'flex'; 

    if (type === 'all') {
        title.innerText = "üìã T√ºm Konular";
        items.forEach(i => {
            let status = i.completed ? '<span style="color:green; font-weight:bold;">‚úî</span>' : '<span style="color:#ccc;">‚≠ï</span>';
            let rowClass = i.completed ? 'dash-list-item done' : 'dash-list-item';
            body.innerHTML += `
                <div class="${rowClass}" onclick="document.getElementById('dashListModal').style.display='none'; openBook(contentData.find(x=>x.id=='${i.id}'))">
                    <div style="display:flex; gap:10px; align-items:center;">${status} <span>${i.title}</span></div>
                    <span style="color:#ccc;">‚ûî</span>
                </div>`;
        });
    } else {
        title.innerText = "‚úÖ Tamamlananlar";
        let doneItems = items.filter(i => i.completed);
        if(doneItems.length === 0) {
            body.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Hen√ºz tamamlanan konu yok.</div>";
        }
        doneItems.forEach(i => {
            body.innerHTML += `
                <div class="dash-list-item" onclick="document.getElementById('dashListModal').style.display='none'; openBook(contentData.find(x=>x.id=='${i.id}'))">
                    <span style="color:green">‚úî ${i.title}</span> 
                    <span>‚ûî</span>
                </div>`;
        });
    }
}

// Lƒ∞STE A√áMA FONKSƒ∞YONU
function openDashList(type) {
    const modal = document.getElementById('dashListModal');
    const title = document.getElementById('dashListTitle');
    const body = document.getElementById('dashListBody');
    const items = window.tempLevelItems || [];
    
    body.innerHTML = ""; 
    modal.style.display = 'flex'; 

    if (type === 'all') {
        title.innerText = "üìã T√ºm Konular";
        items.forEach(i => {
            let status = i.completed ? '<span style="color:green; font-weight:bold;">‚úî</span>' : '<span style="color:#ccc;">‚≠ï</span>';
            let rowClass = i.completed ? 'dash-list-item done' : 'dash-list-item';
            body.innerHTML += `
                <div class="${rowClass}" onclick="document.getElementById('dashListModal').style.display='none'; openBook(contentData.find(x=>x.id=='${i.id}'))">
                    <div style="display:flex; gap:10px; align-items:center;">${status} <span>${i.title}</span></div>
                    <span style="color:#ccc;">‚ûî</span>
                </div>`;
        });
    } else {
        title.innerText = "‚úÖ Tamamlananlar";
        let doneItems = items.filter(i => i.completed);
        if(doneItems.length === 0) {
            body.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Hen√ºz tamamlanan konu yok.</div>";
        }
        doneItems.forEach(i => {
            body.innerHTML += `
                <div class="dash-list-item" onclick="document.getElementById('dashListModal').style.display='none'; openBook(contentData.find(x=>x.id=='${i.id}'))">
                    <span style="color:green">‚úî ${i.title}</span> 
                    <span>‚ûî</span>
                </div>`;
        });
    }
}

// YENƒ∞ YARDIMCI FONKSƒ∞YON: Zincirleme G√∂r√ºnt√ºleme
function renderProgressiveList(items, container) {
    let chainBroken = false;
    items.forEach((item, index) => {
        // Eƒüer zincir koptuysa (√∂nceki tamamlanmadƒ±ysa) sonrakileri √ßizme
        if (chainBroken) return;

        renderBookCard(item, container);

        // Eƒüer bu kitap tamamlanmamƒ±≈üsa, zinciri burada kes (bir sonraki d√∂ng√ºde √ßizim yapƒ±lmayacak)
        // B√∂ylece kullanƒ±cƒ± sadece "Tamamladƒ±klarƒ±nƒ±" + "Sƒ±radaki Tek G√∂revini" g√∂r√ºr.
        if (!item.completed) {
            chainBroken = true;
        }
    });
}

function renderBookCard(i, container) {
    const d=document.createElement('div'); d.className='book-card';
    if(i.completed) d.classList.add('completed');
    
    let color = "#2c3e50";
    if(currentCategory==='grammar') color="#f1c40f";
    else if(currentCategory==='vocabulary') color = i.title.includes('Idioms') ? "#9b59b6" : (i.title.includes('Phrases') ? "#17a2b8" : "#e74c3c");
    else if(currentCategory==='question' && !i.completed) color="#27ae60";
    else if(currentCategory==='notes') color="#8e44ad";
    
    d.style.borderLeftColor = color;
    d.innerHTML=`<div class="book-title">${i.title}</div><button class="delete-btn" onclick="deleteItem(event,'${i.id}')">&times;</button>`;
    d.onclick=()=>openBook(i); 
    container.appendChild(d);
}

function saveReadingProgress() { 
    if(currentBook && currentCategory === 'reading') { 
        currentBook.readingDuration = (currentBook.readingDuration || 0) + activeReadingSeconds; 
        activeReadingSeconds = 0; 
        saveToDB(); 
    }
}
function saveToDB(){ 
    let i = contentData.findIndex(x => x.id == currentBook.id); 
    if(i !== -1) {
        contentData[i] = currentBook; 
        localStorage.setItem('englishWorkbookData', JSON.stringify(contentData)); 
    }
}
function closeBook() { 
    if ('speechSynthesis' in window) speechSynthesis.cancel();
    stopDictation(); 
    saveReadingProgress(); 
    stopReadingTimer(); 
    
    if(currentCategory === 'wordmaster' && wmSessionCount > 0) {
        logActivity('vocab', 'Word Master', `${wmSessionCount} Kelime √áalƒ±≈üƒ±ldƒ±`);
        wmSessionCount = 0;
    }
    if((currentCategory === 'unknowns_flashcard' || currentCategory === 'favorites_flashcard') && fcSessionCount > 0) {
        logActivity('vocab', 'Flashcard Session', `${fcSessionCount} Kelime √áalƒ±≈üƒ±ldƒ±`);
        fcSessionCount = 0;
    }

    document.getElementById('openBookView').style.display='none'; 
    document.getElementById('libraryGrid').style.display='grid'; 
    document.getElementById('libraryHeader').style.display='flex'; 
    document.getElementById('mainSearch').value=""; 
    if(currentCategory !== 'unknowns') renderLibrary(); 
}
function saveQuickQuiz() {
    let raw=document.getElementById('quickQuizInput').value; if(!raw.trim())return alert("Veri?"); let tm=raw.match(/Ba≈ülƒ±k:\s*(.*)/i); let t=tm?tm[1].trim():"Test "+Date.now(); let cl=raw.replace(/###SORULAR###/g,'').replace(/Ba≈ülƒ±k:.*\n?/g,''); let qb=cl.split(/Q\d+:/).slice(1); let qs=[]; qb.forEach(b=>{ let l=b.trim().split('\n'); let qt=l[0].trim(); let op=[]; let cor="A"; l.forEach(x=>{x=x.trim(); if(/^[A-D]\)/.test(x))op.push(x); if(x.toLowerCase().startsWith('correct:'))cor=x.split(':')[1].trim().toUpperCase();}); if(qt)qs.push({text:qt,options:op,correct:cor}); }); if(!qs.length)return alert("Hata!");
    contentData.push({id:Date.now().toString(), category:'question', title:t, questions:qs, completed: false}); localStorage.setItem('englishWorkbookData', JSON.stringify(contentData)); document.getElementById('quickQuizModal').style.display='none'; document.getElementById('quickQuizInput').value=""; showToast("Test eklendi!"); if(currentCategory==='question') renderLibrary();
}
function stopReadingTimer() { clearInterval(readingTimerInterval); }
function startReadingTimer() {
    clearInterval(readingTimerInterval);
    if(!isTogglingContext) { activeReadingSeconds = 0; currentQuizTime = 0; }
    isTogglingContext = false;
    document.getElementById('liveTimer').innerText = "00:00";
    readingTimerInterval = setInterval(() => {
        if(currentCategory === 'reading' || currentCategory === 'grammar') {
            activeReadingSeconds++;
            updateTimerDisplay(activeReadingSeconds + (currentCategory==='reading' ? (currentBook.readingDuration || 0) : 0)); 
        } else if(currentCategory === 'question') {
            currentQuizTime++;
            updateTimerDisplay(currentQuizTime);
        }
    }, 1000);
}
function updateTimerDisplay(totalSeconds) {
    const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
    const secs = (totalSeconds % 60).toString().padStart(2, '0');
    document.getElementById('liveTimer').innerText = `${mins}:${secs}`;
}
function handleQuickDict(e) {
    if(e.key === 'Enter') {
        let val = document.getElementById('quickDic').value.trim().toLowerCase(); if(!val) return;
        let meaning = getWordMeaning(val);
        if(meaning) alert(`üìñ ${val.toUpperCase()}:\n${meaning}`); 
        else if(confirm(`"${val}" s√∂zl√ºkte yok. Eklemek ister misin?`)) { 
            let def = prompt("Anlamƒ±:"); if(def) toggleUnknown(document.createElement('div'), val, def); 
        }
        document.getElementById('quickDic').value = "";
    }
}
function buildGlobalDictionary() { globalLexicon={}; contentData.filter(i=>i.category==='vocabulary').forEach(b=>{b.words.forEach(w=>globalLexicon[w.en.trim().toLowerCase()]=w.tr);}); }
function getWordMeaning(raw) {
    let w = raw.toLowerCase().replace(/[^a-z]/g,''); if(!w)return null; if(globalLexicon[w])return globalLexicon[w];
    const sfx=["ing","ies","es","ed","ly","er","est","s","d"];
    for(let s of sfx) { if(w.endsWith(s)){ let stem=w.slice(0,-s.length); if(globalLexicon[stem])return globalLexicon[stem]; } } return null;
}
function toggleUnknown(el, word, meaning) {
    if(meaning === 'null' || !meaning) { let userDef = prompt(`"${word}" anlamƒ±?`); if(userDef) meaning = userDef; else return; }
    const index = userUnknownWords.findIndex(u => u.en === word);
    if(index > -1) { 
        userUnknownWords.splice(index, 1); 
        if(el.classList) el.classList.remove('saved'); 
        showToast("√áƒ±karƒ±ldƒ±."); 
    }
    else { 
        userUnknownWords.push({en: word, tr: meaning}); 
        if(el.classList) el.classList.add('saved'); 
        showToast("Eklendi."); 
    }
    localStorage.setItem('userUnknownWords', JSON.stringify(userUnknownWords));
}
function isUnknown(word) { return userUnknownWords.some(u => u.en.toLowerCase() === word.toLowerCase()); }
function closeAdmin(){document.getElementById('adminModal').style.display='none';}
function saveData() {
    let c=document.getElementById('inputCategory').value; 
    let r=document.getElementById('bulkInput').value; 
    if(!r.trim()) return alert("Veri?");
    
    if(c === 'reading' && r.includes('###SORULAR###')) {
        let parts = r.split('###SORULAR###');
        let lines = parts[0].trim().split('\n');
        let title = lines[0].trim();
        let body = lines.slice(1).join('\n');
        contentData.push({ id: Date.now().toString(), category: 'reading', title: title, enText: body, trText: "", completed: false });
        
        let qb=parts[1].trim().split(/Q\d+:/).slice(1); 
        let qs=[]; 
        qb.forEach(b=>{ let l=b.trim().split('\n'); let qt=l[0].trim(); let op=[]; let cor="A"; l.forEach(x=>{x=x.trim(); if(/^[A-D]\)/.test(x))op.push(x); if(x.toLowerCase().startsWith('correct:'))cor=x.split(':')[1].trim().toUpperCase();}); if(qt)qs.push({text:qt,options:op,correct:cor}); });
        
        contentData.push({id: (Date.now()+1).toString(), category:'question', title: title, questions: qs, completed: false});
        showToast("Reading + Quiz Eklendi");
    } else if(c==='grammar'){ 
        let l=r.split('\n'); let ti=null, co=""; 
        const fg=()=>{ if(ti){ if(!contentData.some(x => x.category === 'grammar' && x.title === ti)) { contentData.push({id:Date.now()+Math.random(), category:'grammar', title:ti, content:co}); } } }; 
        l.forEach(x=>{ let cx=x.trim(); if(/^\d+\./.test(cx)){fg(); ti=cx; co=`<h3>${cx}</h3>`;} else if(cx){ if(/^(Gramer|√ñrnek)/.test(cx))co+=`<span class="highlight-header">${cx}</span>`; else if(cx.startsWith('¬∑'))co+=`<li>${cx.replace('¬∑','')}</li>`; else co+=`<p>${cx}</p>`; } }); fg(); showToast("Gramer eklendi!"); 
    } else {
         contentData.push({id:Date.now().toString(), category:c, title:"Yeni ƒ∞√ßerik", content:r});
         showToast("ƒ∞√ßerik Eklendi");
    }
    localStorage.setItem('englishWorkbookData', JSON.stringify(contentData)); 
    closeAdmin(); renderLibrary();
}
function removeDuplicates() {
    if(!confirm("Yinelenen i√ßerikler temizlensin mi?")) return;
    const unique = []; const map = new Map();
    contentData.forEach(item => { if(!map.has(item.id)){ map.set(item.id, true); unique.push(item); }});
    contentData = unique;
    localStorage.setItem('englishWorkbookData', JSON.stringify(contentData));
    showToast("Temizlendi!"); setTimeout(() => location.reload(), 1000);
}

function clearGameLogs() {
    if(!confirm("Ge√ßmi≈üteki t√ºm 'External Game' (Oyun) puanlarƒ± ve kayƒ±tlarƒ± silinsin mi?\n\nBu i≈ülem toplam puanƒ±nƒ± d√º≈ü√ºrecektir.")) return;
    
    // Sadece external_game olmayanlarƒ± tut, diƒüerlerini filtrele
    userActivityLog = userActivityLog.filter(log => log.type !== 'external_game');
    localStorage.setItem('userActivityLog', JSON.stringify(userActivityLog));
    
    showToast("Oyun ge√ßmi≈üi ve puanlarƒ± silindi!");
    setTimeout(() => location.reload(), 1000);
}function createNewNote() { contentData.push({id:Date.now().toString(),category:'notes',title:'Yeni Not',pages:["",""], styles:[]}); localStorage.setItem('englishWorkbookData',JSON.stringify(contentData)); openBook(contentData[contentData.length-1]); }
function deleteItem(e,id){ e.stopPropagation(); if(confirm("Sil?")){contentData=contentData.filter(x=>x.id!==id); localStorage.setItem('englishWorkbookData',JSON.stringify(contentData)); renderLibrary();} }
function setupVoice() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR(); recognition.interimResults=false; recognition.continuous=false;
        recognition.onresult = function(e) { const t=e.results[0][0].transcript; const el=document.getElementById(currentTargetId); if(el){el.value+=(el.value.length>0?" ":"")+t; el.dispatchEvent(new Event('input'));} stopDictation(); };
        recognition.onend = function(){stopDictation();};
    }
}
function toggleDictation(id, lang) { if(!recognition)return alert("Desteklenmiyor"); const btn=document.getElementById(`mic-${lang}-${id}`); if(isListening)stopDictation(); else { currentTargetId=id; recognition.lang=(lang==='tr')?'tr-TR':'en-US'; recognition.start(); isListening=true; if(btn)btn.classList.add('listening'); } }
function stopDictation(){ if(isListening&&recognition){recognition.stop(); isListening=false; document.querySelectorAll('.mic-btn').forEach(b=>b.classList.remove('listening'));} }
function addPageToNote(){ currentBook.pages.push("",""); saveToDB(); pageIndex=currentBook.pages.length-2; renderSpread(); }
function saveTopicNote(v){ if(currentBook){currentBook.userNotes=v; trackStat('notesTaken'); saveToDB();} }
function saveMyPage(idx,val){ currentBook.pages[idx]=val; saveToDB(); }
function saveNoteTitle(val){ currentBook.title=val; saveToDB(); }
function clearCategoryData(){ if(confirm("Sil?")){contentData=contentData.filter(i=>i.category!==document.getElementById('inputCategory').value); localStorage.setItem('englishWorkbookData',JSON.stringify(contentData)); switchCategory(currentCategory);} }
function exportData() {
    const data = { 
        data: localStorage.getItem('englishWorkbookData'), 
        stats: localStorage.getItem('userStats'), 
        notes: localStorage.getItem('myGeneralNotes'), 
        unknowns: localStorage.getItem('userUnknownWords'), 
        knowns: localStorage.getItem('userKnownVocabulary'), 
        favorites: localStorage.getItem('userFavorites'),
        grammarStats: localStorage.getItem('grammarGameStats'), 
        phraseStats: localStorage.getItem('phraseMasterStats'),
        activityLog: localStorage.getItem('userActivityLog')
    };
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'english_pro_system_full_backup.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); showToast("Yedeklendi!");
}
function importData(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try { const json = JSON.parse(e.target.result);
            if(json.data) localStorage.setItem('englishWorkbookData', json.data);
            if(json.stats) localStorage.setItem('userStats', json.stats);
            if(json.notes) localStorage.setItem('myGeneralNotes', json.notes);
            if(json.unknowns) localStorage.setItem('userUnknownWords', json.unknowns);
            if(json.knowns) localStorage.setItem('userKnownVocabulary', json.knowns);
            if(json.favorites) localStorage.setItem('userFavorites', json.favorites);
            if(json.grammarStats) localStorage.setItem('grammarGameStats', json.grammarStats);
            if(json.phraseStats) localStorage.setItem('phraseMasterStats', json.phraseStats);
            if(json.activityLog) localStorage.setItem('userActivityLog', json.activityLog);
            showToast("Y√ºklendi!"); setTimeout(() => location.reload(), 1500);
        } catch(err) { showToast("Hata!", true); }
    }; reader.readAsText(file);
}
function resetProgress() {
    if(!confirm("‚ö†Ô∏è Dƒ∞KKAT! T√ºm ilerleme SIFIRLANACAK.\n\nEmin misin?")) return;
    userStats = { booksRead:0, pagesTurned:0, quizzesTaken:0, wordsAdded:0, notesTaken:0, totalCorrect:0, totalWrong:0 };
    localStorage.setItem('userStats', JSON.stringify(userStats));
    userUnknownWords = []; userKnownVocabulary = []; userFavorites = []; userActivityLog = [];
    localStorage.setItem('userUnknownWords', JSON.stringify([]));
    localStorage.setItem('userKnownVocabulary', JSON.stringify([]));
    localStorage.setItem('userFavorites', JSON.stringify([]));
    localStorage.setItem('userActivityLog', JSON.stringify([]));
    contentData.forEach(book => { book.completed = false; if(book.stats) delete book.stats; });
    localStorage.setItem('englishWorkbookData', JSON.stringify(contentData));
    showToast("T√ºm ilerleme sƒ±fƒ±rlandƒ±!"); setTimeout(() => location.reload(), 1500);
}
function applyGlobalStyle(type, val) {
    if(type === 'color') currentPenStyle.color = val;
    if(type === 'size') currentPenStyle.size = val;
    const pages = document.querySelectorAll('.notebook-paper');
    pages.forEach(p => {
        if(type === 'color') p.style.color = val;
        if(type === 'size') {
            p.style.fontSize = val + 'px';
            const lh = val * 1.5;
            p.style.lineHeight = lh + 'px';
            p.style.backgroundSize = `100% ${lh}px`;
        }
    });
}
function applyStyleToElement(el) {
    el.style.color = currentPenStyle.color;
    el.style.fontSize = currentPenStyle.size + 'px';
    const lh = currentPenStyle.size * 1.5;
    el.style.lineHeight = lh + 'px';
    el.style.backgroundSize = `100% ${lh}px`;
}
function handleTTS(action) {
    if (!('speechSynthesis' in window)) return alert("Tarayƒ±cƒ±nƒ±z seslendirmeyi desteklemiyor.");
    
    const pauseBtn = document.getElementById('ttsPauseBtn');

    // 1. RESTART
    if (action === 'restart') {
        speechSynthesis.cancel();
        
        let txt = document.getElementById('pageLeft').innerText + " " + document.getElementById('pageRight').innerText;
        txt = txt.replace("‚úî KONUYU TAMAMLA", "").replace("‚úÖ OKUMAYI TAMAMLA", "").replace("üîÑ Tekrar Okudum (+1)", "").replace("üß† ƒ∞LGƒ∞Lƒ∞ TESTƒ∞ √á√ñZ", "").replace("‚Ü∫ ƒ∞LGƒ∞Lƒ∞ TESTƒ∞ TEKRAR √á√ñZ", "");
        
        ttsObj = new SpeechSynthesisUtterance(txt);
        ttsObj.lang = isTrMode ? 'tr-TR' : 'en-US';
        ttsObj.rate = parseFloat(document.getElementById('ttsSpeed').value) || 0.9;
        
        ttsObj.onend = function() {
            if(pauseBtn) {
                pauseBtn.innerHTML = "‚è∏";
                pauseBtn.classList.remove('paused');
            }
        };

        speechSynthesis.speak(ttsObj);
        
        if(pauseBtn) {
            pauseBtn.innerHTML = "‚è∏";
            pauseBtn.classList.remove('paused');
        }
    } 
    // 2. PAUSE / RESUME
    else if (action === 'pause') {
        if (speechSynthesis.paused) {
            speechSynthesis.resume();
            pauseBtn.innerHTML = "‚è∏";
            pauseBtn.classList.remove('paused');
        } else if (speechSynthesis.speaking) {
            speechSynthesis.pause();
            pauseBtn.innerHTML = "‚ñ∂";
            pauseBtn.classList.add('paused');
        } else {
            handleTTS('restart');
        }
    }
}
function getFormattedTime(seconds) { const m = Math.floor(seconds / 60); const s = Math.round(seconds % 60); return `${m}dk ${s}sn`; }
/* --- EKSƒ∞K FONKSƒ∞YON D√úZELTMESƒ∞ (ADMIN) --- */
function openAdmin() {
    document.getElementById('adminModal').style.display = 'flex';
    document.getElementById('bulkInput').value = ""; // Temiz a√ß
}
</script>
</body>
</html>